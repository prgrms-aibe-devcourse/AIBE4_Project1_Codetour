<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>K-ì½˜í…ì¸  ì§€ë„</title>
    <style>
      body {
        font-family: sans-serif;
        margin: 0;
        padding: 20px;
      }
      .container {
        display: flex;
        gap: 20px;
      }
      .left-panel {
        flex: 1;
        max-width: 400px;
      }
      .map-container {
        flex: 2;
      }
      #map {
        width: 100%;
        height: 600px;
        border: 1px solid #ddd;
      }
      input,
      button,
      select {
        padding: 8px;
        margin: 5px;
      }
      .section {
        background: #f9f9f9;
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 5px;
      }
      .section h3 {
        margin-top: 0;
      }
      #courseList {
        list-style: none;
        padding: 0;
        min-height: 100px;
        background: white;
        border: 1px solid #ddd;
        border-radius: 5px;
      }
      #courseList li {
        padding: 10px;
        margin: 5px;
        background: #e3f2fd;
        border-radius: 3px;
        cursor: move;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      #courseList li.dragging {
        opacity: 0.5;
      }
      .remove-btn {
        background: #f44336;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 3px;
        cursor: pointer;
      }
      #savedCourses {
        max-height: 300px;
        overflow-y: auto;
      }
      .saved-course {
        background: white;
        padding: 10px;
        margin: 5px 0;
        border-radius: 5px;
        cursor: pointer;
        border: 1px solid #ddd;
      }
      .saved-course:hover {
        background: #f0f0f0;
      }
      .route-info {
        background: white;
        padding: 10px;
        margin-top: 10px;
        border-radius: 5px;
        border: 1px solid #4caf50;
      }
    </style>
  </head>
  <body>
    <h1>K-ì½˜í…ì¸  ì§€ë„</h1>

    <div class="container">
      <div class="left-panel">
        <!-- ì¥ì†Œ ê²€ìƒ‰ -->
        <div class="section">
          <h3>ğŸ” ì¥ì†Œ ê²€ìƒ‰</h3>
          <input
            type="text"
            id="searchInput"
            placeholder="ì¥ì†Œ ê²€ìƒ‰"
            style="width: 80%"
          />
          <button id="searchBtn">ê²€ìƒ‰</button>
        </div>

        <!-- í˜„ì¬ ì½”ìŠ¤ -->
        <div class="section">
          <h3>ğŸ“ ë‚´ ì½”ìŠ¤ (ë“œë˜ê·¸ë¡œ ìˆœì„œ ë³€ê²½)</h3>
          <ul id="courseList"></ul>
          <button
            id="saveBtn"
            style="
              width: 100%;
              background: #4caf50;
              color: white;
              border: none;
              padding: 10px;
            "
          >
            ì½”ìŠ¤ ì €ì¥
          </button>
          <button
            id="showRouteBtn"
            style="
              width: 100%;
              background: #2196f3;
              color: white;
              border: none;
              padding: 10px;
              margin-top: 5px;
            "
          >
            ê²½ë¡œ ë³´ê¸°
          </button>
          <div id="routeInfo"></div>
        </div>

        <!-- ì €ì¥ëœ ì½”ìŠ¤ -->
        <div class="section">
          <h3>ğŸ’¾ ì €ì¥ëœ ì½”ìŠ¤</h3>
          <select id="userSelect">
            <option value="1">ì‚¬ìš©ì 1</option>
            <option value="2">ì‚¬ìš©ì 2</option>
            <option value="3">ì‚¬ìš©ì 3</option>
          </select>
          <button id="loadCoursesBtn">ë¶ˆëŸ¬ì˜¤ê¸°</button>
          <div id="savedCourses"></div>
        </div>
      </div>

      <div class="map-container">
        <div id="map"></div>
      </div>
    </div>

    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=8d27848d8e0061837441313b57eba277&libraries=services&autoload=false"></script>

    <script>
      kakao.maps.load(function () {
        var map = new kakao.maps.Map(document.getElementById("map"), {
          center: new kakao.maps.LatLng(37.5665, 126.978),
          level: 5,
        });

        let markers = [];
        let myCourse = [];
        let routePolyline = null;
        let currentInfoWindow = null; // í˜„ì¬ ì—´ë¦° InfoWindow ì¶”ì 

        // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ê¸°ëŠ¥
        const courseList = document.getElementById("courseList");
        let draggedElement = null;

        courseList.addEventListener("dragstart", (e) => {
          draggedElement = e.target;
          e.target.classList.add("dragging");
        });

        courseList.addEventListener("dragend", (e) => {
          e.target.classList.remove("dragging");
        });

        courseList.addEventListener("dragover", (e) => {
          e.preventDefault();
          const afterElement = getDragAfterElement(courseList, e.clientY);
          const dragging = document.querySelector(".dragging");
          if (afterElement == null) {
            courseList.appendChild(dragging);
          } else {
            courseList.insertBefore(dragging, afterElement);
          }
        });

        courseList.addEventListener("drop", (e) => {
          e.preventDefault();
          updateCourseOrder();
        });

        function getDragAfterElement(container, y) {
          const draggableElements = [
            ...container.querySelectorAll("li:not(.dragging)"),
          ];
          return draggableElements.reduce(
            (closest, child) => {
              const box = child.getBoundingClientRect();
              const offset = y - box.top - box.height / 2;
              if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
              } else {
                return closest;
              }
            },
            { offset: Number.NEGATIVE_INFINITY }
          ).element;
        }

        function updateCourseOrder() {
          const listItems = courseList.querySelectorAll("li");
          const newOrder = [];
          listItems.forEach((item, index) => {
            const courseIndex = parseInt(item.dataset.index);
            newOrder.push(myCourse[courseIndex]);
          });
          myCourse = newOrder;
          renderCourseList();
        }

        function renderCourseList() {
          courseList.innerHTML = "";
          myCourse.forEach((place, index) => {
            const li = document.createElement("li");
            li.draggable = true;
            li.dataset.index = index;
            li.innerHTML = `
              <span>${index + 1}. ${place.name}</span>
              <button class="remove-btn" onclick="removeCourse(${index})">ì‚­ì œ</button>
            `;
            courseList.appendChild(li);
          });
        }

        window.removeCourse = function (index) {
          myCourse.splice(index, 1);
          renderCourseList();
        };

        window.addToCourse = function (name, lat, lng) {
          myCourse.push({ name, lat, lng });
          renderCourseList();

          // InfoWindow ë‹«ê¸°
          if (currentInfoWindow) {
            currentInfoWindow.close();
            currentInfoWindow = null;
          }

          alert(`${name} ì¶”ê°€ë¨`);
        };

        window.closeInfoWindow = function () {
          if (currentInfoWindow) {
            currentInfoWindow.close();
            currentInfoWindow = null;
          }
        };

        // ê²€ìƒ‰ ê¸°ëŠ¥
        document.getElementById("searchBtn").onclick = async function () {
          const query = document.getElementById("searchInput").value;
          if (!query) return alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”");

          try {
            const res = await fetch(
              `/api/search?q=${encodeURIComponent(query)}`
            );
            const data = await res.json();

            markers.forEach((m) => m.setMap(null));
            markers = [];

            if (data.documents.length === 0) {
              alert("ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤");
              return;
            }

            data.documents.forEach((place) => {
              const marker = new kakao.maps.Marker({
                map,
                position: new kakao.maps.LatLng(place.y, place.x),
              });

              const info = new kakao.maps.InfoWindow({
                content: `<div style="padding:10px; min-width:150px;">
                          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                            <strong>${place.place_name}</strong>
                            <button onclick="closeInfoWindow()" style="background:none; border:none; font-size:16px; cursor:pointer; padding:0 5px;">âœ•</button>
                          </div>
                          <button onclick='addToCourse("${place.place_name}", ${place.y}, ${place.x})' style="width:100%; padding:5px; background:#4caf50; color:white; border:none; border-radius:3px; cursor:pointer;">ì½”ìŠ¤ ì¶”ê°€</button>
                        </div>`,
              });

              kakao.maps.event.addListener(marker, "click", () => {
                // ì´ë¯¸ ì—´ë ¤ìˆëŠ” InfoWindowê°€ ìˆìœ¼ë©´ ë‹«ê¸°
                if (currentInfoWindow) {
                  currentInfoWindow.close();
                }

                // ê°™ì€ ë§ˆì»¤ë¥¼ ë‹¤ì‹œ í´ë¦­í•˜ë©´ í† ê¸€ (ë‹«ê¸°)
                if (currentInfoWindow === info) {
                  currentInfoWindow = null;
                } else {
                  info.open(map, marker);
                  currentInfoWindow = info;
                }
              });

              markers.push(marker);
            });

            // ì²« ë²ˆì§¸ ê²°ê³¼ë¡œ ì§€ë„ ì´ë™
            map.setCenter(
              new kakao.maps.LatLng(data.documents[0].y, data.documents[0].x)
            );
          } catch (err) {
            console.error(err);
            alert("ê²€ìƒ‰ ì‹¤íŒ¨");
          }
        };

        // ì½”ìŠ¤ ì €ì¥
        document.getElementById("saveBtn").onclick = async function () {
          if (myCourse.length === 0) return alert("ì½”ìŠ¤ì— ì¥ì†Œë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”");
          const userId = document.getElementById("userSelect").value;
          const name = prompt("ì½”ìŠ¤ ì´ë¦„ ì…ë ¥:", "ë‚˜ì˜ ì—¬í–‰ì½”ìŠ¤");
          if (!name) return;

          try {
            const res = await fetch("/api/course", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ userId, name, places: myCourse }),
            });
            const data = await res.json();
            if (data.success) {
              alert(`ì €ì¥ ì™„ë£Œ! ì½”ìŠ¤ ID: ${data.courseId}`);
              myCourse = [];
              renderCourseList();
            } else {
              alert("ì €ì¥ ì‹¤íŒ¨");
            }
          } catch (err) {
            console.error(err);
            alert("ì €ì¥ ì‹¤íŒ¨");
          }
        };

        // ì €ì¥ëœ ì½”ìŠ¤ ë¶ˆëŸ¬ì˜¤ê¸°
        document.getElementById("loadCoursesBtn").onclick = async function () {
          const userId = document.getElementById("userSelect").value;
          try {
            const res = await fetch(`/api/course/${userId}`);
            const courses = await res.json();

            const container = document.getElementById("savedCourses");
            container.innerHTML = "";

            if (courses.length === 0) {
              container.innerHTML = "<p>ì €ì¥ëœ ì½”ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤</p>";
              return;
            }

            courses.forEach((course) => {
              const div = document.createElement("div");
              div.className = "saved-course";
              div.innerHTML = `
                <strong>${course.name}</strong><br>
                <small>${course.course_places.length}ê°œ ì¥ì†Œ</small>
              `;
              div.onclick = () => loadCourse(course);
              container.appendChild(div);
            });
          } catch (err) {
            console.error(err);
            alert("ì½”ìŠ¤ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");
          }
        };

        function loadCourse(course) {
          // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
          markers.forEach((m) => m.setMap(null));
          markers = [];

          // ê¸°ì¡´ ê²½ë¡œ ì œê±°
          if (routePolyline) {
            routePolyline.setMap(null);
            routePolyline = null;
          }

          // ì½”ìŠ¤ ë°ì´í„° ë¡œë“œ
          myCourse = course.course_places
            .sort((a, b) => a.order_index - b.order_index)
            .map((p) => ({
              name: p.place_name,
              lat: p.lat,
              lng: p.lng,
            }));

          renderCourseList();

          // ë§ˆì»¤ í‘œì‹œ
          myCourse.forEach((place, index) => {
            const marker = new kakao.maps.Marker({
              map,
              position: new kakao.maps.LatLng(place.lat, place.lng),
              title: `${index + 1}. ${place.name}`,
            });
            markers.push(marker);
          });

          // ì²« ë²ˆì§¸ ì¥ì†Œë¡œ ì§€ë„ ì´ë™
          if (myCourse.length > 0) {
            map.setCenter(
              new kakao.maps.LatLng(myCourse[0].lat, myCourse[0].lng)
            );
          }

          alert(`"${course.name}" ì½”ìŠ¤ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤`);
        }

        // ê²½ë¡œ ë³´ê¸°
        document.getElementById("showRouteBtn").onclick = async function () {
          if (myCourse.length < 2) {
            return alert("ê²½ë¡œë¥¼ ë³´ë ¤ë©´ ìµœì†Œ 2ê°œ ì´ìƒì˜ ì¥ì†Œê°€ í•„ìš”í•©ë‹ˆë‹¤");
          }

          // ê¸°ì¡´ ê²½ë¡œ ì œê±°
          if (routePolyline) {
            routePolyline.setMap(null);
          }

          try {
            let totalDistance = 0;
            let totalDuration = 0;
            const pathCoords = [];

            // ê° êµ¬ê°„ë³„ ê²½ë¡œ ê°€ì ¸ì˜¤ê¸°
            for (let i = 0; i < myCourse.length - 1; i++) {
              const start = myCourse[i];
              const end = myCourse[i + 1];

              const res = await fetch(
                `/api/route?startLng=${start.lng}&startLat=${start.lat}&endLng=${end.lng}&endLat=${end.lat}`
              );
              const data = await res.json();

              if (data.routes && data.routes.length > 0) {
                const route = data.routes[0];
                totalDistance += route.summary.distance;
                totalDuration += route.summary.duration;

                // ê²½ë¡œ ì¢Œí‘œ ì¶”ì¶œ
                route.sections.forEach((section) => {
                  section.roads.forEach((road) => {
                    road.vertexes.forEach((vertex, idx) => {
                      if (idx % 2 === 0) {
                        pathCoords.push(
                          new kakao.maps.LatLng(
                            road.vertexes[idx + 1],
                            road.vertexes[idx]
                          )
                        );
                      }
                    });
                  });
                });
              }
            }

            // í´ë¦¬ë¼ì¸ ê·¸ë¦¬ê¸°
            routePolyline = new kakao.maps.Polyline({
              path: pathCoords,
              strokeWeight: 5,
              strokeColor: "#FF0000",
              strokeOpacity: 0.7,
              strokeStyle: "solid",
            });
            routePolyline.setMap(map);

            // ê²½ë¡œ ì •ë³´ í‘œì‹œ
            document.getElementById("routeInfo").innerHTML = `
              <div class="route-info">
                <strong>ğŸš— ê²½ë¡œ ì •ë³´</strong><br>
                ì´ ê±°ë¦¬: ${(totalDistance / 1000).toFixed(1)} km<br>
                ì˜ˆìƒ ì‹œê°„: ${Math.round(totalDuration / 60)} ë¶„
              </div>
            `;
          } catch (err) {
            console.error(err);
            alert("ê²½ë¡œ ê²€ìƒ‰ ì‹¤íŒ¨");
          }
        };
      });
    </script>
  </body>
</html>
