<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>K-콘텐츠 지도</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Pretendard", -apple-system, BlinkMacSystemFont, sans-serif;
        background: linear-gradient(135deg, #f5e6d3 0%, #ffffff 100%);
        min-height: 100vh;
      }

      header {
        background: linear-gradient(135deg, #ff4d8d 0%, #3a8dff 100%);
        color: white;
        padding: 20px 30px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      header h1 {
        font-size: 28px;
        font-weight: 700;
        letter-spacing: -0.5px;
      }

      header p {
        font-size: 14px;
        opacity: 0.9;
        margin-top: 5px;
      }

      .container {
        display: flex;
        gap: 20px;
        padding: 20px;
        max-width: 1600px;
        margin: 0 auto;
      }

      .left-panel {
        flex: 1;
        max-width: 420px;
      }

      .map-container {
        flex: 2;
      }

      #map {
        width: 100%;
        height: 700px;
        border-radius: 16px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        overflow: hidden;
      }

      input,
      button,
      select {
        padding: 12px 16px;
        margin: 5px;
        border-radius: 8px;
        border: 2px solid transparent;
        font-size: 14px;
        transition: all 0.3s ease;
      }

      input:focus,
      select:focus {
        outline: none;
        border-color: #3a8dff;
      }

      button {
        cursor: pointer;
        font-weight: 600;
        border: none;
      }

      button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .section {
        background: white;
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 16px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(58, 141, 255, 0.1);
      }

      .section h3 {
        margin-top: 0;
        margin-bottom: 15px;
        color: #1a1a1a;
        font-size: 18px;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .search-section {
        border-top: 3px solid #ff4d8d;
      }

      .course-section {
        border-top: 3px solid #3a8dff;
      }

      .saved-section {
        border-top: 3px solid #f5e6d3;
      }

      #searchInput {
        width: calc(100% - 90px);
        border: 2px solid #f5e6d3;
        background: #fafafa;
      }

      #searchBtn {
        background: linear-gradient(135deg, #ff4d8d 0%, #ff6b9d 100%);
        color: white;
        padding: 12px 20px;
      }

      #courseList {
        list-style: none;
        padding: 0;
        min-height: 120px;
        background: #fafafa;
        border: 2px dashed #f5e6d3;
        border-radius: 12px;
        padding: 10px;
      }

      #courseList:empty::before {
        content: "장소를 추가해보세요 📍";
        display: block;
        text-align: center;
        color: #999;
        padding: 40px;
      }

      #courseList li {
        padding: 14px 16px;
        margin: 8px 0;
        background: linear-gradient(135deg, #ffffff 0%, #f5f5f5 100%);
        border-radius: 10px;
        cursor: move;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-left: 4px solid #3a8dff;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        transition: all 0.3s ease;
      }

      #courseList li:hover {
        transform: translateX(4px);
        box-shadow: 0 4px 12px rgba(58, 141, 255, 0.2);
      }

      #courseList li.dragging {
        opacity: 0.5;
        transform: scale(0.95);
      }

      .remove-btn {
        background: #ff4d8d;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 12px;
        font-weight: 600;
      }

      .remove-btn:hover {
        background: #ff3377;
      }

      #saveBtn {
        width: 100%;
        background: linear-gradient(135deg, #3a8dff 0%, #5ba3ff 100%);
        color: white;
        border: none;
        padding: 14px;
        font-size: 15px;
        margin: 10px 5px 5px 5px;
      }

      #showRouteBtn {
        width: 100%;
        background: linear-gradient(135deg, #ff4d8d 0%, #ff6b9d 100%);
        color: white;
        border: none;
        padding: 14px;
        font-size: 15px;
        margin: 5px;
      }

      #savedCourses {
        max-height: 300px;
        overflow-y: auto;
      }

      #savedCourses::-webkit-scrollbar {
        width: 8px;
      }

      #savedCourses::-webkit-scrollbar-thumb {
        background: #3a8dff;
        border-radius: 4px;
      }

      #savedCourses::-webkit-scrollbar-track {
        background: #f5e6d3;
        border-radius: 4px;
      }

      .saved-course {
        background: white;
        padding: 14px;
        margin: 8px 0;
        border-radius: 10px;
        cursor: pointer;
        border: 2px solid #f5e6d3;
        transition: all 0.3s ease;
      }

      .saved-course:hover {
        background: linear-gradient(135deg, #ffffff 0%, #f5e6d3 30%);
        border-color: #3a8dff;
        transform: translateX(4px);
        box-shadow: 0 4px 12px rgba(58, 141, 255, 0.15);
      }

      .saved-course strong {
        color: #1a1a1a;
        font-size: 15px;
      }

      .saved-course small {
        color: #666;
        font-size: 13px;
      }

      .route-info {
        background: linear-gradient(135deg, #f5e6d3 0%, #ffffff 100%);
        padding: 16px;
        margin-top: 10px;
        border-radius: 10px;
        border: 2px solid #3a8dff;
        color: #1a1a1a;
      }

      .route-info strong {
        color: #ff4d8d;
        font-size: 16px;
      }

      select {
        background: white;
        border: 2px solid #f5e6d3;
        color: #1a1a1a;
        width: calc(100% - 100px);
      }

      #loadCoursesBtn {
        background: #3a8dff;
        color: white;
        padding: 12px 16px;
      }

      #loadCoursesBtn:hover {
        background: #2a7dff;
      }

      /* 마커 InfoWindow 스타일 */
      .custom-info {
        padding: 12px;
        min-width: 180px;
        background: white;
        border-radius: 8px;
      }

      .info-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }

      .info-close {
        background: none;
        border: none;
        font-size: 18px;
        cursor: pointer;
        padding: 0 5px;
        color: #999;
      }

      .info-close:hover {
        color: #ff4d8d;
      }

      .info-add-btn {
        width: 100%;
        padding: 8px;
        background: linear-gradient(135deg, #3a8dff 0%, #5ba3ff 100%);
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        font-size: 13px;
      }

      @media (max-width: 1024px) {
        .container {
          flex-direction: column;
        }

        .left-panel {
          max-width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <h1>🇰🇷 K-콘텐츠 여행 지도</h1>
      <p>한류 콘텐츠와 함께하는 특별한 여행 코스를 만들어보세요</p>
    </header>

    <div class="container">
      <div class="left-panel">
        <!-- 장소 검색 -->
        <div class="section search-section">
          <h3>🔍 장소 검색</h3>
          <input
            type="text"
            id="searchInput"
            placeholder="드라마 촬영지, 맛집, 관광지..."
          />
          <button id="searchBtn">검색</button>
        </div>

        <!-- 현재 코스 -->
        <div class="section course-section">
          <h3>📍 나만의 여행 코스</h3>
          <p style="font-size: 13px; color: #666; margin-bottom: 10px">
            드래그로 순서를 변경할 수 있어요
          </p>
          <ul id="courseList"></ul>
          <button id="saveBtn">💾 코스 저장하기</button>
          <button id="showRouteBtn">🚗 경로 확인하기</button>
          <div id="routeInfo"></div>
        </div>

        <!-- 저장된 코스 -->
        <div class="section saved-section">
          <h3>💎 저장된 코스</h3>
          <select id="userSelect">
            <option value="1">사용자 1</option>
            <option value="2">사용자 2</option>
            <option value="3">사용자 3</option>
          </select>
          <button id="loadCoursesBtn">불러오기</button>
          <div id="savedCourses"></div>
        </div>
      </div>

      <div class="map-container">
        <div id="map"></div>
      </div>
    </div>

    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=8d27848d8e0061837441313b57eba277&libraries=services&autoload=false"></script>

    <script>
      kakao.maps.load(function () {
        var map = new kakao.maps.Map(document.getElementById("map"), {
          center: new kakao.maps.LatLng(37.5665, 126.978),
          level: 5,
        });

        let markers = [];
        let myCourse = [];
        let routePolyline = null;
        let currentInfoWindow = null;

        // 드래그 앤 드롭 기능
        const courseList = document.getElementById("courseList");
        let draggedElement = null;

        courseList.addEventListener("dragstart", (e) => {
          draggedElement = e.target;
          e.target.classList.add("dragging");
        });

        courseList.addEventListener("dragend", (e) => {
          e.target.classList.remove("dragging");
        });

        courseList.addEventListener("dragover", (e) => {
          e.preventDefault();
          const afterElement = getDragAfterElement(courseList, e.clientY);
          const dragging = document.querySelector(".dragging");
          if (afterElement == null) {
            courseList.appendChild(dragging);
          } else {
            courseList.insertBefore(dragging, afterElement);
          }
        });

        courseList.addEventListener("drop", (e) => {
          e.preventDefault();
          updateCourseOrder();
        });

        function getDragAfterElement(container, y) {
          const draggableElements = [
            ...container.querySelectorAll("li:not(.dragging)"),
          ];
          return draggableElements.reduce(
            (closest, child) => {
              const box = child.getBoundingClientRect();
              const offset = y - box.top - box.height / 2;
              if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
              } else {
                return closest;
              }
            },
            { offset: Number.NEGATIVE_INFINITY }
          ).element;
        }

        function updateCourseOrder() {
          const listItems = courseList.querySelectorAll("li");
          const newOrder = [];
          listItems.forEach((item, index) => {
            const courseIndex = parseInt(item.dataset.index);
            newOrder.push(myCourse[courseIndex]);
          });
          myCourse = newOrder;
          renderCourseList();
        }

        function renderCourseList() {
          courseList.innerHTML = "";
          myCourse.forEach((place, index) => {
            const li = document.createElement("li");
            li.draggable = true;
            li.dataset.index = index;
            li.innerHTML = `
              <span><strong>${index + 1}.</strong> ${place.name}</span>
              <button class="remove-btn" onclick="removeCourse(${index})">삭제</button>
            `;
            courseList.appendChild(li);
          });
        }

        window.removeCourse = function (index) {
          myCourse.splice(index, 1);
          renderCourseList();
        };

        window.addToCourse = function (name, lat, lng) {
          myCourse.push({ name, lat, lng });
          renderCourseList();

          if (currentInfoWindow) {
            currentInfoWindow.close();
            currentInfoWindow = null;
          }

          alert(`✨ ${name}이(가) 코스에 추가되었습니다!`);
        };

        window.closeInfoWindow = function () {
          if (currentInfoWindow) {
            currentInfoWindow.close();
            currentInfoWindow = null;
          }
        };

        // 검색 기능
        document.getElementById("searchBtn").onclick = async function () {
          const query = document.getElementById("searchInput").value;
          if (!query) return alert("검색어를 입력해주세요 😊");

          try {
            const res = await fetch(
              `/api/search?q=${encodeURIComponent(query)}`
            );
            const data = await res.json();

            markers.forEach((m) => m.setMap(null));
            markers = [];

            if (data.documents.length === 0) {
              alert("검색 결과가 없습니다 😢");
              return;
            }

            data.documents.forEach((place) => {
              const marker = new kakao.maps.Marker({
                map,
                position: new kakao.maps.LatLng(place.y, place.x),
              });

              const info = new kakao.maps.InfoWindow({
                content: `<div class="custom-info">
                          <div class="info-header">
                            <strong style="color: #1A1A1A;">${place.place_name}</strong>
                            <button onclick="closeInfoWindow()" class="info-close">✕</button>
                          </div>
                          <button onclick='addToCourse("${place.place_name}", ${place.y}, ${place.x})' class="info-add-btn">+ 코스 추가</button>
                        </div>`,
              });

              kakao.maps.event.addListener(marker, "click", () => {
                if (currentInfoWindow) {
                  currentInfoWindow.close();
                }

                if (currentInfoWindow === info) {
                  currentInfoWindow = null;
                } else {
                  info.open(map, marker);
                  currentInfoWindow = info;
                }
              });

              markers.push(marker);
            });

            map.setCenter(
              new kakao.maps.LatLng(data.documents[0].y, data.documents[0].x)
            );
          } catch (err) {
            console.error(err);
            alert("검색에 실패했습니다 😢");
          }
        };

        // 엔터키로 검색
        document
          .getElementById("searchInput")
          .addEventListener("keypress", (e) => {
            if (e.key === "Enter") {
              document.getElementById("searchBtn").click();
            }
          });

        // 코스 저장
        document.getElementById("saveBtn").onclick = async function () {
          if (myCourse.length === 0)
            return alert("코스에 장소를 추가해주세요 📍");
          const userId = document.getElementById("userSelect").value;
          const name = prompt("코스 이름을 입력하세요 ✨", "나의 K-여행 코스");
          if (!name) return;

          try {
            const res = await fetch("/api/course", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ userId, name, places: myCourse }),
            });
            const data = await res.json();
            if (data.success) {
              alert(`🎉 저장 완료!\n코스 ID: ${data.courseId}`);
              myCourse = [];
              renderCourseList();
            } else {
              alert("저장에 실패했습니다 😢");
            }
          } catch (err) {
            console.error(err);
            alert("저장에 실패했습니다 😢");
          }
        };

        // 저장된 코스 불러오기
        document.getElementById("loadCoursesBtn").onclick = async function () {
          const userId = document.getElementById("userSelect").value;
          try {
            const res = await fetch(`/api/course/${userId}`);
            const courses = await res.json();

            const container = document.getElementById("savedCourses");
            container.innerHTML = "";

            if (courses.length === 0) {
              container.innerHTML =
                '<p style="text-align:center; color:#999; padding:20px;">저장된 코스가 없습니다 📭</p>';
              return;
            }

            courses.forEach((course) => {
              const div = document.createElement("div");
              div.className = "saved-course";
              div.innerHTML = `
                <strong>🎯 ${course.name}</strong><br>
                <small>📍 ${course.course_places.length}개 장소</small>
              `;
              div.onclick = () => loadCourse(course);
              container.appendChild(div);
            });
          } catch (err) {
            console.error(err);
            alert("코스 불러오기에 실패했습니다 😢");
          }
        };

        function loadCourse(course) {
          markers.forEach((m) => m.setMap(null));
          markers = [];

          if (routePolyline) {
            routePolyline.setMap(null);
            routePolyline = null;
          }

          myCourse = course.course_places
            .sort((a, b) => a.order_index - b.order_index)
            .map((p) => ({
              name: p.place_name,
              lat: p.lat,
              lng: p.lng,
            }));

          renderCourseList();

          myCourse.forEach((place, index) => {
            const marker = new kakao.maps.Marker({
              map,
              position: new kakao.maps.LatLng(place.lat, place.lng),
              title: `${index + 1}. ${place.name}`,
            });
            markers.push(marker);
          });

          if (myCourse.length > 0) {
            map.setCenter(
              new kakao.maps.LatLng(myCourse[0].lat, myCourse[0].lng)
            );
          }

          alert(`✨ "${course.name}" 코스를 불러왔습니다!`);
        }

        // 경로 보기
        document.getElementById("showRouteBtn").onclick = async function () {
          if (myCourse.length < 2) {
            return alert("경로를 보려면 최소 2개 이상의 장소가 필요합니다 🗺️");
          }

          if (routePolyline) {
            routePolyline.setMap(null);
          }

          try {
            let totalDistance = 0;
            let totalDuration = 0;
            const pathCoords = [];

            for (let i = 0; i < myCourse.length - 1; i++) {
              const start = myCourse[i];
              const end = myCourse[i + 1];

              const res = await fetch(
                `/api/route?startLng=${start.lng}&startLat=${start.lat}&endLng=${end.lng}&endLat=${end.lat}`
              );
              const data = await res.json();

              if (data.routes && data.routes.length > 0) {
                const route = data.routes[0];
                totalDistance += route.summary.distance;
                totalDuration += route.summary.duration;

                route.sections.forEach((section) => {
                  section.roads.forEach((road) => {
                    road.vertexes.forEach((vertex, idx) => {
                      if (idx % 2 === 0) {
                        pathCoords.push(
                          new kakao.maps.LatLng(
                            road.vertexes[idx + 1],
                            road.vertexes[idx]
                          )
                        );
                      }
                    });
                  });
                });
              }
            }

            routePolyline = new kakao.maps.Polyline({
              path: pathCoords,
              strokeWeight: 6,
              strokeColor: "#FF4D8D",
              strokeOpacity: 0.8,
              strokeStyle: "solid",
            });
            routePolyline.setMap(map);

            document.getElementById("routeInfo").innerHTML = `
              <div class="route-info">
                <strong>🚗 경로 정보</strong><br>
                <div style="margin-top: 8px; font-size: 14px;">
                  📏 총 거리: <strong>${(totalDistance / 1000).toFixed(
                    1
                  )} km</strong><br>
                  ⏱️ 예상 시간: <strong>${Math.round(
                    totalDuration / 60
                  )} 분</strong>
                </div>
              </div>
            `;
          } catch (err) {
            console.error(err);
            alert("경로 검색에 실패했습니다 😢");
          }
        };
      });
    </script>
  </body>
</html>
