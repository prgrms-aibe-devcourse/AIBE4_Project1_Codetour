<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>공공데이터 JSON 추출 (JS)</title>
    <style>
      table,
      th,
      td {
        border: 1px solid black;
        border-collapse: collapse;
        padding: 8px;
      }
      #dataContainer {
        margin-top: 20px;
      }
      pre {
        white-space: pre-wrap;
        word-wrap: break-word;
      }
    </style>
  </head>
  <body>
    <h1>문화포털 데이터 JSON 추출 예제</h1>
    <button onclick="fetchAndDownloadJson()">JSON 데이터로 추출</button>

    <div id="dataContainer"></div>

    <script>
      async function fetchAndDownloadJson() {
        const container = document.getElementById("dataContainer");
        container.textContent =
          "전체 데이터를 가져오는 중... 잠시만 기다려주세요.";

        try {
          // 1. 첫 페이지를 호출하여 전체 데이터 수(totalCount) 확인
          const firstPageResponse = await fetch(
            "http://localhost:3000/culture-api?numOfRows=1&pageNo=1"
          );
          if (!firstPageResponse.ok) {
            throw new Error(`HTTP error! status: ${firstPageResponse.status}`);
          }
          const firstPageResult = await firstPageResponse.json();

          // xml-js 라이브러리(compact: true)는 텍스트 내용을 _text 속성으로 변환합니다.
          const totalCount = parseInt(
            firstPageResult.response?.body?.totalCount?._text,
            10
          );

          if (isNaN(totalCount) || totalCount === 0) {
            alert("전체 데이터 수를 가져올 수 없거나 데이터가 없습니다.");
            container.textContent = "데이터가 없습니다.";
            return;
          }

          const pageSize = 100; // API가 허용하는 최대치 또는 적절한 값으로 설정
          const totalPages = Math.ceil(totalCount / pageSize);
          container.textContent = `전체 ${totalCount}개 데이터 중 ${pageSize}개씩, 총 ${totalPages}페이지를 가져옵니다...`;

          // 2. 모든 페이지에 대한 요청 프로미스를 생성
          const promises = [];
          for (let pageNo = 1; pageNo <= totalPages; pageNo++) {
            const promise = fetch(
              `http://localhost:3000/culture-api?numOfRows=${pageSize}&pageNo=${pageNo}`
            )
              .then((res) => {
                if (!res.ok) throw new Error(`페이지 ${pageNo} 로드 실패`);
                return res.json();
              })
              .then((result) => result.response?.body?.items?.item || []);
            promises.push(promise);
          }

          // 3. 모든 요청을 병렬로 실행하고 결과 취합
          const results = await Promise.all(promises);
          const allData = results.flat(); // 2차원 배열을 1차원으로 평탄화

          if (allData.length === 0) {
            alert("데이터를 가져오지 못했습니다.");
            container.innerHTML = "";
            return;
          }

          console.log(
            `총 ${allData.length}개의 데이터를 성공적으로 가져왔습니다.`
          );

          // 4. 전체 데이터를 JSON 파일로 다운로드 및 미리보기 표시
          downloadJsonFile(
            allData,
            `culture_data_total_${allData.length}.json`
          );
          displayDataPreview(allData);
        } catch (error) {
          console.error("전체 데이터를 가져오는 중 오류 발생:", error);
          alert("데이터를 가져오는 중 오류가 발생했습니다. 콘솔을 확인하세요.");
          container.textContent = `오류 발생: ${error.message}`;
        }
      }

      /**
       * JSON 데이터를 파일로 만들어 다운로드하는 함수
       * @param {object} data - 다운로드할 JSON 데이터
       * @param {string} filename - 저장할 파일 이름
       */
      function downloadJsonFile(data, filename) {
        // JSON 데이터를 예쁘게 포맷된 문자열로 변환
        const jsonString = JSON.stringify(data, null, 2);

        const blob = new Blob([jsonString], {
          type: "application/json;charset=utf-8;",
        });

        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = filename;

        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        console.log(`JSON 파일 '${filename}' 다운로드 시작됨.`);
      }

      // (선택 사항) 가져온 데이터를 HTML 테이블로 간단히 미리보기
      function displayDataPreview(data) {
        const container = document.getElementById("dataContainer");
        if (!data || data.length === 0) {
          container.textContent = "표시할 데이터가 없습니다.";
          return;
        }
        container.innerHTML = ""; // Clear existing content

        const table = document.createElement("table");
        const thead = document.createElement("thead");
        const tbody = document.createElement("tbody");
        const headerRow = document.createElement("tr");

        const headers = Object.keys(data[0]);
        headers.forEach((headerText) => {
          const th = document.createElement("th");
          th.textContent = headerText;
          headerRow.appendChild(th);
        });

        thead.appendChild(headerRow);
        table.appendChild(thead);

        data.forEach((item) => {
          const row = document.createElement("tr");
          headers.forEach((header) => {
            const cell = document.createElement("td");
            const cellData = item[header];

            if (cellData === null || cellData === undefined) {
              cell.textContent = "";
            } else if (typeof cellData === "object") {
              const pre = document.createElement("pre");
              pre.textContent = JSON.stringify(cellData, null, 2);
              cell.appendChild(pre);
            } else {
              cell.textContent = cellData;
            }
            row.appendChild(cell);
          });
          tbody.appendChild(row);
        });

        table.appendChild(tbody);
        container.appendChild(table);
      }
    </script>
  </body>
</html>
