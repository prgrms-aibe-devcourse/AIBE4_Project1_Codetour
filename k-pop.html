<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>K-Pop - Korea Travel Planner</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <header>
        <div class="container">
            <div class="logo-container">
                <div class="logo-text">CodeTour</div>
            </div>
            <div class="action-container">
                <button>로그인</button>
                <button>회원가입</button>
            </div>
        </div>
        <nav>
            <a href="index.html">홈</a>
            <a href="k-drama.html">콘텐츠별 여행지</a>
            <a href="#">지역별 탐색</a>
            <a href="#">여행 코스</a>
            <a href="#">인기 여행 루트</a>
            <a href="#">마이페이지</a>
        </nav>
    </header>

    <main>
      <div class="main-header">
        <h1>K-Pop</h1>
      </div>
      <div class="card-container" id="card-container"></div>
    </main>

    <footer>
      <p>&copy; Kspot</p>
    </footer>

    <script type="module">
      let supabase;
      async function initSupabase() {
        try {
          const response = await fetch("http://localhost:3000/api/config");
          if (!response.ok) throw new Error("Failed to fetch Supabase config");
          const config = await response.json();
          supabase = window.supabase.createClient(
            config.supabaseUrl,
            config.supabaseKey
          );
          loadKpopData();
        } catch (error) {
          console.error("Error initializing Supabase:", error);
        }
      }

      async function loadKpopData() {
        const cardContainer = document.getElementById('card-container');

        const { data: contents, error: contentsError } = await supabase
          .from('contents')
          .select('*')
          .eq('contentGroup', 'K-Pop');

        if (contentsError) {
          console.error('Error fetching contents:', contentsError);
          return;
        }

        for (const content of contents) {
          const { data: locations, error: locationsError } = await supabase
            .from('location')
            .select('locationId', { count: 'exact' })
            .eq('contentId', content.contentId);

          const locationCount = locations ? locations.length : 0;

          const card = document.createElement('div');
          card.classList.add('card');

          card.innerHTML = `
            <div class="image-container">
              <img src="${content.imageUrl}" alt="${content.title}">
              <div class="badge">${content.contentGroup}</div>
            </div>
            <div class="content-container">
              <h3>${content.title}</h3>
              <p class="description">${content.description}</p>
              <div class="details">
                <span>${locationCount}개 장소</span>
                <button class="details-button" data-content-id="${content.contentId}">자세히 보기</button>
              </div>
            </div>
          `;

          cardContainer.appendChild(card);
        }

        document.querySelectorAll('.details-button').forEach(button => {
          button.addEventListener('click', (event) => {
            const contentId = event.target.dataset.contentId;
            console.log('View details for contentId:', contentId);
            // Here you can redirect to a details page or open a modal
          });
        });
      }

      initSupabase();
    </script>
  </body>
</html>