<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CodeTour</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="../style.css" />
  </head>
  <body>
    <header>
      <div class="container">
        <div class="logo-container">
          <div class="logo-text">CodeTour</div>
        </div>
        <div class="action-container">
          <button>로그인</button>
          <button>회원가입</button>
        </div>
      </div>
      <nav>
        <a href="index.html">홈</a>
        <a href="k-drama.html">콘텐츠별 여행지</a>
        <a href="#">지역별 탐색</a>
        <a href="#">여행 코스</a>
        <a href="#">인기 여행 루트</a>
        <a href="#">마이페이지</a>
      </nav>
    </header>

    <main>
      <div class="main-header">
        <h1>콘텐츠별 여행지</h1>
        <p>좋아하는 드라마, 영화, 예능의 촬영지를 찾아보세요</p>
      </div>

      <div class="tab-menu">
        <button class="tab-button active" data-category="k-pop">K-Pop</button>
        <button class="tab-button" data-category="k-drama">
          K-Drama/Movie
        </button>
        <button class="tab-button" data-category="k-webtoon">K-Webtoon</button>
        <button class="tab-button" data-category="k-food">K-Food</button>
        <button class="tab-button" data-category="k-ent">K-Ent</button>
      </div>

      <div class="card-container" id="card-container"></div>
    </main>

    <footer>
      <p>&copy; Kspot</p>
    </footer>

    <div id="modal" class="modal">
      <div class="modal-content">
        <span class="modal-close">&times;</span>
        <div id="modal-body"></div>
      </div>
    </div>

    <script type="module">
      let supabase;
      let allContents = []; // 모든 콘텐츠를 저장할 배열

      // --- 모달 관련 DOM 요소 가져오기 ---
      const modal = document.getElementById("modal");
      const modalBody = document.getElementById("modal-body");
      const closeModalBtn = document.querySelector(".modal-close");

      // Supabase 클라이언트 초기화
      async function initSupabase() {
        try {
          const response = await fetch("http://localhost:3000/api/config");
          if (!response.ok) throw new Error("Failed to fetch Supabase config");
          const config = await response.json();
          supabase = window.supabase.createClient(
            config.supabaseUrl,
            config.supabaseKey
          );
          await loadAllContents(); // 모든 콘텐츠 로드
          setupTabListeners(); // 탭 이벤트 리스너 설정

          // --- 모달 닫기 이벤트 리스너 설정 ---
          setupModalListeners();
        } catch (error) {
          console.error("Error initializing Supabase:", error);
          const cardContainer = document.getElementById("card-container");
          cardContainer.innerHTML = `<p>Supabase 초기화 중 오류가 발생했습니다: ${error.message}</p>`;
        }
      }

      // 모든 콘텐츠 데이터를 Supabase에서 가져오는 함수
      async function loadAllContents() {
        const cardContainer = document.getElementById("card-container");
        cardContainer.innerHTML = "<p>데이터를 불러오는 중입니다...</p>";

        try {
          // contentGroup 테이블의 모든 데이터를 가져옵니다.
          const { data: contentGroup, error: groupError } = await supabase
            .from("contentGroup")
            .select("*");

          const { data: contents, error: contentsError } = await supabase
            .from("contents")
            .select("*");

          const { data: location, error: locationError } = await supabase
            .from("location")
            .select("*");

          if (groupError) {
            throw groupError;
          }

          // 2. 각 contentGroup에 대해 location 개수를 조회하여 추가합니다.
          const contentsWithCount = [];
          for (const content of contentGroup) {
            const id = content.id;

            let count = 0;
            // id가 유효한 경우에만 location 개수를 조회합니다.
            if (id) {
              const { count: locationCount, error: countError } = await supabase
                .from("location")
                .select("*", { count: "exact", head: true })
                .eq("placeId", id);
              if (!countError) {
                count = locationCount;
              }
            }
            contentsWithCount.push({
              ...content,
              locationCount: count,
            });
          }

          allContents = contentsWithCount;
          filterByCategory("k-pop"); // 처음에는 'K-Pop' 카테고리를 표시
        } catch (error) {
          console.error("Error fetching or processing data:", error);
          cardContainer.innerHTML = `<p>데이터를 불러오는 중 오류가 발생했습니다: ${error.message}</p>`;
        }
      }

      /**
       * 카테고리에 따라 allContents를 필터링하고 표시하는 함수
       * @param {string} category - 선택된 카테고리 ('k-pop', 'k-drama', 'k-webtoon', 'k-food', 'k-ent')
       */
      function filterByCategory(category) {
        let filteredContents;

        if (category === "k-drama") {
          filteredContents = allContents.filter(
            (content) =>
              content.category === "k-drama" || content.category === "k-movie"
          );
        } else {
          const filterCategory = category === "k-pop" ? "k-pop" : category;
          filteredContents = allContents.filter(
            (content) => content.category === filterCategory
          );
        }

        displayItems(filteredContents);
      }

      // 탭 버튼에 이벤트 리스너를 설정하는 함수
      function setupTabListeners() {
        const tabButtons = document.querySelectorAll(".tab-button");
        tabButtons.forEach((button) => {
          button.addEventListener("click", (event) => {
            const category = event.target.dataset.category;
            filterByCategory(category);
            tabButtons.forEach((btn) => btn.classList.remove("active"));
            event.target.classList.add("active");
          });
        });
      }

      // 주어진 아이템 목록을 화면에 카드 형태로 표시하는 함수
      function displayItems(contents) {
        const cardContainer = document.getElementById("card-container");
        cardContainer.innerHTML = "";

        if (!contents || contents.length === 0) {
          cardContainer.innerHTML = "<p>해당 카테고리의 데이터가 없습니다.</p>";
          return;
        }

        for (const content of contents) {
          const locationCount = content.locationCount || 0;

          const card = document.createElement("div");
          card.classList.add("card");

          card.innerHTML = `
                <div class="image-container">
                  <img src="${content.imageUrl || ""}" alt="${
            content.title || "이미지 없음"
          }"
                  onerror="this.style.display='none'">
                  <div class="badge">${content.category}</div>
                </div>
                <div class="content-container">
                  <h3>${content.name || "제목 없음"}</h3>
                  <p class="description">${
                    content.des || "설명이 없습니다."
                  }</p>
                  <div class="details">
                    <button class="details-button" data-content-id="${
                      content.id
                    }">자세히 보기</button>
                  </div>
                </div>
              `;

          cardContainer.appendChild(card);
        }

        document.querySelectorAll(".details-button").forEach((button) => {
          button.addEventListener("click", (event) => {
            const contentId = event.target.dataset.contentId;
            openModal(contentId);
          });
        });
      }

      // --- 모달을 열고 상세 정보를 표시하는 함수 ---
      async function openModal(contentId) {
        modal.style.display = "flex"; // 모달을 보이게 함
        modalBody.innerHTML = "<p>상세 정보를 불러오는 중입니다...</p>";

        try {
          const contentInfo = allContents.find((c) => c.id == contentId);
          console.log("contentInfo:", contentInfo);

          const { data: locations, error } = await supabase
            .from("location")
            .select("*");

          const { data: contents, contentsError } = await supabase
            .from("contents")
            .select("*")
            .eq("contentGroup", contentInfo.name);

          if (error) throw error;
          if (contentsError) throw contentsError;

          console.log("locations:", locations);
          console.log("contents:", contents);

          let html = `<img src="${contentInfo.imageUrl}" alt="${contentInfo.name}">`;
          html += `<h2>${contentInfo.name}</h2>`;
          html += "<hr><h3>관련 촬영지 정보</h3>";

          if (contents && contents.length > 0) {
            html += "<ul>";
            contents.forEach((loc) => {
              const postCode = loc.name ? `[${loc.name}]` : "";
              html += `<li>${postCode} ${
                loc.location || "주소 정보 없음"
              }</li>`;
            });
            html += "</ul>";
          } else {
            html += "<p>관련된 장소 정보가 없습니다.</p>";
          }

          modalBody.innerHTML = html;
        } catch (error) {
          modalBody.innerHTML = `<p>상세 정보를 불러오는 데 실패했습니다: ${error.message}</p>`;
        }
      }

      // --- 모달을 닫는 함수 ---
      function closeModal() {
        modal.style.display = "none";
      }

      // ---모달 닫기 이벤트 리스너를 설정하는 함수 ---
      function setupModalListeners() {
        closeModalBtn.addEventListener("click", closeModal);

        window.addEventListener("click", (event) => {
          if (event.target == modal) {
            closeModal();
          }
        });
      }

      initSupabase();
    </script>
  </body>
</html>
