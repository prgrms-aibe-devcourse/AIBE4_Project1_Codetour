<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CodeTour</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <header>
      <div class="container">
        <div class="logo-container">
          <div class="logo-text">CodeTour</div>
        </div>
        <div class="action-container">
          <button>로그인</button>
          <button>회원가입</button>
        </div>
      </div>
      <nav>
        <a href="index.html">홈</a>
        <a href="k-drama.html">콘텐츠별 여행지</a>
        <a href="#">지역별 탐색</a>
        <a href="#">여행 코스</a>
        <a href="#">인기 여행 루트</a>
        <a href="#">마이페이지</a>
      </nav>
    </header>

    <main>
      <div class="main-header">
        <h1>콘텐츠별 여행지</h1>
        <p>좋아하는 드라마, 영화, 예능의 촬영지를 찾아보세요</p>
      </div>

      <!-- 탭 메뉴 추가 -->
      <div class="tab-menu">
        <button class="tab-button active" data-category="k-pop">K-Pop</button>
        <button class="tab-button" data-category="k-drama">
          K-Drama/Movie
        </button>
        <button class="tab-button" data-category="k-webtoon">K-Webtoon</button>
        <button class="tab-button" data-category="k-food">K-Food</button>
        <button class="tab-button" data-category="k-ent">K-Ent</button>
      </div>

      <!-- 카드 컨테이너 추가 -->
      <div class="card-container" id="card-container"></div>
    </main>

    <footer>
      <p>&copy; Kspot</p>
    </footer>

    <script type="module">
      let supabase;
      let allContents = []; // 모든 콘텐츠를 저장할 배열

      // Supabase 클라이언트 초기화
      async function initSupabase() {
        try {
          const response = await fetch("http://localhost:3000/api/config");
          if (!response.ok) throw new Error("Failed to fetch Supabase config");
          const config = await response.json();
          supabase = window.supabase.createClient(
            config.supabaseUrl,
            config.supabaseKey
          );
          await loadAllContents(); // 모든 콘텐츠 로드
          setupTabListeners(); // 탭 이벤트 리스너 설정
        } catch (error) {
          console.error("Error initializing Supabase:", error);
          const cardContainer = document.getElementById("card-container");
          cardContainer.innerHTML = `<p>Supabase 초기화 중 오류가 발생했습니다: ${error.message}</p>`;
        }
      }

      // 모든 콘텐츠 데이터를 Supabase에서 가져오는 함수
      async function loadAllContents() {
        const cardContainer = document.getElementById("card-container");
        cardContainer.innerHTML = "<p>데이터를 불러오는 중입니다...</p>";

        try {
          // contentGroup 테이블의 모든 데이터를 가져옵니다.
          const { data: contentGroup, error: groupError } = await supabase
            .from("contentGroup")
            .select("*");

          const { data: contents, error: contentsError } = await supabase
            .from("contents")
            .select("*");

          const { data: location, error: locationError } = await supabase
            .from("location")
            .select("*");

          if (groupError) {
            throw groupError;
          }

          // 2. 각 contentGroup에 대해 location 개수를 조회하여 추가합니다.
          const contentsWithCount = [];
          for (const content of contentGroup) {
            const id = content.id;

            let count = 0;
            // id가 유효한 경우에만 location 개수를 조회합니다.
            if (id) {
              const { count: locationCount, error: countError } = await supabase
                .from("location")
                .select("", { count: "exact", head: true })
                .eq("contentId", id);
              if (!countError) {
                count = locationCount;
              }
            }
            contentsWithCount.push({
              ...content,
              locationCount: count,
            });
          }

          allContents = contentsWithCount;
          console.log("최종 가공된 allContents 데이터:", allContents);

          filterByCategory("k-pop"); // 처음에는 'K-Pop' 카테고리를 표시
        } catch (error) {
          console.error("Error fetching or processing data:", error);
          cardContainer.innerHTML = `<p>데이터를 불러오는 중 오류가 발생했습니다: ${error.message}</p>`;
        }
      }

      //---------------------------------------------------------

      /**
       * 카테고리에 따라 allContents를 필터링하고 표시하는 함수
       * @param {string} category - 선택된 카테고리 ('k-pop', 'k-drama', 'k-webtoon', 'k-food', 'k-ent')
       */
      function filterByCategory(category) {
        let filteredContents;

        if (category === "k-drama") {
          // 'k-drama' 버튼은 'k-drama' 또는 'k-movie' 카테고리를 표시해야 합니다.
          filteredContents = allContents.filter(
            (content) =>
              content.category === "k-drama" || content.category === "k-movie"
          );
        } else {
          // 다른 카테고리('k-pop', 'k-webtoon', 'k-food', 'k-ent')는 해당 카테고리만 필터링
          // 'k-pop' 탭은 'k-pop' 카테고리를 필터링합니다.
          const filterCategory = category === "k-pop" ? "k-pop" : category;
          filteredContents = allContents.filter(
            (content) => content.category === filterCategory
          );
        }

        displayItems(filteredContents);
      }

      // 탭 버튼에 이벤트 리스너를 설정하는 함수
      function setupTabListeners() {
        const tabButtons = document.querySelectorAll(".tab-button");
        tabButtons.forEach((button) => {
          button.addEventListener("click", (event) => {
            const category = event.target.dataset.category;

            // 1. 카테고리 필터링 및 카드 표시
            filterByCategory(category);

            // 2. 활성 버튼 스타일 업데이트
            tabButtons.forEach((btn) => btn.classList.remove("active"));
            event.target.classList.add("active");
          });
        });
      }

      //---------------------------------------------------------

      // 주어진 아이템 목록을 화면에 카드 형태로 표시하는 함수
      function displayItems(contents) {
        const cardContainer = document.getElementById("card-container");
        cardContainer.innerHTML = "";

        console.log("displayItems 함수로 전달된 데이터:", contents);

        if (!contents || contents.length === 0) {
          cardContainer.innerHTML = "<p>해당 카테고리의 데이터가 없습니다.</p>";
          return;
        }

        for (const content of contents) {
          const locationCount = content.locationCount || 0;

          const card = document.createElement("div");
          card.classList.add("card");

          card.innerHTML = `
                <div class="image-container">
                  <img src="${content.imageUrl || ""}" alt="${
            content.title || "이미지 없음"
          }" onerror="this.style.display='none'">
                  <div class="badge">${content.category}</div>
                </div>
                <div class="content-container">
                  <h3>${content.name || "제목 없음"}</h3>
                  <p class="description">${
                    content.des || "설명이 없습니다."
                  }</p>
                  <div class="details">
                  
                    <button class="details-button" data-content-id="${
                      content.id
                    }">자세히 보기</button>
                  </div>
                </div>
              `;

          cardContainer.appendChild(card);
        }

        // '자세히 보기' 버튼 이벤트 리스너 추가
        document.querySelectorAll(".details-button").forEach((button) => {
          button.addEventListener("click", (event) => {
            const contentId = event.target.dataset.contentId;
            console.log("View details for contentId:", contentId);
          });
        });
      }

      initSupabase(); // 페이지 로드 시 Supabase 초기화 및 데이터 로딩 시작
    </script>
  </body>
</html>
