<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title data-i18n="title.main">K-Spot - 한류 콘텐츠 여행 플랫폼</title>
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <meta property="og:image" content="/og-image.jpg" />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:type" content="website" />
    <meta property="og:site_name" content="K-Spot" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="/source/pages/index/style.css" />
    <link rel="stylesheet" href="contentstyle.css" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/swiper/swiper-bundle.min.css"
    />
    <script src="/libs/config.js"></script>
    <script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>
    <script src="/libs/nav-manager.js" type="module"></script>
  </head>
  <body>
    <div id="headerPlaceholder"></div>

    <main>
      <section class="recently-visited-section">
        <div class="recently-visited-header">
          <h2 data-i18n="recent.title">최근 방문한 장소</h2>
          <button class="clear-all-btn" data-i18n="recent.clearAll">
            전체 삭제
          </button>
        </div>
        <div class="recently-visited-list" id="recently-visited-list">
          <!-- 최근 방문 목록이 여기에 동적으로 삽입됩니다. -->
        </div>
      </section>

      <div class="main-header">
        <h1 data-i18n="content.title">콘텐츠별 여행지</h1>
        <p data-i18n="content.subtitle">
          좋아하는 드라마, 영화, 예능의 촬영지를 찾아보세요
        </p>
      </div>

      <div class="tab-menu">
        <button
          class="tab-button active"
          data-category="k-pop"
          data-i18n="tab.kpop"
        >
          K-Pop
        </button>
        <button
          class="tab-button"
          data-category="k-drama"
          data-i18n="tab.kdrama"
        >
          K-Drama/Movie
        </button>
        <button
          class="tab-button"
          data-category="k-webtoon"
          data-i18n="tab.kwebtoon"
        >
          K-Webtoon
        </button>
        <button class="tab-button" data-category="k-food" data-i18n="tab.kfood">
          K-Food
        </button>
        <button class="tab-button" data-category="k-ent" data-i18n="tab.kent">
          K-Ent
        </button>
      </div>

      <div class="card-container" id="card-container"></div>
    </main>

    <footer>
      <p data-i18n="footer.copy">&copy; Kspot</p>
    </footer>

    <script>
      // auth.js에서 사용할 경로 설정
      window.AUTH_PATHS = {
        INDEX: "/source/pages/index/index.html",
        SET_NICK: "/auth/set-nickname.html",
      };
    </script>

    <div id="modal" class="modal">
      <div class="modal-content">
        <span class="modal-close" data-i18n="modal.close">&times;</span>
        <div id="modal-body"></div>
      </div>
    </div>

    <script type="module">
      let supabase;
      let allContents = []; // 모든 콘텐츠를 저장할 배열
      let allLocations = []; // 모든 장소 정보를 저장할 배열
      let userFavorites = new Set(); // 사용자의 좋아요 목록을 저장할 Set

      // --- 모달 관련 DOM 요소 가져오기 ---
      const modal = document.getElementById("modal");
      const modalBody = document.getElementById("modal-body");
      const closeModalBtn = document.querySelector(".modal-close");

      // Supabase 클라이언트 초기화
      // auth.js가 로드된 후 user-manager.js의 함수를 사용할 수 있습니다.
      let getIsLoggedIn;
      let getUserId;
      import("/libs/user-manager.js").then((module) => {
        getIsLoggedIn = module.getIsLoggedIn;
        getUserId = module.getUserId;
      });

      async function initSupabase() {
        try {
          const response = await fetch(`${API_BASE_URL}/api/config`);
          if (!response.ok) throw new Error("Failed to fetch Supabase config");
          const config = await response.json();
          supabase = window.supabase.createClient(
            config.supabaseUrl,
            config.supabaseKey
          );

          // 로그인 상태라면 사용자의 좋아요 목록을 가져옵니다.
          const userId = getUserId ? getUserId() : null;
          if (userId) {
            const { data: favoritesData, error: favoritesError } =
              await supabase
                .from("user_favorites")
                .select("target_id")
                .eq("user_id", userId)
                .eq("target_type", "contents");

            if (favoritesError) {
              console.error("사용자 좋아요 목록 조회 실패:", favoritesError);
            } else {
              userFavorites = new Set(
                favoritesData.map((fav) => fav.target_id.toString())
              );
            }
          }

          await loadAllContents(); // 모든 콘텐츠 로드
          setupTabListeners(); // 탭 이벤트 리스너 설정

          // --- 모달 닫기 이벤트 리스너 설정 ---
          setupModalListeners();
          setupRecentlyVisitedListeners(); // 최근 방문 목록 이벤트 리스너 설정
          renderRecentlyVisited(); // 최근 방문 목록 렌더링
          // contentGroup 테이블의 모든 데이터를 가져옵니다.
          const { data: contentGroup, error: groupError } = await supabase
            .from("contentGroup")
            .select("*");

          const { data: contentsData, error: contentsError } = await supabase
            .from("contents")
            .select("*");

          if (groupError) {
            throw groupError;
          }

          // 2. 각 contentGroup에 대해 location 개수를 조회하여 추가합니다.
          const contentsWithCount = [];
          for (const content of contentGroup) {
            const id = content.id;

            let count = 0;
            // id가 유효한 경우에만 location 개수를 조회합니다.
            if (id) {
              const { count: locationCount, error: countError } = await supabase
                .from("location")
                .select("*", { count: "exact", head: true })
                .eq("placeId", id);
              if (!countError) {
                count = locationCount;
              }
            }
            contentsWithCount.push({
              ...content,
              locationCount: count,
            });
          }

          allContents = contentsWithCount;
          allLocations = contentsData;

          // 페이지 로드 시 sessionStorage에 저장된 모달이 있는지 확인하고 다시 엽니다.
          // 이 위치에서 호출해야 allContents와 allLocations 데이터가 보장됩니다.
          const lastOpenModalId = sessionStorage.getItem("lastOpenModalId");
          if (lastOpenModalId) {
            openModal(lastOpenModalId);
          }

          filterByCategory("k-pop"); // 처음에는 'K-Pop' 카테고리를 표시
        } catch (error) {
          console.error("Error initializing Supabase:", error);
          const cardContainer = document.getElementById("card-container");
          cardContainer.innerHTML = `<p>Supabase 초기화 중 오류가 발생했습니다: ${error.message}</p>`;
        }
      }

      // 모든 콘텐츠 데이터를 Supabase에서 가져오는 함수
      async function loadAllContents() {
        const cardContainer = document.getElementById("card-container");
        cardContainer.innerHTML = "<p>데이터를 불러오는 중입니다...</p>";
      }

      /**
       * 카테고리에 따라 allContents를 필터링하고 표시하는 함수
       * @param {string} category - 선택된 카테고리 ('k-pop', 'k-drama', 'k-webtoon', 'k-food', 'k-ent')
       */
      function filterByCategory(category) {
        let filteredContents;

        if (category === "k-drama") {
          filteredContents = allContents.filter(
            (content) =>
              content.category === "k-drama" || content.category === "k-movie"
          );
        } else {
          const filterCategory = category === "k-pop" ? "k-pop" : category;
          filteredContents = allContents.filter(
            (content) => content.category === filterCategory
          );
        }

        displayItems(filteredContents);
      }

      // 탭 버튼에 이벤트 리스너를 설정하는 함수
      function setupTabListeners() {
        const tabButtons = document.querySelectorAll(".tab-button");
        tabButtons.forEach((button) => {
          button.addEventListener("click", (event) => {
            const category = event.target.dataset.category;
            filterByCategory(category);
            tabButtons.forEach((btn) => btn.classList.remove("active"));
            event.target.classList.add("active");
          });
        });
      }

      // 주어진 아이템 목록을 화면에 카드 형태로 표시하는 함수
      function displayItems(contents) {
        const cardContainer = document.getElementById("card-container");
        cardContainer.innerHTML = "";

        if (!contents || contents.length === 0) {
          cardContainer.innerHTML = "<p>해당 카테고리의 데이터가 없습니다.</p>";
          return;
        }

        for (const content of contents) {
          // 현재 콘텐츠가 사용자가 좋아요 누른 목록에 있는지 확인
          const isLiked = userFavorites.has(content.id.toString());

          const locationCount = content.locationCount || 0;

          const card = document.createElement("div");
          card.classList.add("content-item-card");

          card.innerHTML = `
                <div class="image-container">
                  <img src="${content.imageUrl || ""}" alt="${
            content.name || "이미지 없음"
          }" onerror="this.outerHTML='<div class=\\'no-image\\'>이미지가 없습니다.</div>'">
                  <div class="badge">${content.category}</div>
                </div>
                <div class="content-container">
                  <h3>${content.name || "제목 없음"}</h3>
                  <p class="description">${
                    content.des || "설명이 없습니다."
                  }</p>
                  <div class="details">
                    <button class="details-button" data-content-id="${
                      content.id
                    }">자세히 보기</button>
                  </div>
                  <button class="like-button ${
                    isLiked ? "liked" : ""
                  }" data-content-id="${content.id}">${
            isLiked ? "♥" : "♡"
          }</button>
                </div>
              `;

          card
            .querySelector(".details-button")
            .addEventListener("click", (event) => {
              const contentId = event.target.dataset.contentId;
              openModal(contentId);
            });

          card
            .querySelector(".like-button")
            .addEventListener("click", async (event) => {
              event.stopPropagation(); // 이벤트 버블링 방지

              if (!getIsLoggedIn || !getIsLoggedIn()) {
                alert("로그인이 필요합니다.");
                return;
              }

              const likeButton = event.currentTarget;
              const contentId = likeButton.dataset.contentId; // contentGroup 테이블의 id
              const userId = getUserId();

              if (!userId) {
                alert("사용자 정보를 가져올 수 없습니다. 다시 로그인해주세요.");
                return;
              }

              if (likeButton.textContent === "♡") {
                // 좋아요 추가
                const { error } = await supabase.from("user_favorites").insert({
                  user_id: userId,
                  target_id: contentId,
                  target_type: "contents",
                });

                if (error) {
                  console.error("좋아요 추가 실패:", error);
                  alert("좋아요 처리에 실패했습니다.");
                } else {
                  likeButton.textContent = "♥";
                  likeButton.classList.add("liked");
                }
              } else {
                // 좋아요 취소
                const { error } = await supabase
                  .from("user_favorites")
                  .delete()
                  .eq("user_id", userId)
                  .eq("target_id", contentId);

                if (error) {
                  console.error("좋아요 취소 실패:", error);
                  alert("좋아요 취소에 실패했습니다.");
                } else {
                  likeButton.textContent = "♡";
                  likeButton.classList.remove("liked");
                }
              }
            });

          cardContainer.appendChild(card);
        }
      }

      // --- 모달을 열고 상세 정보를 표시하는 함수 ---
      async function openModal(contentId) {
        modal.style.display = "flex"; // 모달을 보이게 함
        modalBody.innerHTML = "<p>상세 정보를 불러오는 중입니다...</p>";

        // 어떤 모달이 열렸는지 sessionStorage에 저장
        sessionStorage.setItem("lastOpenModalId", contentId);

        try {
          const contentInfo = allContents.find((c) => c.id == contentId);
          // console.log("contentInfo:", contentInfo);
          if (!contentInfo) {
            throw new Error("콘텐츠 정보를 찾을 수 없습니다.");
          }

          // 미리 로드된 allLocations에서 현재 콘텐츠에 해당하는 장소 정보 필터링
          const relatedLocations = allLocations.filter(
            (loc) => loc.contentGroup === contentInfo.name
          );
          // console.log("relatedLocations:", relatedLocations);

          // --- 리뷰 데이터 가져오기 ---
          const relatedPlaceIds = relatedLocations
            .map((loc) => loc.placeId)
            .filter(Boolean);
          let reviews = [];
          if (relatedPlaceIds.length > 0) {
            const { data: reviewData, error: reviewError } = await supabase
              .from("reviews")
              .select("*")
              .in("location_id", relatedPlaceIds)
              .order("created_at", { ascending: false })
              .limit(10);

            if (reviewError) {
              console.error("리뷰를 불러오는 중 오류 발생:", reviewError);
            } else {
              reviews = reviewData;
            }
          }

          // --- 리뷰 HTML 생성 ---
          let reviewsHtml =
            '<p class="no-reviews">아직 작성된 리뷰가 없습니다.</p>';
          if (reviews && reviews.length > 0) {
            reviewsHtml = reviews
              .map((review) => createReviewItemHTML(review, relatedLocations))
              .join("");
          }
          // --- 리뷰 로직 끝 ---

          let html = `<img src="${contentInfo.imageUrl}" alt="${contentInfo.name}">`;
          html += `<h2>${contentInfo.name}</h2>`;
          html += "<hr><h3>관련 촬영지 정보</h3>";

          if (relatedLocations && relatedLocations.length > 0) {
            html += `
              <div class="swiper-container location-slider">
                <div class="swiper-wrapper">
            `;

            for (let i = 0; i < relatedLocations.length; i += 4) {
              html += '<div class="swiper-slide"><div class="location-grid">';
              const slideLocations = relatedLocations.slice(i, i + 4);

              slideLocations.forEach((loc) => {
                html += `
                  <div class="location-card">
                    <img src="${loc.imageUrl || ""}" alt="${
                  loc.name || "이미지 없음"
                }" onerror="this.outerHTML='<div class=\\'no-image\\'>이미지가 없습니다.</div>'">
                    <div class="location-card-content">
                      <h5>${loc.name || "이름 없음"}</h5>
                      <p class="address">${loc.location || "주소 정보 없음"}</p>
                      <p class="description">${
                        loc.explanation || "설명이 없습니다."
                      }</p>
                      <button class="location-details-button"
                              data-location-id="${loc.id}"
                              data-place-id="${
                                loc.placeId
                              }">자세히 보기</button>
                    </div>
                  </div>
                `;
              });

              html += "</div></div>"; // close grid and slide
            }

            html += `
                </div>
                <div class="swiper-controls">
                  <div class="swiper-button-prev"></div>
                  <div class="swiper-pagination"></div>
                  <div class="swiper-button-next"></div>
                </div>
              </div>
            `;
          } else {
            html += "<p>관련된 장소 정보가 없습니다.</p>";
          }

          // 리뷰 섹션 추가
          html += `
            <div class="reviews-section">
              <hr>
              <h3>리뷰</h3>
              <div class="reviews-container">${reviewsHtml}</div>
            </div>
          `;
          modalBody.innerHTML = html;

          new Swiper(".location-slider", {
            loop: false,
            spaceBetween: 20, // 슬라이드 사이의 간격을 20px로 설정합니다.
            pagination: {
              el: ".swiper-pagination",
              clickable: true,
            },
            navigation: {
              nextEl: ".swiper-button-next",
              prevEl: ".swiper-button-prev",
            },
          });

          document
            .querySelectorAll(".location-details-button")
            .forEach((button) => {
              button.addEventListener("click", (event) => {
                const placeId = event.currentTarget.dataset.placeId;
                // 상세 페이지로 placeId와 함께 이동
                window.location.href = `detail.html?placeId=${placeId}`;
              });
            });
        } catch (error) {
          modalBody.innerHTML = `<p>상세 정보를 불러오는 데 실패했습니다: ${error.message}</p>`;
        }
      }

      // 리뷰 아이템 HTML을 생성하는 헬퍼 함수
      function createReviewItemHTML(review, locations) {
        const reviewStarPercentage = (review.rating / 5) * 100;
        const reviewDate = new Date(review.created_at).toLocaleDateString();
        const reviewLocation = locations.find(
          (loc) => loc.placeId === review.location_id
        );
        const reviewLocationName = reviewLocation
          ? reviewLocation.name
          : "관련 장소";

        return `
          <div class="review-item">
            <div class="review-item-header">
              <span class="review-author">${review.display_name}</span>
              <div class="stars-outer"><div class="stars-inner" style="width: ${reviewStarPercentage}%;"></div></div>
              <span class="review-item-location-tag">${reviewLocationName}</span>
            </div>
            <p class="review-text">${review.comment}</p>
            ${
              review.review_image
                ? `<img src="${review.review_image}" alt="리뷰 이미지" class="review-image">`
                : ""
            }
            <span class="review-date">${reviewDate}</span>
          </div>
        `;
      }

      // --- 모달을 닫는 함수 ---
      function closeModal() {
        modal.style.display = "none";
        // 모달을 닫을 때 sessionStorage에서 ID 제거
        sessionStorage.removeItem("lastOpenModalId");
      }

      // ---모달 닫기 이벤트 리스너를 설정하는 함수 ---
      function setupModalListeners() {
        closeModalBtn.addEventListener("click", closeModal);

        window.addEventListener("click", (event) => {
          if (event.target == modal) {
            closeModal();
          }
        });
      }

      // --- 최근 방문 목록의 이벤트 리스너를 설정하는 함수 (이벤트 위임 사용) ---
      function setupRecentlyVisitedListeners() {
        const listContainer = document.getElementById("recently-visited-list");
        const clearAllBtn = document.querySelector(".clear-all-btn");
        const RECENTLY_VISITED_KEY = "recentlyVisited";

        // 개별 삭제 버튼 이벤트 리스너 (이벤트 위임)
        listContainer.addEventListener("click", (event) => {
          const deleteButton = event.target.closest(".recent-item-delete-btn");
          if (!deleteButton) return;

          event.preventDefault(); // a 태그의 링크 이동 방지
          event.stopPropagation(); // 이벤트 버블링 방지

          const placeIdToDelete = parseInt(deleteButton.dataset.placeId, 10);
          let currentList =
            JSON.parse(localStorage.getItem(RECENTLY_VISITED_KEY)) || [];
          currentList = currentList.filter(
            (item) => item.placeId !== placeIdToDelete
          );
          localStorage.setItem(
            RECENTLY_VISITED_KEY,
            JSON.stringify(currentList)
          );
          renderRecentlyVisited(); // 목록 다시 렌더링
        });

        // 전체 삭제 버튼 이벤트 리스너
        clearAllBtn.addEventListener("click", () => {
          const isConfirmed = confirm(
            "정말로 모든 방문 기록을 삭제하시겠습니까?"
          );
          if (isConfirmed) {
            localStorage.removeItem(RECENTLY_VISITED_KEY);
            renderRecentlyVisited(); // 목록 다시 렌더링
          }
        });
      }

      // --- 최근 방문 목록을 렌더링하는 함수 ---
      function renderRecentlyVisited() {
        const listContainer = document.getElementById("recently-visited-list");
        const clearAllBtn = document.querySelector(".clear-all-btn");
        const RECENTLY_VISITED_KEY = "recentlyVisited";

        const recentlyVisited =
          JSON.parse(localStorage.getItem(RECENTLY_VISITED_KEY)) || [];

        listContainer.innerHTML = ""; // 목록 초기화

        if (recentlyVisited.length === 0) {
          listContainer.innerHTML = "<p>최근 방문한 장소가 없습니다.</p>";
          clearAllBtn.style.display = "none";
          return;
        }

        clearAllBtn.style.display = "block";

        recentlyVisited.forEach((item) => {
          const cardLink = document.createElement("a");
          cardLink.href = `detail.html?placeId=${item.placeId}`;
          cardLink.className = "recent-item-card";
          cardLink.innerHTML = `
            <img src="${item.imageUrl}" alt="${item.placeName}" onerror="this.style.display='none'">
            <p>${item.placeName}</p>
            <button class="recent-item-delete-btn" data-place-id="${item.placeId}">×</button>
          `;
          listContainer.appendChild(cardLink);
        });
      }

      initSupabase();
    </script>
  </body>
</html>