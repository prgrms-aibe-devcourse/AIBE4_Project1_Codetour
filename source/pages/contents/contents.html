<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>K-Spot - í•œë¥˜ ì½˜í…ì¸  ì—¬í–‰ í”Œë«í¼</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="contentstyle.css" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/swiper/swiper-bundle.min.css"
    />
    <script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>
    <style>
      .header-search-wrap {
        overflow: hidden;
        height: 0;
        transition: height 220ms ease;
        background: #fff;
        border-bottom: 1px solid #eee;
      }
      .header-search-inner {
        max-width: 1200px;
        margin: 0 auto;
        padding: 12px 16px;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .header-search-input {
        flex: 1;
        height: 44px;
        padding: 0 12px;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        font-size: 15px;
      }
      .header-search-btn,
      .header-search-close {
        height: 44px;
        padding: 0 14px;
        border-radius: 10px;
        border: 1px solid #bcd0c7;
        background: #0f5132;
        color: #fff;
        font-weight: 700;
        cursor: pointer;
      }
      .header-search-close {
        background: #fff;
        color: #0f5132;
      }

      .header-search-results,
      .header-content-suggest {
        max-width: 1200px;
        margin: 6px auto 12px;
        padding: 0 16px;
      }
      .search-empty {
        color: #6b7280;
        font-size: 14px;
        padding: 6px 2px;
      }
      .search-item {
        padding: 10px 12px;
        border: 1px solid #eee;
        border-radius: 10px;
        margin-bottom: 8px;
        cursor: pointer;
        background: #fff;
      }
      .search-item:hover {
        background: #f9fbfa;
      }

      .content-suggest-title {
        margin: 10px 2px 8px;
        font-weight: 800;
      }
    </style>
  </head>
  <body>
    <header class="header">
      <div class="container">
        <div class="header-top">
          <a href="/source/pages/index/index.html" class="logo">
            <svg
              width="200"
              height="50"
              viewBox="0 0 200 50"
              xmlns="http://www.w3.org/2000/svg"
            >
              <defs>
                <linearGradient
                  id="logoGradient"
                  x1="0%"
                  y1="0%"
                  x2="100%"
                  y2="0%"
                >
                  <stop
                    offset="0%"
                    style="stop-color: #e91e8c; stop-opacity: 1"
                  />
                  <stop
                    offset="100%"
                    style="stop-color: #ff6b9d; stop-opacity: 1"
                  />
                </linearGradient>
                <style>
                  .logo-text {
                    font-family: "Pretendard", sans-serif;
                    font-weight: 800;
                    font-size: 40px;
                    fill: url(#logoGradient);
                    letter-spacing: -1px;
                  }
                </style>
              </defs>
              <text x="0" y="37" class="logo-text">K</text>
              <text x="30" y="37" class="logo-text">-</text>
              <text x="44" y="37" class="logo-text">S</text>
              <text x="70" y="37" class="logo-text">P</text>
              <g class="logo-pin" transform="translate(95.5, 4) scale(0.93)">
                <path
                  d="M18 0C10 0 4 6 4 13c0 10 14 26 14 26s14-16 14-26c0-7-6-13-14-13z"
                  fill="url(#logoGradient)"
                />
                <circle cx="18" cy="13" r="8" fill="white" />
              </g>
              <text x="128" y="37" class="logo-text">T</text>
            </svg>
          </a>

          <div
            class="header-right"
            style="display: flex; gap: 8px; align-items: center"
          >
            <button class="btn-search" id="searchToggle">ğŸ”</button>

            <span id="greeting" class="hide"
              >ì•ˆë…•í•˜ì„¸ìš”, <span id="nickname"></span>ë‹˜</span
            >
            <button id="loginBtn">ë¡œê·¸ì¸</button>
            <button id="logoutBtn" class="hide">ë¡œê·¸ì•„ì›ƒ</button>
          </div>
        </div>

        <nav class="nav">
          <a href="/source/pages/index/index.html" class="nav-link">í™ˆ</a>
          <a href="/source/pages/contents/contents.html" class="nav-link active">ì½˜í…ì¸ ë³„ ì—¬í–‰ì§€</a>
          <a href="/source/pages/aiCourse/aiSchedule.html" class="nav-link">AI ì½”ìŠ¤ ì¶”ì²œ</a>
          <a href="/source/pages/map/map_page.html" class="nav-link">K-ì½˜í…ì¸  ì—¬í–‰ ì§€ë„</a>
          <a href="/source/pages/index/index.html#routes" class="nav-link">ì¸ê¸° ì—¬í–‰ ë£¨íŠ¸</a>
          <a href="/my-page" class="nav-link">ë§ˆì´í˜ì´ì§€</a>
        </nav>
    </header>

    <main>
      <section class="recently-visited-section">
        <div class="recently-visited-header">
          <h2>ìµœê·¼ ë°©ë¬¸í•œ ì¥ì†Œ</h2>
          <button class="clear-all-btn">ì „ì²´ ì‚­ì œ</button>
        </div>
        <div class="recently-visited-list" id="recently-visited-list">
          <!-- ìµœê·¼ ë°©ë¬¸ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì‚½ì…ë©ë‹ˆë‹¤. -->
        </div>
      </section>

      <div class="main-header">
        <h1>ì½˜í…ì¸ ë³„ ì—¬í–‰ì§€</h1>
        <p>ì¢‹ì•„í•˜ëŠ” ë“œë¼ë§ˆ, ì˜í™”, ì˜ˆëŠ¥ì˜ ì´¬ì˜ì§€ë¥¼ ì°¾ì•„ë³´ì„¸ìš”</p>
      </div>

      <div class="tab-menu">
        <button class="tab-button active" data-category="k-pop">K-Pop</button>
        <button class="tab-button" data-category="k-drama">
          K-Drama/Movie
        </button>
        <button class="tab-button" data-category="k-webtoon">K-Webtoon</button>
        <button class="tab-button" data-category="k-food">K-Food</button>
        <button class="tab-button" data-category="k-ent">K-Ent</button>
      </div>

      <div class="card-container" id="card-container"></div>
    </main>

    <footer>
      <p>&copy; Kspot</p>
    </footer>

    <script>
      // auth.jsì—ì„œ ì‚¬ìš©í•  ê²½ë¡œ ì„¤ì •
      window.AUTH_PATHS = {
        INDEX: "/source/pages/index/index.html",
        SET_NICK: "/auth/set-nickname.html",
      };
    </script>
    <script type="module" src="/public/auth/auth.js"></script>

    <!-- í—¤ë” ì¸ë¼ì¸ ê²€ìƒ‰ ìŠ¤í¬ë¦½íŠ¸ (index.htmlê³¼ ë™ì¼) -->
    <script type="module">
      const header = document.querySelector(".header");
      const wrap = document.getElementById("headerSearchWrap");
      const input = document.getElementById("searchInput");
      const btnToggle = document.getElementById("searchToggle");
      const btnClose = document.getElementById("searchClose");
      const btnDo = document.getElementById("searchDo");
      const results = document.getElementById("searchResults");

      const suggestTitle = document.getElementById("contentSuggestTitle");
      const suggestRail = document.getElementById("contentSuggestRail");

      function setWrapHeight(open) {
        if (open) {
          wrap.style.height = wrap.scrollHeight + "px";
          header.classList.add("header--search-open");
        } else {
          wrap.style.height = "0px";
          header.classList.remove("header--search-open");
        }
      }
      function openSearch() {
        results.innerHTML = "";
        clearRail();
        input.value = "";
        setWrapHeight(true);
        setTimeout(() => input.focus(), 0);
        ensureContentsLoaded();
      }
      function closeSearch() {
        setWrapHeight(false);
      }
      function toggleSearch() {
        const isOpen = wrap.style.height && wrap.style.height !== "0px";
        isOpen ? closeSearch() : openSearch();
      }
      btnToggle?.addEventListener("click", toggleSearch);
      btnClose?.addEventListener("click", closeSearch);
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") closeSearch();
      });
      window.addEventListener("resize", () => {
        if (wrap.style.height && wrap.style.height !== "0px") {
          wrap.style.height = "auto";
          const h = wrap.scrollHeight;
          wrap.style.height = h + "px";
        }
      });

      function tryTeamRenderer(items) {
        if (window.ContentCards?.render) {
          window.ContentCards.render(suggestRail, items);
          return true;
        }
        if (typeof window.renderContentCards === "function") {
          window.renderContentCards("contentSuggestRail", items);
          return true;
        }
        if (window.CardFactory?.render) {
          window.CardFactory.render(suggestRail, items);
          return true;
        }
        if (typeof window.buildCards === "function") {
          window.buildCards(suggestRail, items);
          return true;
        }
        return false;
      }
      function fallbackRender(items) {
        suggestRail.innerHTML = items
          .map(
            (it) => `
          <div class="search-item" style="min-width:220px;">
            <div style="font-weight:700;">${it.title}</div>
            <div style="color:#666;font-size:13px;margin-top:2px;">${
              it.subtitle ?? ""
            }</div>
          </div>
        `
          )
          .join("");
      }
      function renderRail(items) {
        suggestTitle.style.display = items?.length ? "" : "none";
        suggestRail.innerHTML = "";
        if (!items?.length) return;
        const ok = tryTeamRenderer(items);
        if (!ok) fallbackRender(items);
        if (wrap.style.height && wrap.style.height !== "0px") {
          wrap.style.height = "auto";
          const h = wrap.scrollHeight;
          wrap.style.height = h + "px";
        }
      }
      function clearRail() {
        suggestTitle.style.display = "none";
        suggestRail.innerHTML = "";
      }

      async function ensureContentsLoaded() {
        if (allContents) return;
        try {
          const res = await fetch("/api/contents");
          if (!res.ok) throw new Error("contents load failed");
          const data = await res.json(); // [{ contents, name, ... }]
          const unique = [
            ...new Set(
              (data || []).map((d) => (d.contents || "").trim()).filter(Boolean)
            ),
          ];
          const countByContent = unique.map((c) => ({
            content: c,
            count: (data || []).filter((d) => (d.contents || "").trim() === c)
              .length,
          }));
          allContents = countByContent;
        } catch (e) {
          console.error("Failed to load contents:", e);
          allContents = [];
        }
      }
      function rankScore(q, name) {
        const a = (q || "").toLowerCase();
        const b = (name || "").toLowerCase();
        if (!a || !b) return 0;
        if (b === a) return 100;
        if (b.startsWith(a)) return 80;
        if (b.includes(a)) return 60;
        let lcs = 0;
        for (let i = 0; i < a.length; i++) {
          for (let j = i + 1; j <= a.length; j++) {
            if (b.includes(a.slice(i, j))) lcs = Math.max(lcs, j - i);
          }
        }
        return lcs;
      }
    </script>

    <div id="modal" class="modal">
      <div class="modal-content">
        <span class="modal-close">&times;</span>
        <div id="modal-body"></div>
      </div>
    </div>

    <script type="module">
      let supabase;
      let allContents = []; // ëª¨ë“  ì½˜í…ì¸ ë¥¼ ì €ì¥í•  ë°°ì—´
      let allLocations = []; // ëª¨ë“  ì¥ì†Œ ì •ë³´ë¥¼ ì €ì¥í•  ë°°ì—´

      // --- ëª¨ë‹¬ ê´€ë ¨ DOM ìš”ì†Œ ê°€ì ¸ì˜¤ê¸° ---
      const modal = document.getElementById("modal");
      const modalBody = document.getElementById("modal-body");
      const closeModalBtn = document.querySelector(".modal-close");

      // Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
      async function initSupabase() {
        try {
          const response = await fetch("http://localhost:3000/api/config");
          if (!response.ok) throw new Error("Failed to fetch Supabase config");
          const config = await response.json();
          supabase = window.supabase.createClient(
            config.supabaseUrl,
            config.supabaseKey
          );
          await loadAllContents(); // ëª¨ë“  ì½˜í…ì¸  ë¡œë“œ
          setupTabListeners(); // íƒ­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •

          // --- ëª¨ë‹¬ ë‹«ê¸° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ---
          setupModalListeners();
          setupRecentlyVisitedListeners(); // ìµœê·¼ ë°©ë¬¸ ëª©ë¡ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
          renderRecentlyVisited(); // ìµœê·¼ ë°©ë¬¸ ëª©ë¡ ë Œë”ë§
          // contentGroup í…Œì´ë¸”ì˜ ëª¨ë“  ë°ì´í„°ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
          const { data: contentGroup, error: groupError } = await supabase
            .from("contentGroup")
            .select("*");

          const { data: contentsData, error: contentsError } = await supabase
            .from("contents")
            .select("*");

          if (groupError) {
            throw groupError;
          }

          // 2. ê° contentGroupì— ëŒ€í•´ location ê°œìˆ˜ë¥¼ ì¡°íšŒí•˜ì—¬ ì¶”ê°€í•©ë‹ˆë‹¤.
          const contentsWithCount = [];
          for (const content of contentGroup) {
            const id = content.id;

            let count = 0;
            // idê°€ ìœ íš¨í•œ ê²½ìš°ì—ë§Œ location ê°œìˆ˜ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤.
            if (id) {
              const { count: locationCount, error: countError } = await supabase
                .from("location")
                .select("*", { count: "exact", head: true })
                .eq("placeId", id);
              if (!countError) {
                count = locationCount;
              }
            }
            contentsWithCount.push({
              ...content,
              locationCount: count,
            });
          }

          allContents = contentsWithCount;
          allLocations = contentsData; // ê°€ì ¸ì˜¨ ì¥ì†Œ ì •ë³´ë¥¼ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥

          // í˜ì´ì§€ ë¡œë“œ ì‹œ sessionStorageì— ì €ì¥ëœ ëª¨ë‹¬ì´ ìˆëŠ”ì§€ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì—½ë‹ˆë‹¤.
          // ì´ ìœ„ì¹˜ì—ì„œ í˜¸ì¶œí•´ì•¼ allContentsì™€ allLocations ë°ì´í„°ê°€ ë³´ì¥ë©ë‹ˆë‹¤.
          const lastOpenModalId = sessionStorage.getItem("lastOpenModalId");
          if (lastOpenModalId) {
            openModal(lastOpenModalId);
          }

          filterByCategory("k-pop"); // ì²˜ìŒì—ëŠ” 'K-Pop' ì¹´í…Œê³ ë¦¬ë¥¼ í‘œì‹œ


        } catch (error) {
          console.error("Error initializing Supabase:", error);
          const cardContainer = document.getElementById("card-container");
          cardContainer.innerHTML = `<p>Supabase ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}</p>`;
        }
      }

      // ëª¨ë“  ì½˜í…ì¸  ë°ì´í„°ë¥¼ Supabaseì—ì„œ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
      async function loadAllContents() {
        const cardContainer = document.getElementById("card-container");
        cardContainer.innerHTML = "<p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>";
      }

      /**
       * ì¹´í…Œê³ ë¦¬ì— ë”°ë¼ allContentsë¥¼ í•„í„°ë§í•˜ê³  í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
       * @param {string} category - ì„ íƒëœ ì¹´í…Œê³ ë¦¬ ('k-pop', 'k-drama', 'k-webtoon', 'k-food', 'k-ent')
       */
      function filterByCategory(category) {
        let filteredContents;

        if (category === "k-drama") {
          filteredContents = allContents.filter(
            (content) =>
              content.category === "k-drama" || content.category === "k-movie"
          );
        } else {
          const filterCategory = category === "k-pop" ? "k-pop" : category;
          filteredContents = allContents.filter(
            (content) => content.category === filterCategory
          );
        }

        displayItems(filteredContents);
      }

      // íƒ­ ë²„íŠ¼ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì„¤ì •í•˜ëŠ” í•¨ìˆ˜
      function setupTabListeners() {
        const tabButtons = document.querySelectorAll(".tab-button");
        tabButtons.forEach((button) => {
          button.addEventListener("click", (event) => {
            const category = event.target.dataset.category;
            filterByCategory(category);
            tabButtons.forEach((btn) => btn.classList.remove("active"));
            event.target.classList.add("active");
          });
        });
      }

      // ì£¼ì–´ì§„ ì•„ì´í…œ ëª©ë¡ì„ í™”ë©´ì— ì¹´ë“œ í˜•íƒœë¡œ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
      function displayItems(contents) {
        const cardContainer = document.getElementById("card-container");
        cardContainer.innerHTML = "";

        if (!contents || contents.length === 0) {
          cardContainer.innerHTML = "<p>í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
          return;
        }

        for (const content of contents) {
          const locationCount = content.locationCount || 0;

          const card = document.createElement("div");
          card.classList.add("card");

          card.innerHTML = `
                <div class="image-container">
                  <img src="${content.imageUrl || ""}" alt="${
            content.name || "ì´ë¯¸ì§€ ì—†ìŒ"
          }" onerror="this.outerHTML='<div class=\\'no-image\\'>ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'">
                  <div class="badge">${content.category}</div>
                </div>
                <div class="content-container">
                  <h3>${content.name || "ì œëª© ì—†ìŒ"}</h3>
                  <p class="description">${
                    content.des || "ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤."
                  }</p>
                  <div class="details">
                    <button class="details-button" data-content-id="${
                      content.id
                    }">ìì„¸íˆ ë³´ê¸°</button>
                  </div>
                  <button class="like-button" data-content-id="${
                    content.id
                  }">â™¡</button>
                </div>
              `;

          card
            .querySelector(".details-button")
            .addEventListener("click", (event) => {
              const contentId = event.target.dataset.contentId;
              openModal(contentId);
            });

          card.querySelector(".like-button").addEventListener("click", (event) => {
            event.stopPropagation(); // ì´ë²¤íŠ¸ ë²„ë¸”ë§ ë°©ì§€
            const likeButton = event.currentTarget;
            if (likeButton.textContent === "â™¡") {
              likeButton.textContent = "â™¥";
              likeButton.classList.add("liked");
            } else {
              likeButton.textContent = "â™¡";
              likeButton.classList.remove("liked");
            }
          });

          cardContainer.appendChild(card);
        }
      }

      // --- ëª¨ë‹¬ì„ ì—´ê³  ìƒì„¸ ì •ë³´ë¥¼ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜ ---
      async function openModal(contentId) {
        modal.style.display = "flex"; // ëª¨ë‹¬ì„ ë³´ì´ê²Œ í•¨
        modalBody.innerHTML = "<p>ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>";

        // ì–´ë–¤ ëª¨ë‹¬ì´ ì—´ë ¸ëŠ”ì§€ sessionStorageì— ì €ì¥
        sessionStorage.setItem("lastOpenModalId", contentId);

        try {
          const contentInfo = allContents.find((c) => c.id == contentId);
          // console.log("contentInfo:", contentInfo);
          if (!contentInfo) {
            throw new Error("ì½˜í…ì¸  ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          }

          // ë¯¸ë¦¬ ë¡œë“œëœ allLocationsì—ì„œ í˜„ì¬ ì½˜í…ì¸ ì— í•´ë‹¹í•˜ëŠ” ì¥ì†Œ ì •ë³´ í•„í„°ë§
          const relatedLocations = allLocations.filter(
            (loc) => loc.contentGroup === contentInfo.name
          );
          // console.log("relatedLocations:", relatedLocations);

          let html = `<img src="${contentInfo.imageUrl}" alt="${contentInfo.name}">`;
          html += `<h2>${contentInfo.name}</h2>`;
          html += "<hr><h3>ê´€ë ¨ ì´¬ì˜ì§€ ì •ë³´</h3>";

          if (relatedLocations && relatedLocations.length > 0) {
            html += `
              <div class="swiper-container location-slider">
                <div class="swiper-wrapper">
            `;

            for (let i = 0; i < relatedLocations.length; i += 4) {
              html += '<div class="swiper-slide"><div class="location-grid">';
              const slideLocations = relatedLocations.slice(i, i + 4);

              slideLocations.forEach((loc) => {
                html += `
                  <div class="location-card">
                    <img src="${loc.imageUrl || ""}" alt="${
                  loc.name || "ì´ë¯¸ì§€ ì—†ìŒ"
                }" onerror="this.outerHTML='<div class=\\'no-image\\'>ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'">
                    <div class="location-card-content">
                      <h5>${loc.name || "ì´ë¦„ ì—†ìŒ"}</h5>
                      <p class="address">${loc.location || "ì£¼ì†Œ ì •ë³´ ì—†ìŒ"}</p>
                      <p class="description">${
                        loc.explanation || "ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤."
                      }</p>
                      <button class="location-details-button"
                              data-location-id="${loc.id}"
                              data-place-id="${
                                loc.placeId
                              }">ìì„¸íˆ ë³´ê¸°</button>
                    </div>
                  </div>
                `;
              });

              html += "</div></div>"; // close grid and slide
            }

            html += `
                </div>
                <div class="swiper-controls">
                  <div class="swiper-button-prev"></div>
                  <div class="swiper-pagination"></div>
                  <div class="swiper-button-next"></div>
                </div>
              </div>
            `;
          } else {
            html += "<p>ê´€ë ¨ëœ ì¥ì†Œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
          }

          // ë¦¬ë·° ì„¹ì…˜ ì¶”ê°€
          html += `
            <div class="reviews-section">
              <hr>
              <h3>ë¦¬ë·°</h3>
              <div class="reviews-container">
                <p>ì•„ì§ ì‘ì„±ëœ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
              </div>
            </div>
          `;
          modalBody.innerHTML = html;

          new Swiper(".location-slider", {
            loop: false,
            pagination: {
              el: ".swiper-pagination",
              clickable: true,
            },
            navigation: {
              nextEl: ".swiper-button-next",
              prevEl: ".swiper-button-prev",
            },
          });

          document
            .querySelectorAll(".location-details-button")
            .forEach((button) => {
              button.addEventListener("click", (event) => {
                const placeId = event.currentTarget.dataset.placeId;
                // ìƒì„¸ í˜ì´ì§€ë¡œ placeIdì™€ í•¨ê»˜ ì´ë™
                window.location.href = `detail.html?placeId=${placeId}`;
              });
            });
        } catch (error) {
          modalBody.innerHTML = `<p>ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}</p>`;
        }
      }

      // --- ëª¨ë‹¬ì„ ë‹«ëŠ” í•¨ìˆ˜ ---
      function closeModal() {
        modal.style.display = "none";
        // ëª¨ë‹¬ì„ ë‹«ì„ ë•Œ sessionStorageì—ì„œ ID ì œê±°
        sessionStorage.removeItem("lastOpenModalId");
      }

      // ---ëª¨ë‹¬ ë‹«ê¸° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì„¤ì •í•˜ëŠ” í•¨ìˆ˜ ---
      function setupModalListeners() {
        closeModalBtn.addEventListener("click", closeModal);

        window.addEventListener("click", (event) => {
          if (event.target == modal) {
            closeModal();
          }
        });
      }

      // --- ìµœê·¼ ë°©ë¬¸ ëª©ë¡ì˜ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì„¤ì •í•˜ëŠ” í•¨ìˆ˜ (ì´ë²¤íŠ¸ ìœ„ì„ ì‚¬ìš©) ---
      function setupRecentlyVisitedListeners() {
        const listContainer = document.getElementById("recently-visited-list");
        const clearAllBtn = document.querySelector(".clear-all-btn");
        const RECENTLY_VISITED_KEY = "recentlyVisited";

        // ê°œë³„ ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ì´ë²¤íŠ¸ ìœ„ì„)
        listContainer.addEventListener("click", (event) => {
          const deleteButton = event.target.closest(".recent-item-delete-btn");
          if (!deleteButton) return;

          event.preventDefault(); // a íƒœê·¸ì˜ ë§í¬ ì´ë™ ë°©ì§€
          event.stopPropagation(); // ì´ë²¤íŠ¸ ë²„ë¸”ë§ ë°©ì§€

          const placeIdToDelete = parseInt(deleteButton.dataset.placeId, 10);
          let currentList =
            JSON.parse(localStorage.getItem(RECENTLY_VISITED_KEY)) || [];
          currentList = currentList.filter(
            (item) => item.placeId !== placeIdToDelete
          );
          localStorage.setItem(
            RECENTLY_VISITED_KEY,
            JSON.stringify(currentList)
          );
          renderRecentlyVisited(); // ëª©ë¡ ë‹¤ì‹œ ë Œë”ë§
        });

        // ì „ì²´ ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        clearAllBtn.addEventListener("click", () => {
          const isConfirmed = confirm(
            "ì •ë§ë¡œ ëª¨ë“  ë°©ë¬¸ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?"
          );
          if (isConfirmed) {
            localStorage.removeItem(RECENTLY_VISITED_KEY);
            renderRecentlyVisited(); // ëª©ë¡ ë‹¤ì‹œ ë Œë”ë§
          }
        });
      }

      // --- ìµœê·¼ ë°©ë¬¸ ëª©ë¡ì„ ë Œë”ë§í•˜ëŠ” í•¨ìˆ˜ ---
      function renderRecentlyVisited() {
        const listContainer = document.getElementById("recently-visited-list");
        const clearAllBtn = document.querySelector(".clear-all-btn");
        const RECENTLY_VISITED_KEY = "recentlyVisited";

        const recentlyVisited =
          JSON.parse(localStorage.getItem(RECENTLY_VISITED_KEY)) || [];

        listContainer.innerHTML = ""; // ëª©ë¡ ì´ˆê¸°í™”

        if (recentlyVisited.length === 0) {
          listContainer.innerHTML = "<p>ìµœê·¼ ë°©ë¬¸í•œ ì¥ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
          clearAllBtn.style.display = "none";
          return;
        }

        clearAllBtn.style.display = "block";

        recentlyVisited.forEach((item) => {
          const cardLink = document.createElement("a");
          cardLink.href = `detail.html?placeId=${item.placeId}`;
          cardLink.className = "recent-item-card";
          cardLink.innerHTML = `
            <img src="${item.imageUrl}" alt="${item.placeName}" onerror="this.style.display='none'">
            <p>${item.placeName}</p>
            <button class="recent-item-delete-btn" data-place-id="${item.placeId}">Ã—</button>
          `;
          listContainer.appendChild(cardLink);
        });
      }

      initSupabase();
    </script>
  </body>
</html>
