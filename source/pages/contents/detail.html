<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ìƒì„¸ ì •ë³´ - CodeTour</title>
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <meta property="og:image" content="/og-image.jpg" />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:type" content="website" />
    <meta property="og:site_name" content="K-Spot" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="contentstyle.css" />
    <link rel="stylesheet" href="/source/pages/index/style.css" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/swiper/swiper-bundle.min.css"
    />
    <script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>
    <script
      type="text/javascript"
      src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=8d27848d8e0061837441313b57eba277&libraries=services&autoload=false"
    ></script>
    <script src="/libs/config.js"></script>
    <script src="/libs/nav-manager.js" type="module"></script>
  </head>
  <body>
    <div id="headerPlaceholder"></div>

    <main>
      <div id="detail-container" class="detail-page-container">
        <!-- ìƒì„¸ ì •ë³´ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì‚½ì…ë©ë‹ˆë‹¤. -->
      </div>
    </main>

    <footer>
      <p>&copy; Kspot</p>
    </footer>

    <script>
      // auth.jsì—ì„œ ì‚¬ìš©í•  ê²½ë¡œ ì„¤ì •
      window.AUTH_PATHS = {
        INDEX: "/source/pages/index/index.html",
        SET_NICK: "/auth/set-nickname.html",
      };
    </script>

    <script type="module">
      let supabase;

      // auth.jsê°€ ë¡œë“œëœ í›„ user-manager.jsì˜ í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
      let getIsLoggedIn;
      let getUserId;
      let getUserNickname;
      import("/libs/user-manager.js").then((module) => {
        getIsLoggedIn = module.getIsLoggedIn;
        getUserId = module.getUserId;
        getUserNickname = module.getUserNickname;
      });

      // Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
      async function initSupabase() {
        try {
          const response = await fetch(`${API_BASE_URL}/api/config`);
          if (!response.ok) throw new Error("Failed to fetch Supabase config");
          const config = await response.json();
          supabase = window.supabase.createClient(
            config.supabaseUrl,
            config.supabaseKey
          );
          await loadPlaceDetails(); // ì¥ì†Œ ìƒì„¸ ì •ë³´ ë¡œë“œ
        } catch (error) {
          console.error("Error initializing Supabase:", error);
          const detailContainer = document.getElementById("detail-container");
          detailContainer.innerHTML = `<p>ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}</p>`;
        }
      }

      // ì¢Œí‘œ ë¬¸ìì—´ì„ íŒŒì‹±í•˜ì—¬ ìœ„ë„, ê²½ë„ ê°ì²´ë¥¼ ë°˜í™˜í•˜ëŠ” í•¨ìˆ˜
      function parseCoordinates(coordStr) {
        if (!coordStr || typeof coordStr !== "string") return null;
        const parts = coordStr.split(",").map((s) => s.trim());
        if (parts.length !== 2) return null;

        const lat = parseFloat(parts[0].replace(/[N]/gi, ""));
        const lng = parseFloat(parts[1].replace(/[E]/gi, ""));
        return { lat, lng };
      }

      // URLì—ì„œ placeIdë¥¼ ê°€ì ¸ì™€ ìƒì„¸ ì •ë³´ë¥¼ ë¡œë“œí•˜ëŠ” í•¨ìˆ˜
      async function loadPlaceDetails() {
        const detailContainer = document.getElementById("detail-container");
        detailContainer.innerHTML = "<p>ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>";

        const urlParams = new URLSearchParams(window.location.search);
        const placeId = urlParams.get("placeId");

        if (!placeId) {
          detailContainer.innerHTML =
            "<p>ì¥ì†Œ IDê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. ì´ì „ í˜ì´ì§€ë¡œ ëŒì•„ê°€ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>";
          return;
        }

        // í˜„ì¬ ì‚¬ìš©ìì˜ ì´ ì¥ì†Œì— ëŒ€í•œ ì¢‹ì•„ìš” ìƒíƒœë¥¼ í™•ì¸í•©ë‹ˆë‹¤.
        let isLiked = false;
        const userId = getUserId ? getUserId() : null;
        if (userId) {
          const { data: favorite, error: favoriteError } = await supabase
            .from("user_favorites")
            .select("id")
            .eq("user_id", userId)
            .eq("target_id", placeId)
            .eq("target_type", "location")
            .maybeSingle(); // í•œ ê°œì˜ ê²°ê³¼ë§Œ ê°€ì ¸ì˜¤ê±°ë‚˜ nullì„ ë°˜í™˜

          if (favoriteError) {
            console.error("ì¢‹ì•„ìš” ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:", favoriteError);
          }
          if (favorite) isLiked = true;
        }

        try {
          // Promise.allì„ ì‚¬ìš©í•˜ì—¬ location ì •ë³´ì™€ images ì •ë³´ë¥¼ ë™ì‹œì— ê°€ì ¸ì˜µë‹ˆë‹¤.
          const [locationRes, imagesRes, reviewsRes] = await Promise.all([
            supabase.from("location").select("*").eq("placeId", placeId),
            supabase.from("images").select("imageUrl").eq("placeId", placeId),
            supabase.from("reviews").select("*").eq("location_id", placeId),
          ]);

          const { data: locations, error: locationError } = locationRes;
          const { data: images, error: imageError } = imagesRes;
          const { data: reviews, error: reviewError } = reviewsRes;
          if (locationError) throw locationError;
          if (imageError) throw imageError;
          if (reviewError) throw reviewError;

          console.log("locations:", locations);

          if (!locations || locations.length === 0) {
            detailContainer.innerHTML = "<p>ì¥ì†Œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>";
            return;
          }

          const mainLocation = locations[0];

          // --- ìµœê·¼ ë°©ë¬¸ ëª©ë¡ ì €ì¥ ë¡œì§ ---
          const RECENTLY_VISITED_KEY = "recentlyVisited";
          const MAX_ITEMS = 5;

          // 1. ê¸°ì¡´ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
          let recentlyVisited =
            JSON.parse(localStorage.getItem(RECENTLY_VISITED_KEY)) || [];

          // 2. í˜„ì¬ í•­ëª©ì´ ëª©ë¡ì— ìˆëŠ”ì§€ í™•ì¸í•˜ê³ , ìˆë‹¤ë©´ ì œê±°
          recentlyVisited = recentlyVisited.filter(
            (item) => item.placeId !== mainLocation.placeId
          );

          // 3. ìƒˆ í•­ëª©ì„ ë§¨ ì•ì— ì¶”ê°€
          recentlyVisited.unshift({
            placeId: mainLocation.placeId,
            placeName: mainLocation.placeName,
            imageUrl:
              mainLocation.imageUrl || (images[0] ? images[0].imageUrl : ""),
          });

          // 4. ëª©ë¡ ê¸¸ì´ë¥¼ 5ê°œë¡œ ì œí•œ
          if (recentlyVisited.length > MAX_ITEMS) {
            recentlyVisited.pop();
          }

          // 5. ìµœì¢… ëª©ë¡ì„ localStorageì— ì €ì¥
          localStorage.setItem(
            RECENTLY_VISITED_KEY,
            JSON.stringify(recentlyVisited)
          );

          let html = `
            <div class="detail-header">
              <h2>${mainLocation.placeName}</h2>
              <button class="like-button ${
                isLiked ? "liked" : ""
              }" data-place-id="${mainLocation.placeId}">${
            isLiked ? "â™¥" : "â™¡"
          }</button>
            </div>`;

          // ì´ë¯¸ì§€ ìŠ¬ë¼ì´ë” ë˜ëŠ” ë‹¨ì¼ ì´ë¯¸ì§€ í‘œì‹œ
          if (images && images.length > 1) {
            html += `
              <div class="swiper-container detail-image-slider">
                <div class="swiper-wrapper">
            `;
            images.forEach((img) => {
              html += `
                <div class="swiper-slide">
                  <img src="${img.imageUrl}" alt="${mainLocation.name} ì´ë¯¸ì§€">
                </div>
              `;
            });
            html += `
                </div>
                <div class="swiper-pagination"></div>
                <div class="swiper-button-prev"></div>
                <div class="swiper-button-next"></div>
              </div>
            `;
          } else if (images && images.length === 1) {
            html += `<img src="${images[0].imageUrl}" alt="${mainLocation.name}" style="width: 100%; height: 400px; object-fit: cover; border-radius: 8px; margin-bottom: 20px;">`;
          } else {
            html += `<div class='no-image' style='height: 400px;'>ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
          }

          // ìƒì„¸ ì •ë³´ í‘œì‹œ
          html += `<div class="detail-info-grid">`;
          html += `<p><strong>ì£¼ì†Œ:</strong> ${
            mainLocation.address || "ì •ë³´ ì—†ìŒ"
          }</p>`;
          html += `<p><strong>ì—°ë½ì²˜:</strong> ${
            mainLocation.tel || "ì •ë³´ ì—†ìŒ"
          }</p>`;
          html += `<p><strong>ì…ì¥ë£Œ:</strong> ${
            mainLocation.entranceFee || "ì •ë³´ ì—†ìŒ"
          }</p>`;
          html += `<p><strong>ìš´ì˜ ì‹œê°„:</strong> ${
            mainLocation.subDescription || "ì •ë³´ ì—†ìŒ"
          }</p>`;
          html += `<p class="full-width"><strong>ì„¤ëª…:</strong> ${
            mainLocation.description || "ì •ë³´ ì—†ìŒ"
          }</p>`;
          html += `</div>`;

          // ì§€ë„ ì„¹ì…˜ ì¶”ê°€
          html += `
            <div class="map-section">
              <h3>ìœ„ì¹˜ ì •ë³´</h3>
              <div id="map"></div>
            </div>
          `;

          // --- ë¦¬ë·° ì„¹ì…˜ ë™ì  ìƒì„± ---
          let reviewSummaryHtml = "";
          let reviewListHtml = "";

          if (reviews && reviews.length > 0) {
            // í‰ê·  í‰ì  ë° ë¦¬ë·° ìˆ˜ ê³„ì‚°
            const totalRating = reviews.reduce(
              (sum, review) => sum + review.rating,
              0
            );
            const averageRating = (totalRating / reviews.length).toFixed(1);
            const starPercentage = (averageRating / 5) * 100;

            reviewSummaryHtml = `
              <div class="review-summary">
                <span class="average-rating">${averageRating}</span>
                <div class="stars-outer">
                  <div class="stars-inner" style="width: ${starPercentage}%;"></div>
                </div>
                <span class="review-count">(${reviews.length}ê°œì˜ ë¦¬ë·°)</span>
              </div>
            `;

            // ë¦¬ë·° ëª©ë¡ ìƒì„±
            reviews.forEach((review) => {
              const reviewStarPercentage = (review.rating / 5) * 100;
              const reviewDate = new Date(
                review.created_at
              ).toLocaleDateString();
              reviewListHtml += `
                <div class="review-item">
                  <div class="review-item-header">
                    <span class="review-author">${review.display_name}</span>
                    <div class="stars-outer"><div class="stars-inner" style="width: ${reviewStarPercentage}%;"></div></div>
                  </div>
                  <p class="review-text">${review.comment}</p>
                  ${
                    review.review_image
                      ? `<img src="${review.review_image}" alt="ë¦¬ë·° ì´ë¯¸ì§€" class="review-image" style="width:120px; height:120px; object-fit:cover; border-radius:8px; margin:8px 0;">`
                      : ""
                  }
                  <span class="review-date">${reviewDate}</span>
                </div>`;
            });
          } else {
            reviewListHtml =
              "<p>ì•„ì§ ì‘ì„±ëœ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤. ì²« ë¦¬ë·°ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”!</p>";
          }

          // ìœ ì € í‰ì  ë° ë¦¬ë·° ì„¹ì…˜ ì¶”ê°€
          html += `
            <div class="reviews-section">
              <h3>ìœ ì € ë¦¬ë·° ë° í‰ì </h3>
              ${reviewSummaryHtml}
              <div class="review-list">${reviewListHtml}</div>

              <!-- ë¦¬ë·° ì‘ì„± í¼ -->
              <div class="review-form-container">
                <h4>ë¦¬ë·° ì‘ì„±í•˜ê¸°</h4>
                <form id="review-form">
                  <div class="rating-stars">
                    <input type="radio" name="rating" id="rating-5" value="5"><label for="rating-5">â˜…</label>
                    <input type="radio" name="rating" id="rating-4" value="4"><label for="rating-4">â˜…</label>
                    <input type="radio" name="rating" id="rating-3" value="3"><label for="rating-3">â˜…</label>
                    <input type="radio" name="rating" id="rating-2" value="2"><label for="rating-2">â˜…</label>
                    <input type="radio" name="rating" id="rating-1" value="1"><label for="rating-1">â˜…</label>
                  </div>
                  <textarea id="review-text" placeholder="ì´ ì¥ì†Œì— ëŒ€í•œ ê²½í—˜ì„ ê³µìœ í•´ì£¼ì„¸ìš”." required></textarea>
                  <!-- ì´ë¯¸ì§€ ì—…ë¡œë“œ UI ì¶”ê°€ -->
                  <div class="image-upload-container" id="review-image-upload-container">
                    <img id="review-image-preview" src="#" alt="ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°" style="display:none;"/>
                    <button type="button" id="remove-image-btn" style="display:none;">&times;</button>
                    <label for="review-image-upload" class="upload-label">
                      <span>ğŸ“· ì´ë¯¸ì§€ ì¶”ê°€</span>
                    </label>
                  </div>
                  <input type="file" id="review-image-upload" accept="image/*" style="display:none;">
                  <button type="submit" class="details-button">ë¦¬ë·° ë“±ë¡</button>
                </form>
              </div>
            </div>
          `;

          detailContainer.innerHTML = html;

          // ì´ë¯¸ì§€ ì—…ë¡œë“œ ë¯¸ë¦¬ë³´ê¸° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
          const imageUploadInput = document.getElementById(
            "review-image-upload"
          );
          const imagePreview = document.getElementById("review-image-preview");
          const removeImageBtn = document.getElementById("remove-image-btn");
          const uploadLabel = document.querySelector(".upload-label");

          if (imageUploadInput && imagePreview) {
            // ì´ë¯¸ì§€ ì„ íƒ ì‹œ ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
            imageUploadInput.addEventListener("change", (event) => {
              const file = event.target.files[0];
              if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                  imagePreview.src = e.target.result;
                  imagePreview.style.display = "block";
                  removeImageBtn.style.display = "flex";
                  uploadLabel.style.display = "none";
                };
                reader.readAsDataURL(file);
              }
            });

            // ì´ë¯¸ì§€ ì œê±° ë²„íŠ¼ í´ë¦­ ì‹œ
            removeImageBtn.addEventListener("click", () => {
              // 1. íŒŒì¼ ì…ë ¥ ê°’ ì´ˆê¸°í™”
              // ê°™ì€ íŒŒì¼ì„ ë‹¤ì‹œ ì„ íƒí•  ìˆ˜ ìˆë„ë¡ valueë¥¼ ë¹„ì›Œì¤ë‹ˆë‹¤.
              imageUploadInput.value = "";

              // 2. ë¯¸ë¦¬ë³´ê¸° ì´ë¯¸ì§€ ìˆ¨ê¸°ê¸°
              imagePreview.src = "#";
              imagePreview.style.display = "none";

              // 3. ì œê±° ë²„íŠ¼ ìˆ¨ê¸°ê¸°
              removeImageBtn.style.display = "none";

              // 4. 'ì´ë¯¸ì§€ ì¶”ê°€' ë¼ë²¨ ë‹¤ì‹œ ë³´ì´ê¸°
              uploadLabel.style.display = "flex";
            });
          }

          // ë¦¬ë·° í¼ ì œì¶œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
          const reviewForm = document.getElementById("review-form");
          if (reviewForm) {
            reviewForm.addEventListener("submit", async (e) => {
              e.preventDefault();

              // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
              if (!getIsLoggedIn || !getIsLoggedIn()) {
                alert("ë¦¬ë·°ë¥¼ ë“±ë¡í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                return;
              }

              const userId = getUserId();
              const userNickname = getUserNickname();
              if (!userId || !userNickname) {
                alert("ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
                return;
              }

              const reviewText = document.getElementById("review-text").value;
              const rating = reviewForm.querySelector(
                'input[name="rating"]:checked'
              );

              if (!rating) {
                alert("í‰ì ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
              }

              if (!reviewText.trim()) {
                alert("ë¦¬ë·° ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
              }

              try {
                let reviewImageUrl = null;
                const imageFile = document.getElementById("review-image-upload")
                  .files[0];

                // ì´ë¯¸ì§€ê°€ ì„ íƒëœ ê²½ìš° Supabase Storageì— ì—…ë¡œë“œ
                if (imageFile) {
                  const bucketName = "review-images"; // Supabaseì— ìƒì„±ëœ ë²„í‚· ì´ë¦„
                  const fileName = `${userId}/${Date.now()}-${imageFile.name}`;

                  const { error: uploadError } = await supabase.storage
                    .from(bucketName)
                    .upload(fileName, imageFile);

                  if (uploadError) {
                    throw new Error(
                      `ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨: ${uploadError.message}`
                    );
                  }

                  // ì—…ë¡œë“œëœ ì´ë¯¸ì§€ì˜ ê³µê°œ URL ê°€ì ¸ì˜¤ê¸°
                  const { data: publicUrlData } = supabase.storage
                    .from(bucketName)
                    .getPublicUrl(fileName);

                  if (!publicUrlData || !publicUrlData.publicUrl) {
                    throw new Error("ì´ë¯¸ì§€ URLì„ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
                  }
                  reviewImageUrl = publicUrlData.publicUrl;
                }

                const { data, error } = await supabase.from("reviews").insert([
                  {
                    user_id: userId,
                    location_id: placeId,
                    comment: reviewText,
                    display_name: userNickname,
                    rating: parseInt(rating.value, 10),
                    review_image: reviewImageUrl, // ì´ë¯¸ì§€ URL ì¶”ê°€
                  },
                ]);

                if (error) {
                  throw error;
                }

                alert("ë¦¬ë·°ê°€ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
                location.reload(); // í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ìƒˆ ë¦¬ë·°ë¥¼ í™•ì¸
              } catch (error) {
                console.error("ë¦¬ë·° ë“±ë¡ ì‹¤íŒ¨:", error);
                alert(`ë¦¬ë·° ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}`);
              }
            });
          }

          // 'ì¢‹ì•„ìš”' ë²„íŠ¼ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
          const likeButton = detailContainer.querySelector(".like-button");
          if (likeButton) {
            likeButton.addEventListener("click", async (event) => {
              // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
              if (!getIsLoggedIn || !getIsLoggedIn()) {
                alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                return;
              }

              const currentUserId = getUserId();
              if (!currentUserId) {
                alert("ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
                return;
              }

              event.stopPropagation();
              if (likeButton.textContent === "â™¡") {
                // ì¢‹ì•„ìš” ì¶”ê°€
                const { error } = await supabase.from("user_favorites").insert({
                  user_id: currentUserId,
                  target_id: placeId,
                  target_type: "location",
                });
                if (error) {
                  console.error("ì¢‹ì•„ìš” ì¶”ê°€ ì‹¤íŒ¨:", error);
                  alert("ì¢‹ì•„ìš” ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                } else {
                  likeButton.textContent = "â™¥";
                  likeButton.classList.add("liked");
                }
              } else {
                // ì¢‹ì•„ìš” ì·¨ì†Œ
                const { error } = await supabase
                  .from("user_favorites")
                  .delete()
                  .eq("user_id", currentUserId)
                  .eq("target_id", placeId);

                if (error) {
                  console.error("ì¢‹ì•„ìš” ì·¨ì†Œ ì‹¤íŒ¨:", error);
                  alert("ì¢‹ì•„ìš” ì·¨ì†Œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                } else {
                  likeButton.textContent = "â™¡";
                  likeButton.classList.remove("liked");
                }
              }
            });
          }

          // ì´ë¯¸ì§€ê°€ ì—¬ëŸ¬ ì¥ì¼ ë•Œë§Œ Swiperë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
          if (images && images.length > 1) {
            new Swiper(".detail-image-slider", {
              loop: true,
              pagination: {
                el: ".swiper-pagination",
                clickable: true,
              },
              navigation: {
                nextEl: ".swiper-button-next",
                prevEl: ".swiper-button-prev",
              },
            });
          }

          // ì§€ë„ ì´ˆê¸°í™”
          kakao.maps.load(function () {
            const mapContainer = document.getElementById("map");

            // ì¥ì†Œ ê²€ìƒ‰ ê°ì²´ë¥¼ ìƒì„±í•©ë‹ˆë‹¤
            const ps = new kakao.maps.services.Places();

            // í‚¤ì›Œë“œë¡œ ì¥ì†Œë¥¼ ê²€ìƒ‰í•©ë‹ˆë‹¤
            ps.keywordSearch(
              mainLocation.placeName,
              function (data, status, pagination) {
                if (status === kakao.maps.services.Status.OK) {
                  // ê²€ìƒ‰ëœ ì¥ì†Œ ìœ„ì¹˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì§€ë„ ì¤‘ì‹¬ì„ ì„¤ì •í•©ë‹ˆë‹¤
                  const coords = new kakao.maps.LatLng(data[0].y, data[0].x);

                  const mapOption = {
                    center: coords,
                    level: 3,
                  };
                  const map = new kakao.maps.Map(mapContainer, mapOption);

                  // ê²°ê³¼ê°’ìœ¼ë¡œ ë°›ì€ ìœ„ì¹˜ë¥¼ ë§ˆì»¤ë¡œ í‘œì‹œí•©ë‹ˆë‹¤
                  const marker = new kakao.maps.Marker({
                    map: map,
                    position: coords,
                  });
                } else {
                  // í‚¤ì›Œë“œ ê²€ìƒ‰ ì‹¤íŒ¨ ì‹œ, DBì˜ ì¢Œí‘œ ì •ë³´ë¡œ ë‹¤ì‹œ ì‹œë„í•©ë‹ˆë‹¤.
                  console.warn(
                    `'${mainLocation.placeName}'ì— ëŒ€í•œ í‚¤ì›Œë“œ ê²€ìƒ‰ ì‹¤íŒ¨. ì¢Œí‘œë¡œ ì¬ì‹œë„í•©ë‹ˆë‹¤.`
                  );
                  const coordsFromDB = parseCoordinates(
                    mainLocation.coordinates
                  );

                  if (coordsFromDB && coordsFromDB.lat && coordsFromDB.lng) {
                    const mapOption = {
                      center: new kakao.maps.LatLng(
                        coordsFromDB.lat,
                        coordsFromDB.lng
                      ),
                      level: 3,
                    };
                    const map = new kakao.maps.Map(mapContainer, mapOption);
                    const marker = new kakao.maps.Marker({
                      map: map,
                      position: mapOption.center,
                    });
                  } else {
                    // í‚¤ì›Œë“œì™€ ì¢Œí‘œ ëª¨ë‘ ì‹¤íŒ¨í•œ ê²½ìš°
                    mapContainer.innerHTML =
                      '<p style="text-align:center; padding-top: 20px;">ì§€ë„ì— í‘œì‹œí•  ìœ„ì¹˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
                  }
                }
              }
            );
          });
        } catch (error) {
          console.error("Error fetching location details:", error);
          detailContainer.innerHTML = `<p>ì¥ì†Œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}</p>`;
        }
      }

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™” í•¨ìˆ˜ ì‹¤í–‰
      initSupabase();
    </script>
  </body>
</html>
