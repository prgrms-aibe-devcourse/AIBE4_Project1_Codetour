<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>K-Spot - í•œë¥˜ ì½˜í…ì¸  ì—¬í–‰ í”Œë«í¼</title>


    <link rel="stylesheet" href="/source/pages/index/style.css" />


    <style>
      .header-search-wrap {
        overflow: hidden;
        height: 0;
        transition: height 220ms ease;
        background: #fff;
        border-bottom: 1px solid #eee;
      }
      .header-search-inner {
        max-width: 1200px;
        margin: 0 auto;
        padding: 12px 16px;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .header-search-input {
        flex: 1;
        height: 44px;
        padding: 0 12px;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        font-size: 15px;
      }
      .header-search-btn,
      .header-search-close {
        height: 44px;
        padding: 0 14px;
        border-radius: 10px;
        border: 1px solid #bcd0c7;
        background: #0f5132;
        color: #fff;
        font-weight: 700;
        cursor: pointer;
      }
      .header-search-close { background: #fff; color: #0f5132; }

      .header-search-results,
      .header-content-suggest {
        max-width: 1200px;
        margin: 6px auto 12px;
        padding: 0 16px;
      }
      .search-empty {
        color: #6b7280;
        font-size: 14px;
        padding: 6px 2px;
      }
      .search-item {
        padding: 10px 12px;
        border: 1px solid #eee;
        border-radius: 10px;
        margin-bottom: 8px;
        cursor: pointer;
        background: #fff;
      }
      .search-item:hover { background: #f9fbfa; }

      .content-suggest-title {
        margin: 10px 2px 8px;
        font-weight: 800;
      }
    </style>
  </head>
  <body>
    <!-- í—¤ë” -->
    <header class="header">
      <div class="container">
        <a href="/source/pages/index/index.html" class="logo">
          <svg width="200" height="50" viewBox="0 0 200 50" xmlns="http://www.w3.org/2000/svg">
            <defs>
              <linearGradient id="logoGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" style="stop-color:#E91E8C;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#FF6B9D;stop-opacity:1" />
              </linearGradient>
              <style>
                .logo-text { 
                  font-family: 'Pretendard', sans-serif; 
                  font-weight: 800;
                  font-size: 40px;
                  fill: url(#logoGradient);
                  letter-spacing: -1px;
                }
              </style>
            </defs>
            <text x="0" y="37" class="logo-text">K</text>
            <text x="30" y="37" class="logo-text">-</text>
            <text x="44" y="37" class="logo-text">S</text>
            <text x="70" y="37" class="logo-text">P</text>
            <g transform="translate(95.5, 4) scale(0.93)">
              <path d="M18 0C10 0 4 6 4 13c0 10 14 26 14 26s14-16 14-26c0-7-6-13-14-13z" 
                    fill="url(#logoGradient)"/>
              <circle cx="18" cy="13" r="8" fill="white"/>
            </g>
            <text x="128" y="37" class="logo-text">T</text>
          </svg>
        </a>

        <nav class="nav">
          <a href="/source/pages/index/index.html" class="nav-link active" data-i18n="nav.home">í™ˆ</a>
          <a href="/source/pages/contents/contents.html" class="nav-link" data-i18n="nav.content">ì½˜í…ì¸ ë³„ ì—¬í–‰ì§€</a>
          <a href="/source/pages/aiCourse/aiSchedule.html" class="nav-link" data-i18n="nav.ai">AI ì½”ìŠ¤ ì¶”ì²œ</a>
          <a href="/source/pages/map/map_page.html" class="nav-link" data-i18n="nav.region">K-ì½˜í…ì¸  ì—¬í–‰ ì§€ë„</a>
          <a href="#routes" class="nav-link" data-i18n="nav.routes">ì¸ê¸° ì—¬í–‰ ë£¨íŠ¸</a>
          <a href="/source/pages/my-page/my-page.html" class="nav-link" data-i18n="nav.mypage">ë§ˆì´í˜ì´ì§€</a>
        </nav>

        <div class="header-right" style="display:flex;gap:8px;align-items:center;">
          <select class="lang-select" id="languageSelector">
            <option value="ko">í•œêµ­ì–´</option>
            <option value="en">English</option>
            <option value="ja">æ—¥æœ¬èª</option>
          </select>
  
          <button class="btn-search" id="searchToggle">ğŸ”</button>

          <span id="greeting" class="hide">ì•ˆë…•í•˜ì„¸ìš”, <span id="nickname"></span>ë‹˜</span>
          <button id="loginBtn">ë¡œê·¸ì¸</button>
          <button id="logoutBtn" class="hide">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
      </div>

     
      <div class="header-search-wrap" id="headerSearchWrap">
        <div class="header-search-inner">
          <input
            type="text"
            class="header-search-input"
            id="searchInput"
            placeholder="ë“œë¼ë§ˆ, ì˜í™”, ì¥ì†Œë¥¼ ê²€ìƒ‰í•˜ì„¸ìš”..."
            autocomplete="off"
          />
          <button class="header-search-btn" id="searchDo">ê²€ìƒ‰</button>
          <button class="header-search-close" id="searchClose">ë‹«ê¸°</button>
        </div>


        <div class="header-content-suggest">
          <div id="contentSuggestTitle" class="content-suggest-title" style="display:none;">ì¶”ì²œ ì½˜í…ì¸ </div>
          <div id="contentSuggestRail" class="card-carousel"></div>
        </div>


        <div class="header-search-results" id="searchResults"></div>
      </div>
    </header>

    <!-- íˆì–´ë¡œ ì„¹ì…˜ -->
    <section class="hero" id="home">
      <div class="hero-overlay">
        <div class="container">
          <h2 class="hero-title" data-i18n="hero.title">
            í•œë¥˜ ì½˜í…ì¸ ì™€ í•¨ê»˜í•˜ëŠ”<br />íŠ¹ë³„í•œ ì—¬í–‰
          </h2>
          <p class="hero-subtitle" data-i18n="hero.subtitle">
            ì¢‹ì•„í•˜ëŠ” ë“œë¼ë§ˆ, K-pop, ì˜í™”ì˜ ì´¬ì˜ì§€ë¥¼ ì§ì ‘ ë°©ë¬¸í•´ë³´ì„¸ìš”!
          </p>
          <button class="btn-hero" data-i18n="hero.cta">ì‹œì‘í•˜ê¸°</button>
        </div>
      </div>
    </section>

    <!-- ì¸ê¸° ì½˜í…ì¸  ì„¹ì…˜ -->
    <section class="section" id="content">
      <div class="container">
        <div class="section-header">
          <div class="section-text">
            <h3 class="section-title" data-i18n="popular.title">ì¸ê¸° ì½˜í…ì¸ </h3>
            <p class="section-subtitle" data-i18n="popular.subtitle">
              êµ­ë‚´ì™¸ íŒ¬ë“¤ì´ ê°€ì¥ ë§ì´ ì°¾ëŠ” í•œë¥˜ ì½˜í…ì¸ ë¥¼ ë§Œë‚˜ë³´ì„¸ìš”
            </p>
          </div>
        </div>
        <div class="carousel-container">
          <button class="nav-arrow nav-arrow-left" onclick="scrollCarousel('popularContent', -1)">â†</button>
          <div class="carousel-wrapper">
            <div class="card-carousel" id="popularContent"></div>
          </div>
          <button class="nav-arrow nav-arrow-right" onclick="scrollCarousel('popularContent', 1)">â†’</button>
        </div>
        <div class="carousel-dots" id="popularContentDots"></div>
      </div>
    </section>

    <!-- ì¶”ì²œ ì—¬í–‰ ì½”ìŠ¤ ì„¹ì…˜ -->
    <section class="section section-alt" id="routes">
      <div class="container">
        <div class="section-header">
          <div class="section-text">
            <h3 class="section-title" data-i18n="recommended.title">ì¶”ì²œ ì—¬í–‰ ì½”ìŠ¤</h3>
            <p class="section-subtitle" data-i18n="recommended.subtitle">ì·¨í–¥ê³¼ ê°€ê¹Œìš´ í…Œë§ˆë³„ ì½”ìŠ¤ë¥¼ ì¶”ì²œ</p>
          </div>
        </div>
        <div class="carousel-container">
          <button class="nav-arrow nav-arrow-left" onclick="scrollCarousel('recommendedCourses', -1)">â†</button>
          <div class="carousel-wrapper">
            <div class="card-carousel" id="recommendedCourses"></div>
          </div>
          <button class="nav-arrow nav-arrow-right" onclick="scrollCarousel('recommendedCourses', 1)">â†’</button>
        </div>
        <div class="carousel-dots" id="recommendedCoursesDots"></div>
      </div>
    </section>

    <!-- ì‚¬ìš©ì ë§ì¶¤ ì¶”ì²œ ì„¹ì…˜ -->
    <section class="section" id="personalized">
      <div class="container">
        <div class="section-header">
          <div class="section-text">
            <h3 class="section-title" data-i18n="personalized.title">ì‚¬ìš©ì ë§ì¶¤ ì¶”ì²œ</h3>
            <p class="section-subtitle" data-i18n="personalized.subtitle">ë‚´ ì·¨í–¥ ë§ì¶¤ ì½”ìŠ¤</p>
          </div>
        </div>
        <div class="personalized-wrapper">
          <div class="carousel-container">
            <button class="nav-arrow nav-arrow-left" onclick="scrollCarousel('personalizedCourses', -1)">â†</button>
            <div class="carousel-wrapper">
              <div class="card-carousel blur-overlay" id="personalizedCourses"></div>
            </div>
            <button class="nav-arrow nav-arrow-right" onclick="scrollCarousel('personalizedCourses', 1)">â†’</button>
          </div>
          <div class="carousel-dots" id="personalizedCoursesDots"></div>
          <div class="login-message">
            <div class="login-icon">ğŸ”’</div>
            <h3 data-i18n="personalized.loginRequired">ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</h3>
            <p data-i18n="personalized.loginMessage">ë§ì¶¤ ì—¬í–‰ ì¶”ì²œì„ ë°›ìœ¼ì‹œë ¤ë©´ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”</p>
            <button class="btn-login-large" data-i18n="btn.login">ë¡œê·¸ì¸í•˜ê¸°</button>
          </div>
        </div>
      </div>
    </section>

    <!-- í‘¸í„° -->
    <footer class="footer">
      <div class="container">
        <div class="footer-content">
          <div class="footer-logo">
            <h3>K-SPOT</h3>
            <p data-i18n="footer.tagline">í•œë¥˜ ì½˜í…ì¸ ì™€ í•¨ê»˜í•˜ëŠ” íŠ¹ë³„í•œ ì—¬í–‰</p>
            <div class="social-links">
              <a href="#">ğŸ“·</a>
              <a href="#">ğŸ¦</a>
              <a href="#">ğŸ‘</a>
            </div>
          </div>
          <div class="footer-links">
            <div class="footer-column">
              <h4 data-i18n="footer.service">ì„œë¹„ìŠ¤</h4>
              <a href="#" data-i18n="footer.contentTravel">ì½˜í…ì¸ ë³„ ì—¬í–‰ì§€</a>
              <a href="#" data-i18n="footer.regionExplore">ì§€ì—­ë³„ íƒìƒ‰</a>
              <a href="#" data-i18n="footer.popularRoutes">ì¸ê¸° ë£¨íŠ¸</a>
            </div>
            <div class="footer-column">
              <h4 data-i18n="footer.support">ê³ ê°ì§€ì›</h4>
              <a href="#" data-i18n="footer.faq">FAQ</a>
              <a href="#" data-i18n="footer.contact">ë¬¸ì˜í•˜ê¸°</a>
              <a href="#" data-i18n="footer.terms">ì´ìš©ì•½ê´€</a>
            </div>
            <div class="footer-column">
              <h4 data-i18n="footer.social">ì†Œì…œë¯¸ë””ì–´</h4>
              <a href="#">Instagram</a>
              <a href="#">Twitter</a>
              <a href="#">Facebook</a>
            </div>
          </div>
        </div>
        <div class="footer-bottom">
          <p>&copy; 2025 K-Spot. All rights reserved.</p>
        </div>
      </div>
    </footer>

    <script src="/source/pages/index/script.js"></script>

    <script src="/public/libs/userManager.js"></script>

    <script>
      window.AUTH_PATHS = {
        INDEX: "/source/pages/index/index.html",
        SET_NICK: "/public/auth/set-nickname.html"
      };
    </script>

    <script type="module" src="/public/auth/auth.js"></script>

    <!-- í—¤ë” ì¸ë¼ì¸ ê²€ìƒ‰ + íŒ€ ì¹´ë“œ ë Œë”ëŸ¬ ì–´ëŒ‘í„° -->
    <script type="module">
      const header        = document.querySelector('.header');
      const wrap          = document.getElementById('headerSearchWrap');
      const input         = document.getElementById('searchInput');
      const btnToggle     = document.getElementById('searchToggle');
      const btnClose      = document.getElementById('searchClose');
      const btnDo         = document.getElementById('searchDo');
      const results       = document.getElementById('searchResults');

      const suggestTitle  = document.getElementById('contentSuggestTitle');
      const suggestRail   = document.getElementById('contentSuggestRail');

      let allContents = null;

      function setWrapHeight(open) {
        if (open) {
          wrap.style.height = wrap.scrollHeight + 'px';
          header.classList.add('header--search-open');
        } else {
          wrap.style.height = '0px';
          header.classList.remove('header--search-open');
        }
      }
      function openSearch() {
        results.innerHTML = '';
        clearRail();
        input.value = '';
        setWrapHeight(true);
        setTimeout(() => input.focus(), 0);
        ensureContentsLoaded();
      }
      function closeSearch() { setWrapHeight(false); }
      function toggleSearch() {
        const isOpen = wrap.style.height && wrap.style.height !== '0px';
        isOpen ? closeSearch() : openSearch();
      }
      btnToggle?.addEventListener('click', toggleSearch);
      btnClose?.addEventListener('click', closeSearch);
      document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeSearch(); });
      window.addEventListener('resize', () => {
        if (wrap.style.height && wrap.style.height !== '0px') {
          wrap.style.height = 'auto';
          const h = wrap.scrollHeight;
          wrap.style.height = h + 'px';
        }
      });


      function tryTeamRenderer(items) {
        if (window.ContentCards?.render) {
          window.ContentCards.render(suggestRail, items);
          return true;
        }
        if (typeof window.renderContentCards === 'function') {
          window.renderContentCards('contentSuggestRail', items);
          return true;
        }
        if (window.CardFactory?.render) {
          window.CardFactory.render(suggestRail, items);
          return true;
        }
        if (typeof window.buildCards === 'function') {
          window.buildCards(suggestRail, items);
          return true;
        }
        return false;
      }
      function fallbackRender(items) {
        suggestRail.innerHTML = items.map(it => `
          <div class="search-item" style="min-width:220px;">
            <div style="font-weight:700;">${it.title}</div>
            <div style="color:#666;font-size:13px;margin-top:2px;">${it.subtitle ?? ''}</div>
          </div>
        `).join('');
      }
      function renderRail(items) {
        suggestTitle.style.display = items?.length ? '' : 'none';
        suggestRail.innerHTML = '';
        if (!items?.length) return;
        const ok = tryTeamRenderer(items);
        if (!ok) fallbackRender(items);
        if (wrap.style.height && wrap.style.height !== '0px') {
          wrap.style.height = 'auto';
          const h = wrap.scrollHeight;
          wrap.style.height = h + 'px';
        }
      }
      function clearRail() {
        suggestTitle.style.display = 'none';
        suggestRail.innerHTML = '';
      }


      async function ensureContentsLoaded() {
        if (allContents) return;
        try {
          const res = await fetch('/api/contents');
          if (!res.ok) throw new Error('contents load failed');
          const data = await res.json(); // [{ contents, name, ... }]
          const unique = [...new Set((data || []).map(d => (d.contents || '').trim()).filter(Boolean))];
          const countByContent = unique.map(c => ({
            content: c,
            count: (data || []).filter(d => (d.contents || '').trim() === c).length
          }));
          allContents = countByContent;
        } catch (e) {
          console.error('Failed to load contents:', e);
          allContents = [];
        }
      }
      function rankScore(q, name) {
        const a = (q || '').toLowerCase();
        const b = (name || '').toLowerCase();
        if (!a || !b) return 0;
        if (b === a) return 100;
        if (b.startsWith(a)) return 80;
        if (b.includes(a)) return 60;
        let lcs = 0;
        for (let i=0;i<a.length;i++){
          for (let j=i+1;j<=a.length;j++){
            if (b.includes(a.slice(i,j))) lcs = Math.max(lcs, j-i);
          }
        }
        return lcs;
      }
      function buildCardItems(q, boostSet = new Set()) {
        if (!allContents || allContents.length === 0) return [];
        return allContents.map(({content, count}) => {
          const score = rankScore(q, content) + Math.min(count, 10) * 2 + (boostSet.has(content) ? 15 : 0);
          return { content, count, score };
        })
        .filter(s => s.score > 0)
        .sort((a,b) => b.score - a.score)
        .slice(0, 3)
        .map(s => ({
          id: s.content,
          title: s.content,
          subtitle: `ê´€ë ¨ ì¥ì†Œ ì•½ ${s.count}ê°œ`,
          imageUrl: null,
          href: `/source/pages/map/map_page.html?name=${encodeURIComponent(s.content)}`
        }));
      }


      const debounce = (fn, ms = 300) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); }; };

      function renderResults(docs, q) {
        if (!docs?.length) {
          results.innerHTML = `<p class="search-empty">"${q}" ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ì–´ìš”.</p>`;
        } else {
          results.innerHTML = docs.slice(0, 20).map(d => `
            <div class="search-item" data-name="${d.place_name ?? ''}" data-lat="${d.y ?? ''}" data-lng="${d.x ?? ''}">
              <div style="font-weight:700;">${d.place_name ?? d.media_title ?? ''}</div>
              <div style="color:#666;font-size:13px;margin-top:2px;">${d.address_name ?? d.media_title ?? ''}</div>
            </div>
          `).join('');

          Array.from(results.querySelectorAll('.search-item')).forEach(el => {
            el.addEventListener('click', () => {
              const name = el.getAttribute('data-name') || '';
              const lat  = el.getAttribute('data-lat')  || '';
              const lng  = el.getAttribute('data-lng')  || '';
              const url = `/source/pages/map/map_page.html?name=${encodeURIComponent(name)}&lat=${lat}&lng=${lng}`;
              window.location.href = url;
            });
          });
        }
        if (wrap.style.height && wrap.style.height !== '0px') {
          wrap.style.height = 'auto';
          const h = wrap.scrollHeight;
          wrap.style.height = h + 'px';
        }
      }

      async function doSearch(q) {
        if (!q || !q.trim()) {
          results.innerHTML = '';
          renderRail([]);
          return;
        }
        try {
          const [byText, byContent] = await Promise.all([
            fetch(`/api/search?q=${encodeURIComponent(q)}`).then(r => r.ok ? r.json() : { documents: [] }).catch(() => ({ documents: [] })),
            fetch(`/api/search-by-content?name=${encodeURIComponent(q)}`).then(r => r.ok ? r.json() : { documents: [] }).catch(() => ({ documents: [] })),
          ]);

          const docs = [ ...(byText?.documents ?? []), ...(byContent?.documents ?? []) ];
          renderResults(docs, q);

          const boostSet = new Set((docs || []).map(d => (d.media_title || '').trim()).filter(Boolean));
          const items = buildCardItems(q, boostSet);
          renderRail(items);
        } catch (e) {
          console.error(e);
          results.innerHTML = `<p class="search-empty">ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.</p>`;
          renderRail([]);
        }
      }

      input?.addEventListener('input', debounce((e) => doSearch(e.target.value), 300));
      btnDo?.addEventListener('click', () => doSearch(input.value));
    </script>
  </body>
</html>
