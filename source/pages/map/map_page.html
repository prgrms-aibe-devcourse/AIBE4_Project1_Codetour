<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>K-ÏΩòÌÖêÏ∏† ÏßÄÎèÑ</title>
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <meta property="og:image" content="/og-image.jpg">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="K-Spot">
    <script src="/libs/nav-manager.js" type="module"></script>
    <link rel="stylesheet" href="../index/style.css" />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Pretendard", -apple-system, BlinkMacSystemFont, sans-serif;
        background: linear-gradient(135deg, #f5e6d3 0%, #ffffff 100%);
        min-height: 100vh;
      }

      header:not(.header) {
        background: linear-gradient(135deg, #ff4d8d 0%, #3a8dff 100%);
        color: white;
        padding: 20px 30px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      header h1 {
        font-size: 28px;
        font-weight: 700;
        letter-spacing: -0.5px;
      }

      header p {
        font-size: 14px;
        opacity: 0.9;
        margin-top: 5px;
      }

      .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .header-right {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .home-btn {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 2px solid white;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        font-size: 14px;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-block;
      }

      .home-btn:hover {
        background: white;
        color: #ff4d8d;
      }

      header:not(.header) .lang-select {
        background: rgba(255, 255, 255, 0.1);
        color: white;
        border: 2px solid white;
        padding: 10px 10px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        font-size: 14px;
        transition: all 0.3s ease;
      }

      header:not(.header) .lang-select:hover {
        background: rgba(255, 255, 255, 0.1);
      }

      header:not(.header) .lang-select option {
        background: #ff4d8d;
        color: white;
      }

      .header .lang-select {
        background: white !important;
        color: #333 !important;
      }

      .header .lang-select option {
        background: white !important;
        color: #333 !important;
      }

      .container {
        display: flex;
        gap: 20px;
        padding: 20px;
        max-width: 1600px;
        margin: 0 auto;
      }

      .left-panel {
        flex: 1;
        max-width: 420px;
      }

      .map-container {
        flex: 2;
      }

      #map {
        width: 100%;
        height: 700px;
        border-radius: 16px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        overflow: hidden;
      }

      input,
      button,
      select {
        padding: 12px 16px;
        margin: 5px;
        border-radius: 8px;
        border: 2px solid transparent;
        font-size: 14px;
        transition: all 0.3s ease;
      }

      input:focus,
      select:focus {
        outline: none;
        border-color: #3a8dff;
      }

      button {
        cursor: pointer;
        font-weight: 600;
        border: none;
      }

      button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .section {
        background: white;
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 16px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(58, 141, 255, 0.1);
      }

      .section h3 {
        margin-top: 0;
        margin-bottom: 15px;
        color: #1a1a1a;
        font-size: 18px;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .search-section {
        border-top: 3px solid #ff4d8d;
      }

      .course-section {
        border-top: 3px solid #3a8dff;
      }

      .saved-section {
        border-top: 3px solid #f5e6d3;
      }

      .search-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 12px;
      }

      .tab-btn {
        flex: 1;
        padding: 8px 12px;
        background: #f5e6d3;
        color: #1a1a1a;
        border: 2px solid #f5e6d3;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        font-size: 13px;
        transition: all 0.3s ease;
      }

      .tab-btn.active {
        background: #3a8dff;
        color: white;
        border-color: #3a8dff;
      }

      .search-input-group {
        display: flex;
        gap: 5px;
      }

      #searchInput,
      #contentSelect {
        flex: 1;
      }

      #searchBtn {
        background: linear-gradient(135deg, #ff4d8d 0%, #ff6b9d 100%);
        color: white;
        padding: 12px 20px;
      }

      #courseList {
        list-style: none;
        padding: 0;
        min-height: 120px;
        background: #fafafa;
        border: 2px dashed #f5e6d3;
        border-radius: 12px;
        padding: 10px;
      }

      #courseList:empty::before {
        content: "Ïû•ÏÜåÎ•º Ï∂îÍ∞ÄÌï¥Î≥¥ÏÑ∏Ïöî üìç";
        display: block;
        text-align: center;
        color: #999;
        padding: 40px;
      }

      #courseList li {
        padding: 14px 16px;
        margin: 8px 0;
        background: linear-gradient(135deg, #ffffff 0%, #f5f5f5 100%);
        border-radius: 10px;
        cursor: move;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        border-left: 4px solid #3a8dff;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        transition: all 0.3s ease;
      }

      #courseList li:hover {
        transform: translateX(4px);
        box-shadow: 0 4px 12px rgba(58, 141, 255, 0.2);
      }

      #courseList li.dragging {
        opacity: 0.5;
        transform: scale(0.95);
      }

      .course-item-info {
        flex: 1;
      }

      .course-item-info strong {
        display: block;
        color: #1a1a1a;
        margin-bottom: 4px;
      }

      .course-item-info small {
        color: #999;
        font-size: 12px;
      }

      .remove-btn {
        background: #ff4d8d;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 12px;
        font-weight: 600;
        margin-left: 10px;
      }

      .remove-btn:hover {
        background: #ff3377;
      }

      #saveBtn {
        width: 100%;
        background: linear-gradient(135deg, #3a8dff 0%, #5ba3ff 100%);
        color: white;
        border: none;
        padding: 14px;
        font-size: 15px;
        margin: 10px 5px 5px 5px;
      }

      #showRouteBtn {
        width: 100%;
        background: linear-gradient(135deg, #ff4d8d 0%, #ff6b9d 100%);
        color: white;
        border: none;
        padding: 14px;
        font-size: 15px;
        margin: 5px;
      }

      #savedCourses {
        max-height: 300px;
        overflow-y: auto;
      }

      #savedCourses::-webkit-scrollbar {
        width: 8px;
      }

      #savedCourses::-webkit-scrollbar-thumb {
        background: #3a8dff;
        border-radius: 4px;
      }

      #savedCourses::-webkit-scrollbar-track {
        background: #f5e6d3;
        border-radius: 4px;
      }

      .saved-course {
        background: white;
        padding: 14px;
        margin: 8px 0;
        border-radius: 10px;
        cursor: pointer;
        border: 2px solid #f5e6d3;
        transition: all 0.3s ease;
      }

      .saved-course:hover {
        background: linear-gradient(135deg, #ffffff 0%, #f5e6d3 30%);
        border-color: #3a8dff;
        transform: translateX(4px);
        box-shadow: 0 4px 12px rgba(58, 141, 255, 0.15);
      }

      .saved-course strong {
        color: #1a1a1a;
        font-size: 15px;
        display: block;
      }

      .saved-course small {
        color: #666;
        font-size: 13px;
      }

      .route-info {
        background: linear-gradient(135deg, #f5e6d3 0%, #ffffff 100%);
        padding: 16px;
        margin-top: 10px;
        border-radius: 10px;
        border: 2px solid #3a8dff;
        color: #1a1a1a;
      }

      .route-info strong {
        color: #ff4d8d;
        font-size: 16px;
      }

      select {
        background: white;
        border: 2px solid #f5e6d3;
        color: #1a1a1a;
      }

      #loadCoursesBtn {
        background: #3a8dff;
        color: white;
        padding: 12px 16px;
      }

      #loadCoursesBtn:hover {
        background: #2a7dff;
      }

      .custom-info {
        padding: 12px;
        min-width: 200px;
        background: white;
        border-radius: 8px;
      }

      .info-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 8px;
      }

      .info-title {
        flex: 1;
      }

      .info-title strong {
        display: block;
        color: #1a1a1a;
        font-size: 14px;
        margin-bottom: 4px;
      }

      .info-title small {
        color: #3a8dff;
        font-size: 12px;
        font-weight: 600;
      }

      .info-close {
        background: none;
        border: none;
        font-size: 18px;
        cursor: pointer;
        padding: 0 5px;
        color: #999;
      }

      .info-close:hover {
        color: #ff4d8d;
      }

      .info-add-btn {
        width: 100%;
        padding: 8px;
        background: linear-gradient(135deg, #3a8dff 0%, #5ba3ff 100%);
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        font-size: 13px;
        margin-top: 8px;
      }

      @media (max-width: 1024px) {
        .container {
          flex-direction: column;
        }

        .left-panel {
          max-width: 100%;
        }
      }
      .header {
        background: rgba(255, 255, 255, 0.95) !important;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08) !important;
        position: sticky !important;
        top: 0 !important;
        z-index: 1000 !important;
        padding: 0 !important;
      }

      .header .container {
        max-width: 1280px !important;
        margin: 0 auto !important;
        padding: 0 2rem !important;
        display: block !important;
      }

      .header-top {
        display: flex !important;
        justify-content: space-between !important;
        align-items: center !important;
        padding: 12px 0 !important;
        border-bottom: 1px solid #eee !important;
      }

      .header .nav {
        display: flex !important;
        justify-content: space-evenly !important;
        align-items: center !important;
        padding: 12px 0 !important;
      }

      .header .nav-link {
        text-decoration: none !important;
        color: #2d3748 !important;
        font-weight: 600 !important;
        font-size: 15px !important;
        padding: 8px 0 !important;
        border-bottom: 3px solid transparent !important;
      }

      .header .nav-link.active {
        color: #e91e8c !important;
        border-bottom-color: #e91e8c !important;
      }

      .header .logo svg {
        height: 45px !important;
        width: 180px !important;
      }

      .header #loginBtn {
        background: #e91e8c !important;
        color: white !important;
        padding: 0 16px !important;
        height: 40px !important;
        border: none !important;
        border-radius: 8px !important;
        cursor: pointer !important;
        font-weight: 600 !important;
        font-size: 14px !important;
        transition: all 0.3s ease !important;
      }

      .header #loginBtn:hover {
        background: #d01a7a !important;
        transform: translateY(-1px) !important;
      }

      .header .btn-search {
        background: transparent !important;
        border: 1px solid #e5e7eb !important;
        width: 40px !important;
        height: 40px !important;
        border-radius: 8px !important;
        cursor: pointer !important;
        font-size: 18px !important;
        transition: all 0.3s ease !important;
      }

      .header .btn-search:hover {
        background: #f9fafb !important;
        border-color: #d1d5db !important;
      }

      .header .home-btn {
        display: none !important;
      }
    </style>
  </head>
  <body>
    <div id="headerPlaceholder"></div>
    <div class="container">
      <div class="left-panel">
        <!-- Ïû•ÏÜå Í≤ÄÏÉâ -->
        <div class="section search-section">
          <h3 data-i18n="section.search">üîç Í≤ÄÏÉâ</h3>

          <!-- ÌÉ≠ ÏÑ†ÌÉù -->
          <div class="search-tabs">
            <button
              class="tab-btn active"
              onclick="switchSearchMode('place')"
              data-i18n="tab.place"
            >
              Ïû•ÏÜå Í≤ÄÏÉâ
            </button>
            <button
              class="tab-btn"
              onclick="switchSearchMode('content')"
              data-i18n="tab.content"
            >
              ÏΩòÌÖêÏ∏† Í≤ÄÏÉâ
            </button>
          </div>

          <!-- Ïû•ÏÜå Í≤ÄÏÉâ Î™®Îìú -->
          <div id="placeSearchMode">
            <div class="search-input-group">
              <input
                type="text"
                id="searchInput"
                data-i18n-placeholder="placeholder.placeSearch"
                placeholder="Ïû•ÏÜåÎ™Ö, Ï£ºÏÜå Í≤ÄÏÉâ..."
              />
              <button id="searchBtn" data-i18n="btn.search">Í≤ÄÏÉâ</button>
            </div>
          </div>

          <!-- ÏΩòÌÖêÏ∏† Í≤ÄÏÉâ Î™®Îìú -->
          <div id="contentSearchMode" style="display: none">
            <select id="contentSelect">
              <option value="" data-i18n="option.selectContent">
                ÏΩòÌÖêÏ∏† ÏÑ†ÌÉù...
              </option>
            </select>
            <button
              id="searchContentBtn"
              data-i18n="btn.search"
              style="
                width: 100%;
                background: #3a8dff;
                color: white;
                padding: 10px;
                margin-top: 8px;
              "
            >
              Í≤ÄÏÉâ
            </button>
          </div>
        </div>

        <!-- ÌòÑÏû¨ ÏΩîÏä§ -->
        <div class="section course-section">
          <h3 data-i18n="section.myCourse">üìç ÎÇòÎßåÏùò Ïó¨Ìñâ ÏΩîÏä§</h3>
          <p
            style="font-size: 13px; color: #666; margin-bottom: 10px"
            data-i18n="hint.dragOrder"
          >
            ÎìúÎûòÍ∑∏Î°ú ÏàúÏÑúÎ•º Î≥ÄÍ≤ΩÌï† Ïàò ÏûàÏñ¥Ïöî
          </p>
          <ul id="courseList"></ul>
          <button id="saveBtn" data-i18n="btn.saveCourse">
            üíæ ÏΩîÏä§ Ï†ÄÏû•ÌïòÍ∏∞
          </button>
          <button id="showRouteBtn" data-i18n="btn.showRoute">
            üöó Í≤ΩÎ°ú ÌôïÏù∏ÌïòÍ∏∞
          </button>
          <button
            id="aiRecommendBtn"
            data-i18n="btn.aiRecommend"
            style="
              width: 100%;
              background: linear-gradient(135deg, #ff6b9d 0%, #ffa07a 100%);
              color: white;
              border: none;
              padding: 14px;
              font-size: 15px;
              margin: 5px;
            "
          >
            ü§ñ AI Ï∂îÏ≤úÎ∞õÍ∏∞
          </button>
          <div id="routeInfo"></div>
        </div>

        <!-- Ï†ÄÏû•Îêú ÏΩîÏä§ -->
        <div class="section saved-section">
          <h3 data-i18n="section.savedCourses">üíé Ï†ÄÏû•Îêú ÏΩîÏä§</h3>
          <button id="loadCoursesBtn" data-i18n="btn.load">
            ÎÇ¥ ÏΩîÏä§ Î∂àÎü¨Ïò§Í∏∞
          </button>
          <div id="savedCourses"></div>
        </div>
      </div>

      <div class="map-container">
        <div id="map"></div>
      </div>
    </div>

    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=8d27848d8e0061837441313b57eba277&libraries=services&autoload=false"></script>
    <script type="module">
      // Supabase Auth Ïó∞Îèô
      import {
        initAuthListener,
        getIsLoggedIn,
        getUserNickname,
        getUserId,
      } from "/libs/user-manager.js";

      window.currentUser = null;

      // Î°úÍ∑∏Ïù∏ ÏÉÅÌÉú ÌôïÏù∏
      async function checkAuth() {
        initAuthListener();
        const isLoggedIn = getIsLoggedIn();
        const userId = getUserId();

        const loginBtn = document.getElementById("loginBtn");
        const langSelect = document.querySelector(".lang-select");
        const searchBtn = document.querySelector(".btn-search");

        if (isLoggedIn && userId) {
          // Î°úÍ∑∏Ïù∏Îêú ÏÉÅÌÉú
          const nickname = getUserNickname();
          window.currentUser = { id: userId, nickname };

          // Î°úÍ∑∏Ïù∏ Î≤ÑÌäºÏùÑ Î°úÍ∑∏ÏïÑÏõÉ Î≤ÑÌäºÏúºÎ°ú Î≥ÄÍ≤Ω
          if (loginBtn) {
            loginBtn.textContent = "Î°úÍ∑∏ÏïÑÏõÉ";
            loginBtn.onclick = async () => {
              const { createClient } = await import(
                "https://esm.sh/@supabase/supabase-js@2"
              );
              const supabase = createClient(
                "https://fmcxkqfccuevcaqkzsex.supabase.co",
                "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZtY3hrcWZjY3VldmNhcWt6c2V4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNzk3MzcsImV4cCI6MjA3NDk1NTczN30.IZ47Juv0ypiX4sWTb1vo54hcMI0yBQol1VhUm37vs7M"
              );
              await supabase.auth.signOut();
              window.location.reload();
            };
          }
        } else {
          // Î°úÍ∑∏Ïù∏ Ïïà Îêú ÏÉÅÌÉú
          if (loginBtn) {
            loginBtn.onclick = () => {
              window.location.href = "/auth";
            };
          }
        }

        // Ïñ∏Ïñ¥ ÏÑ†ÌÉù Í∏∞Îä•
        if (langSelect) {
          const savedLang = localStorage.getItem("language") || "ko";
          langSelect.value = savedLang;

          langSelect.addEventListener("change", (e) => {
            localStorage.setItem("language", e.target.value);
            // Ïñ∏Ïñ¥ Î≥ÄÍ≤Ω Ìï®ÏàòÍ∞Ä ÏûàÎã§Î©¥ Ìò∏Ï∂ú
            if (typeof changeLanguage === "function") {
              changeLanguage(e.target.value);
            }
          });
        }

        // Í≤ÄÏÉâ Î≤ÑÌäº Í∏∞Îä• (ÌïÑÏöîÏãú Íµ¨ÌòÑ)
        if (searchBtn) {
          searchBtn.addEventListener("click", () => {
            // Í≤ÄÏÉâ Í∏∞Îä• Íµ¨ÌòÑ
            console.log("Í≤ÄÏÉâ Î≤ÑÌäº ÌÅ¥Î¶≠");
          });
        }
      }

      checkAuth();
    </script>

    <script>
      // Îã§Íµ≠Ïñ¥ Î≤àÏó≠ Îç∞Ïù¥ÌÑ∞
      const translations = {
        ko: {
          "header.title": "üá∞üá∑ K-ÏΩòÌÖêÏ∏† Ïó¨Ìñâ ÏßÄÎèÑ",
          "header.subtitle":
            "ÌïúÎ•ò ÏΩòÌÖêÏ∏†ÏôÄ Ìï®ÍªòÌïòÎäî ÌäπÎ≥ÑÌïú Ïó¨Ìñâ ÏΩîÏä§Î•º ÎßåÎì§Ïñ¥Î≥¥ÏÑ∏Ïöî",
          "btn.home": "ÌôàÏúºÎ°ú",
          "section.search": "üîç Í≤ÄÏÉâ",
          "tab.place": "Ïû•ÏÜå Í≤ÄÏÉâ",
          "tab.content": "ÏΩòÌÖêÏ∏† Í≤ÄÏÉâ",
          "placeholder.placeSearch": "Ïû•ÏÜåÎ™Ö, Ï£ºÏÜå Í≤ÄÏÉâ...",
          "btn.search": "Í≤ÄÏÉâ",
          "option.selectContent": "ÏΩòÌÖêÏ∏† ÏÑ†ÌÉù...",
          "option.selectUser": "ÏÇ¨Ïö©Ïûê ÏÑ†ÌÉù...",
          "section.myCourse": "üìç ÎÇòÎßåÏùò Ïó¨Ìñâ ÏΩîÏä§",
          "hint.dragOrder": "ÎìúÎûòÍ∑∏Î°ú ÏàúÏÑúÎ•º Î≥ÄÍ≤ΩÌï† Ïàò ÏûàÏñ¥Ïöî",
          "btn.saveCourse": "üíæ ÏΩîÏä§ Ï†ÄÏû•ÌïòÍ∏∞",
          "btn.showRoute": "üöó Í≤ΩÎ°ú ÌôïÏù∏ÌïòÍ∏∞",
          "btn.aiRecommend": "ü§ñ AI Ï∂îÏ≤úÎ∞õÍ∏∞",
          "section.savedCourses": "üíé Ï†ÄÏû•Îêú ÏΩîÏä§",
          "user.user1": "ÏÇ¨Ïö©Ïûê 1",
          "user.user2": "ÏÇ¨Ïö©Ïûê 2",
          "user.user3": "ÏÇ¨Ïö©Ïûê 3",
          "btn.load": "Î∂àÎü¨Ïò§Í∏∞",
          "btn.delete": "ÏÇ≠Ï†ú",
          "btn.addToCourse": "+ ÏΩîÏä§ Ï∂îÍ∞Ä",
          "alert.enterSearch": "Í≤ÄÏÉâÏñ¥Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî üòä",
          "alert.noResults": "Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§ üò¢",
          "alert.selectContent": "ÏΩòÌÖêÏ∏†Î•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî üòä",
          "alert.selectUser": "ÏÇ¨Ïö©ÏûêÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî üòä",
          "alert.noLocations": "Ìï¥Îãπ ÏΩòÌÖêÏ∏†Ïùò Ï¥¨ÏòÅÏßÄÍ∞Ä ÏóÜÏäµÎãàÎã§ üò¢",
          "alert.deleteCourse": "Ïù¥ ÏΩîÏä§Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå? üóëÔ∏è",
          "alert.courseDeleted": "‚úÖ ÏΩîÏä§Í∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§!",
          "alert.addPlaces": "ÏΩîÏä§Ïóê Ïû•ÏÜåÎ•º Ï∂îÍ∞ÄÌï¥Ï£ºÏÑ∏Ïöî üìç",
          "alert.courseNamePrompt": "ÏΩîÏä§ Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî ‚ú®",
          "alert.courseNameDefault": "ÎÇòÏùò K-Ïó¨Ìñâ ÏΩîÏä§",
          "alert.courseSaved": "üéâ Ï†ÄÏû• ÏôÑÎ£å!\nÏΩîÏä§ ID: ",
          "alert.saveFailed": "Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§ üò¢",
          "alert.noSavedCourses": "Ï†ÄÏû•Îêú ÏΩîÏä§Í∞Ä ÏóÜÏäµÎãàÎã§ üì≠",
          "alert.courseLoaded": '‚ú® "{name}" ÏΩîÏä§Î•º Î∂àÎü¨ÏôîÏäµÎãàÎã§!',
          "alert.minTwoPlaces":
            "Í≤ΩÎ°úÎ•º Î≥¥Î†§Î©¥ ÏµúÏÜå 2Í∞ú Ïù¥ÏÉÅÏùò Ïû•ÏÜåÍ∞Ä ÌïÑÏöîÌï©ÎãàÎã§ üó∫Ô∏è",
          "alert.routeFailed": "Í≤ΩÎ°ú Í≤ÄÏÉâÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§ üò¢",
          "alert.added": "‚ú® {name}Ïù¥(Í∞Ä) ÏΩîÏä§Ïóê Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§!",
          "route.totalDistance": "üìè Ï¥ù Í±∞Î¶¨: ",
          "route.estimatedTime": "‚è±Ô∏è ÏòàÏÉÅ ÏãúÍ∞Ñ: ",
          "route.info": "üöó Í≤ΩÎ°ú Ï†ïÎ≥¥",
          "text.places": "Í∞ú Ïû•ÏÜå",
          "text.km": " km",
          "text.min": " Î∂Ñ",
        },
        en: {
          "header.title": "üá∞üá∑ K-Content Travel Map",
          "header.subtitle":
            "Create your special travel course with Korean Wave content",
          "btn.home": "Home",
          "section.search": "üîç Search",
          "tab.place": "Search Place",
          "tab.content": "Search Content",
          "placeholder.placeSearch": "Search place name, address...",
          "btn.search": "Search",
          "option.selectContent": "Select content...",
          "option.selectUser": "Select user...",
          "section.myCourse": "üìç My Travel Course",
          "hint.dragOrder": "You can change the order by dragging",
          "btn.saveCourse": "üíæ Save Course",
          "btn.showRoute": "üöó Show Route",
          "btn.aiRecommend": "ü§ñ AI Recommend",
          "section.savedCourses": "üíé Saved Courses",
          "user.user1": "User 1",
          "user.user2": "User 2",
          "user.user3": "User 3",
          "btn.load": "Load",
          "btn.delete": "Delete",
          "btn.addToCourse": "+ Add to Course",
          "alert.enterSearch": "Please enter a search term üòä",
          "alert.noResults": "No results found üò¢",
          "alert.selectContent": "Please select content üòä",
          "alert.selectUser": "Please select a user üòä",
          "alert.noLocations": "No filming locations for this content üò¢",
          "alert.deleteCourse": "Do you want to delete this course? üóëÔ∏è",
          "alert.courseDeleted": "‚úÖ Course deleted!",
          "alert.addPlaces": "Please add places to the course üìç",
          "alert.courseNamePrompt": "Enter course name ‚ú®",
          "alert.courseNameDefault": "My K-Travel Course",
          "alert.courseSaved": "üéâ Saved!\nCourse ID: ",
          "alert.saveFailed": "Failed to save üò¢",
          "alert.noSavedCourses": "No saved courses üì≠",
          "alert.courseLoaded": '‚ú® Loaded "{name}" course!',
          "alert.minTwoPlaces": "At least 2 places needed to show route üó∫Ô∏è",
          "alert.routeFailed": "Failed to search route üò¢",
          "alert.added": "‚ú® {name} has been added to the course!",
          "route.totalDistance": "üìè Total Distance: ",
          "route.estimatedTime": "‚è±Ô∏è Estimated Time: ",
          "route.info": "üöó Route Info",
          "text.places": " places",
          "text.km": " km",
          "text.min": " min",
        },
        ja: {
          "header.title": "üá∞üá∑ K„Ç≥„É≥„ÉÜ„É≥„ÉÑÊóÖË°å„Éû„ÉÉ„Éó",
          "header.subtitle":
            "ÈüìÊµÅ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Å®‰∏ÄÁ∑í„Å´ÁâπÂà•„Å™ÊóÖË°å„Ç≥„Éº„Çπ„Çí‰Ωú„Å£„Å¶„Åø„Åæ„Åó„Çá„ÅÜ",
          "btn.home": "„Éõ„Éº„É†",
          "section.search": "üîç Ê§úÁ¥¢",
          "tab.place": "Â†¥ÊâÄÊ§úÁ¥¢",
          "tab.content": "„Ç≥„É≥„ÉÜ„É≥„ÉÑÊ§úÁ¥¢",
          "placeholder.placeSearch": "Â†¥ÊâÄÂêç„ÄÅ‰ΩèÊâÄ„ÇíÊ§úÁ¥¢...",
          "btn.search": "Ê§úÁ¥¢",
          "option.selectContent": "„Ç≥„É≥„ÉÜ„É≥„ÉÑÈÅ∏Êäû...",
          "option.selectUser": "„É¶„Éº„Ç∂„ÉºÈÅ∏Êäû...",
          "section.myCourse": "üìç „Éû„Ç§ÊóÖË°å„Ç≥„Éº„Çπ",
          "hint.dragOrder": "„Éâ„É©„ÉÉ„Ç∞„ÅßÈ†ÜÂ∫è„ÇíÂ§âÊõ¥„Åß„Åç„Åæ„Åô",
          "btn.saveCourse": "üíæ „Ç≥„Éº„Çπ‰øùÂ≠ò",
          "btn.showRoute": "üöó „É´„Éº„ÉàÁ¢∫Ë™ç",
          "btn.aiRecommend": "ü§ñ AI„Åä„Åô„Åô„ÇÅ",
          "section.savedCourses": "üíé ‰øùÂ≠ò„Åï„Çå„Åü„Ç≥„Éº„Çπ",
          "user.user1": "„É¶„Éº„Ç∂„Éº1",
          "user.user2": "„É¶„Éº„Ç∂„Éº2",
          "user.user3": "„É¶„Éº„Ç∂„Éº3",
          "btn.load": "Ë™≠„ÅøËæº„ÇÄ",
          "btn.delete": "ÂâäÈô§",
          "btn.addToCourse": "+ „Ç≥„Éº„ÇπËøΩÂä†",
          "alert.enterSearch": "Ê§úÁ¥¢Ë™û„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ üòä",
          "alert.noResults": "Ê§úÁ¥¢ÁµêÊûú„Åå„ÅÇ„Çä„Åæ„Åõ„Çì üò¢",
          "alert.selectContent": "„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ üòä",
          "alert.selectUser": "„É¶„Éº„Ç∂„Éº„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ üòä",
          "alert.noLocations": "„Åì„ÅÆ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅÆÊíÆÂΩ±Âú∞„Åå„ÅÇ„Çä„Åæ„Åõ„Çì üò¢",
          "alert.deleteCourse": "„Åì„ÅÆ„Ç≥„Éº„Çπ„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü üóëÔ∏è",
          "alert.courseDeleted": "‚úÖ „Ç≥„Éº„Çπ„ÅåÂâäÈô§„Åï„Çå„Åæ„Åó„ÅüÔºÅ",
          "alert.addPlaces": "„Ç≥„Éº„Çπ„Å´Â†¥ÊâÄ„ÇíËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ üìç",
          "alert.courseNamePrompt": "„Ç≥„Éº„ÇπÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ ‚ú®",
          "alert.courseNameDefault": "„Éû„Ç§K-ÊóÖË°å„Ç≥„Éº„Çπ",
          "alert.courseSaved": "üéâ ‰øùÂ≠òÂÆå‰∫ÜÔºÅ\n„Ç≥„Éº„ÇπID: ",
          "alert.saveFailed": "‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü üò¢",
          "alert.noSavedCourses": "‰øùÂ≠ò„Åï„Çå„Åü„Ç≥„Éº„Çπ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì üì≠",
          "alert.courseLoaded": '‚ú® "{name}" „Ç≥„Éº„Çπ„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„ÅüÔºÅ',
          "alert.minTwoPlaces":
            "„É´„Éº„Éà„ÇíË°®Á§∫„Åô„Çã„Å´„ÅØÊúÄ‰Ωé2„Å§„ÅÆÂ†¥ÊâÄ„ÅåÂøÖË¶Å„Åß„Åô üó∫Ô∏è",
          "alert.routeFailed": "„É´„Éº„ÉàÊ§úÁ¥¢„Å´Â§±Êïó„Åó„Åæ„Åó„Åü üò¢",
          "alert.added": "‚ú® {name}„Åå„Ç≥„Éº„Çπ„Å´ËøΩÂä†„Åï„Çå„Åæ„Åó„ÅüÔºÅ",
          "route.totalDistance": "üìè Á∑èË∑ùÈõ¢: ",
          "route.estimatedTime": "‚è±Ô∏è ‰∫àÊÉ≥ÊôÇÈñì: ",
          "route.info": "üöó „É´„Éº„ÉàÊÉÖÂ†±",
          "text.places": " ÁÆáÊâÄ",
          "text.km": " km",
          "text.min": " ÂàÜ",
        },
      };

      // ÌòÑÏû¨ Ïñ∏Ïñ¥ (Í∏∞Î≥∏Í∞í: ÌïúÍµ≠Ïñ¥)
      let currentLang = localStorage.getItem("language") || "ko";

      // Ïñ∏Ïñ¥ Î≥ÄÍ≤Ω Ìï®Ïàò
      function changeLanguage(lang) {
        currentLang = lang;
        localStorage.setItem("language", lang);

        // Î™®Îì† data-i18n ÏÜçÏÑ±ÏùÑ Í∞ÄÏßÑ ÏöîÏÜå Î≤àÏó≠
        document.querySelectorAll("[data-i18n]").forEach((element) => {
          const key = element.getAttribute("data-i18n");
          if (translations[lang] && translations[lang][key]) {
            element.textContent = translations[lang][key];
          }
        });

        // placeholder Î≤àÏó≠
        document
          .querySelectorAll("[data-i18n-placeholder]")
          .forEach((element) => {
            const key = element.getAttribute("data-i18n-placeholder");
            if (translations[lang] && translations[lang][key]) {
              element.placeholder = translations[lang][key];
            }
          });
      }

      // Î≤àÏó≠ Ìï®Ïàò (alert Îì±ÏóêÏÑú ÏÇ¨Ïö©)
      function t(key, params = {}) {
        let text = translations[currentLang][key] || key;
        Object.keys(params).forEach((param) => {
          text = text.replace(`{${param}}`, params[param]);
        });
        return text;
      }

      // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ï†ÄÏû•Îêú Ïñ∏Ïñ¥Î°ú ÏÑ§Ï†ï
      document.addEventListener("DOMContentLoaded", () => {
        const langSelector = document.getElementById("languageSelector");
        langSelector.value = currentLang;
        changeLanguage(currentLang);

        langSelector.addEventListener("change", (e) => {
          changeLanguage(e.target.value);
        });
      });

      let currentSearchMode = "place";
      let contentsData = [];

      // Í≤ÄÏÉâ Î™®Îìú Ï†ÑÌôò
      window.switchSearchMode = function (mode) {
        currentSearchMode = mode;
        document.getElementById("placeSearchMode").style.display =
          mode === "place" ? "block" : "none";
        document.getElementById("contentSearchMode").style.display =
          mode === "content" ? "block" : "none";

        // ÌÉ≠ Î≤ÑÌäº ÌôúÏÑ±Ìôî ÌëúÏãú
        document.querySelectorAll(".tab-btn").forEach((btn, idx) => {
          btn.classList.remove("active");
          if (
            (idx === 0 && mode === "place") ||
            (idx === 1 && mode === "content")
          ) {
            btn.classList.add("active");
          }
        });

        // ÏΩòÌÖêÏ∏† Î™®ÎìúÏùº Îïå ÏΩòÌÖêÏ∏† Î™©Î°ù Î°úÎìú
        if (mode === "content" && contentsData.length === 0) {
          loadContentsList();
        }
      };

      // ÏΩòÌÖêÏ∏† Î™©Î°ù Î°úÎìú
      async function loadContentsList() {
        try {
          const res = await fetch("/api/contents");
          contentsData = await res.json();

          const select = document.getElementById("contentSelect");
          select.innerHTML = '<option value="">ÏΩòÌÖêÏ∏† ÏÑ†ÌÉù...</option>';

          // Ï§ëÎ≥µ Ï†úÍ±∞ (contents Í∏∞Ï§Ä)
          const uniqueContents = [
            ...new Map(
              contentsData.map((item) => [item.contents, item])
            ).values(),
          ];

          uniqueContents.forEach((content) => {
            const option = document.createElement("option");
            option.value = content.contents; // contents ÏÇ¨Ïö©
            option.textContent = `${content.contents}`;
            select.appendChild(option);
          });
        } catch (err) {
          console.error(err);
        }
      }

      // Kakao Maps SDK Î°úÎìú ÎåÄÍ∏∞ Î∞è Ï¥àÍ∏∞Ìôî
      function initKakaoMap() {
        if (typeof kakao === 'undefined' || !kakao.maps) {
          console.log('Kakao Maps SDK Î°úÎìú ÎåÄÍ∏∞ Ï§ë...');
          setTimeout(initKakaoMap, 100);
          return;
        }

        kakao.maps.load(function () {
        var map = new kakao.maps.Map(document.getElementById("map"), {
          center: new kakao.maps.LatLng(37.5665, 126.978),
          level: 5,
        });
        

        let markers = [];
        let myCourse = [];
        let routePolyline = null;
        let currentInfoWindow = null;

        // ÎìúÎûòÍ∑∏ Ïï§ ÎìúÎ°≠ Í∏∞Îä•
        const courseList = document.getElementById("courseList");
        let draggedElement = null;

        courseList.addEventListener("dragstart", (e) => {
          draggedElement = e.target.closest("li");
          draggedElement?.classList.add("dragging");
        });

        courseList.addEventListener("dragend", (e) => {
          e.target.closest("li")?.classList.remove("dragging");
        });

        courseList.addEventListener("dragover", (e) => {
          e.preventDefault();
          const afterElement = getDragAfterElement(courseList, e.clientY);
          const dragging = document.querySelector(".dragging");
          if (afterElement == null) {
            courseList.appendChild(dragging);
          } else {
            courseList.insertBefore(dragging, afterElement);
          }
        });

        courseList.addEventListener("drop", (e) => {
          e.preventDefault();
          updateCourseOrder();
        });

        function getDragAfterElement(container, y) {
          const draggableElements = [
            ...container.querySelectorAll("li:not(.dragging)"),
          ];
          return draggableElements.reduce(
            (closest, child) => {
              const box = child.getBoundingClientRect();
              const offset = y - box.top - box.height / 2;
              if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
              } else {
                return closest;
              }
            },
            { offset: Number.NEGATIVE_INFINITY }
          ).element;
        }

        function updateCourseOrder() {
          const listItems = courseList.querySelectorAll("li");
          const newOrder = [];
          listItems.forEach((item) => {
            const courseIndex = parseInt(item.dataset.index);
            newOrder.push(myCourse[courseIndex]);
          });
          myCourse = newOrder;
          renderCourseList();
        }

        function renderCourseList() {
          courseList.innerHTML = "";
          myCourse.forEach((place, index) => {
            const li = document.createElement("li");
            li.draggable = true;
            li.dataset.index = index;
            li.innerHTML = `
              <div class="course-item-info">
                <strong>${index + 1}. ${place.name}</strong>
                <small>${
                  place.mediaTitle ? `üì∫ ${place.mediaTitle}` : ""
                }</small>
              </div>
              <button class="remove-btn" data-i18n="btn.delete" onclick="removeCourse(${index})">ÏÇ≠Ï†ú</button>
            `;
            courseList.appendChild(li);
          });
        }

        window.removeCourse = function (index) {
          myCourse.splice(index, 1);
          renderCourseList();
        };

        window.addToCourse = function (name, lat, lng, mediaTitle, placeId) {
          myCourse.push({ name, lat, lng, mediaTitle, placeId });
          renderCourseList();

          if (currentInfoWindow) {
            currentInfoWindow.close();
            currentInfoWindow = null;
          }

          alert(t("alert.added", { name }));
        };

        window.closeInfoWindow = function () {
          if (currentInfoWindow) {
            currentInfoWindow.close();
            currentInfoWindow = null;
          }
        };

        window.deleteCourse = async function (courseId) {
          if (!confirm(t("alert.deleteCourse"))) return;

          try {
            const res = await fetch(`/api/course/${courseId}`, {
              method: "DELETE",
            });
            const data = await res.json();

            if (data.success) {
              alert(t("alert.courseDeleted"));
              // ÏΩîÏä§ Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
              document.getElementById("loadCoursesBtn").click();
            } else {
              alert("Delete failed: " + data.error);
            }
          } catch (err) {
            console.error(err);
            alert(t("alert.saveFailed"));
          }
        };

        // Ïû•ÏÜå Í≤ÄÏÉâ Í∏∞Îä•
        document.getElementById("searchBtn").onclick = async function () {
          const query = document.getElementById("searchInput").value;
          if (!query) return alert(t("alert.enterSearch"));

          try {
            const res = await fetch(
              `/api/search?q=${encodeURIComponent(query)}`
            );
            const data = await res.json();

            markers.forEach((m) => m.setMap(null));
            markers = [];

            if (data.documents.length === 0) {
              alert(t("alert.noResults"));
              return;
            }

            data.documents.forEach((place) => {
              const marker = new kakao.maps.Marker({
                map,
                position: new kakao.maps.LatLng(place.y, place.x),
              });

              const info = new kakao.maps.InfoWindow({
                content: `<div class="custom-info">
                          <div class="info-header">
                            <div class="info-title">
                              <strong>${place.place_name}</strong>
                              <small>${
                                place.media_title ? place.media_title : ""
                              }</small>
                            </div>
                            <button onclick="closeInfoWindow()" class="info-close">‚úï</button>
                          </div>
                          <button onclick='addToCourse("${place.place_name}", ${
                  place.y
                }, ${place.x}, "${place.media_title || ""}", ${
                  place.place_id || "null"
                })' class="info-add-btn" data-i18n="btn.addToCourse">+ ÏΩîÏä§ Ï∂îÍ∞Ä</button>
                        </div>`,
              });

              kakao.maps.event.addListener(marker, "click", () => {
                if (currentInfoWindow) {
                  currentInfoWindow.close();
                }

                if (currentInfoWindow === info) {
                  currentInfoWindow = null;
                } else {
                  info.open(map, marker);
                  currentInfoWindow = info;
                }
              });

              markers.push(marker);
            });

            map.setCenter(
              new kakao.maps.LatLng(data.documents[0].y, data.documents[0].x)
            );
          } catch (err) {
            console.error(err);
            alert(t("alert.routeFailed"));
          }
        };

        // ÏΩòÌÖêÏ∏† Í≤ÄÏÉâ Í∏∞Îä•
        document.getElementById("searchContentBtn").onclick =
          async function () {
            const contentName = document.getElementById("contentSelect").value;
            if (!contentName) return alert(t("alert.selectContent"));

            try {
              const res = await fetch(
                `/api/search-by-content?name=${encodeURIComponent(contentName)}`
              );
              const data = await res.json();

              markers.forEach((m) => m.setMap(null));
              markers = [];

              if (data.documents.length === 0) {
                alert(t("alert.noLocations"));
                return;
              }

              data.documents.forEach((place) => {
                const marker = new kakao.maps.Marker({
                  map,
                  position: new kakao.maps.LatLng(place.y, place.x),
                });

                const info = new kakao.maps.InfoWindow({
                  content: `<div class="custom-info">
                          <div class="info-header">
                            <div class="info-title">
                              <strong>${place.place_name}</strong>
                              <small>${place.media_title}</small>
                            </div>
                            <button onclick="closeInfoWindow()" class="info-close">‚úï</button>
                          </div>
                          <button onclick='addToCourse("${place.place_name}", ${place.y}, ${place.x}, "${place.media_title}", ${place.place_id})' class="info-add-btn">+ ÏΩîÏä§ Ï∂îÍ∞Ä</button>
                        </div>`,
                });

                kakao.maps.event.addListener(marker, "click", () => {
                  if (currentInfoWindow) {
                    currentInfoWindow.close();
                  }

                  if (currentInfoWindow === info) {
                    currentInfoWindow = null;
                  } else {
                    info.open(map, marker);
                    currentInfoWindow = info;
                  }
                });

                markers.push(marker);
              });

              if (data.documents.length > 0) {
                map.setCenter(
                  new kakao.maps.LatLng(
                    data.documents[0].y,
                    data.documents[0].x
                  )
                );
              }
            } catch (err) {
              console.error(err);
              alert(t("alert.routeFailed"));
            }
          };

        // ÏóîÌÑ∞ÌÇ§Î°ú Í≤ÄÏÉâ
        document
          .getElementById("searchInput")
          .addEventListener("keypress", (e) => {
            if (e.key === "Enter") {
              document.getElementById("searchBtn").click();
            }
          });

        // ÏΩîÏä§ Ï†ÄÏû•
        document.getElementById("saveBtn").onclick = async function () {
          // Î°úÍ∑∏Ïù∏ Ï≤¥ÌÅ¨
          if (!window.currentUser) {
            if (
              confirm("Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§. Î°úÍ∑∏Ïù∏ ÌéòÏù¥ÏßÄÎ°ú Ïù¥ÎèôÌïòÏãúÍ≤†ÏäµÎãàÍπå?")
            ) {
              window.location.href = "/auth";
            }
            return;
          }

          if (myCourse.length === 0) return alert(t("alert.addPlaces"));

          const userId = window.currentUser.id; // Î°úÍ∑∏Ïù∏Ìïú ÏÇ¨Ïö©Ïûê ID ÏÇ¨Ïö©
          const name = prompt(
            t("alert.courseNamePrompt"),
            t("alert.courseNameDefault")
          );
          if (!name) return;

          try {
            const res = await fetch("/api/course", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ userId, name, places: myCourse }),
            });
            const data = await res.json();
            if (data.success) {
              alert(t("alert.courseSaved") + data.courseId);
              myCourse = [];
              renderCourseList();
            } else {
              alert(t("alert.saveFailed"));
            }
          } catch (err) {
            console.error(err);
            alert(t("alert.saveFailed"));
          }
        };

        // Ï†ÄÏû•Îêú ÏΩîÏä§ Î∂àÎü¨Ïò§Í∏∞
        document.getElementById("loadCoursesBtn").onclick = async function () {
          // Î°úÍ∑∏Ïù∏ Ï≤¥ÌÅ¨
          if (!window.currentUser) {
            if (
              confirm("Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§. Î°úÍ∑∏Ïù∏ ÌéòÏù¥ÏßÄÎ°ú Ïù¥ÎèôÌïòÏãúÍ≤†ÏäµÎãàÍπå?")
            ) {
              window.location.href = "/auth";
            }
            return;
          }

          const userId = window.currentUser.id; // Î°úÍ∑∏Ïù∏Ìïú ÏÇ¨Ïö©Ïûê ID ÏÇ¨Ïö©

          try {
            const res = await fetch(`/api/course/${userId}`);
            const courses = await res.json();

            const container = document.getElementById("savedCourses");
            container.innerHTML = "";

            if (courses.length === 0) {
              container.innerHTML = `<p style='text-align:center; color:#999; padding:20px;'>${t(
                "alert.noSavedCourses"
              )}</p>`;
              return;
            }

            courses.forEach((course) => {
              const div = document.createElement("div");
              div.className = "saved-course";
              div.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: start;">
                  <div style="flex: 1;">
                    <strong>üéØ ${course.name}</strong><br>
                    <small>üìç ${course.course_places.length}Í∞ú Ïû•ÏÜå</small>
                  </div>
                  <button onclick="deleteCourse(${course.id})" data-i18n="btn.delete" style="background: #FF4D8D; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; margin-left: 8px;">ÏÇ≠Ï†ú</button>
                </div>
              `;
              div.onclick = (e) => {
                if (e.target.closest("button")) return; // ÏÇ≠Ï†ú Î≤ÑÌäº ÌÅ¥Î¶≠ Ïãú Ï†úÏô∏
                loadCourse(course);
              };
              container.appendChild(div);
            });
          } catch (err) {
            console.error(err);
            alert(t("alert.saveFailed"));
          }
        };

        // Ïª§Ïä§ÌÖÄ ÎßàÏª§ ÏÉùÏÑ± Ìï®Ïàò
        function createCustomMarker(position, label, isStart, isEnd) {
          let bgColor = "#3A8DFF"; // Í∏∞Î≥∏ ÌååÎûÄÏÉâ
          if (isStart) bgColor = "#4CAF50"; // Ï∂úÎ∞ú: Ï¥àÎ°ùÏÉâ
          if (isEnd) bgColor = "#FF4D8D"; // ÎèÑÏ∞©: Î∂ÑÌôçÏÉâ

          const content = document.createElement("div");
          content.style.cssText = `
            position: relative;
            width: 36px;
            height: 36px;
            background: ${bgColor};
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 3px 8px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 14px;
            cursor: pointer;
            transition: transform 0.2s ease;
          `;

          content.innerHTML = label;
          content.onmouseover = () => (content.style.transform = "scale(1.2)");
          content.onmouseout = () => (content.style.transform = "scale(1)");

          const customOverlay = new kakao.maps.CustomOverlay({
            position: position,
            content: content,
            yAnchor: 0.5,
          });

          return customOverlay;
        }

        function loadCourse(course) {
          markers.forEach((m) => m.setMap(null));
          markers = [];

          if (routePolyline) {
            routePolyline.setMap(null);
            routePolyline = null;
          }

          myCourse = course.course_places
            .sort((a, b) => a.order_index - b.order_index)
            .map((p) => ({
              name: p.place_name,
              lat: p.lat,
              lng: p.lng,
              mediaTitle: p.media_title,
              placeId: p.place_id,
            }));

          renderCourseList();

          myCourse.forEach((place, index) => {
            const isStart = index === 0;
            const isEnd = index === myCourse.length - 1;
            const position = new kakao.maps.LatLng(place.lat, place.lng);

            const customMarker = createCustomMarker(
              position,
              index + 1,
              isStart,
              isEnd
            );
            customMarker.setMap(map);
            markers.push(customMarker);
          });

          if (myCourse.length > 0) {
            map.setCenter(
              new kakao.maps.LatLng(myCourse[0].lat, myCourse[0].lng)
            );
          }

          alert(t("alert.courseLoaded", { name: course.name }));
        }

        // AI Ï∂îÏ≤úÎ∞õÍ∏∞
        document.getElementById("aiRecommendBtn").onclick = function () {
          window.location.href = "/aiCourse";
        };

        // Í≤ΩÎ°ú Î≥¥Í∏∞
        document.getElementById("showRouteBtn").onclick = async function () {
          if (myCourse.length < 2) {
            return alert(t("alert.minTwoPlaces"));
          }

          // Í∏∞Ï°¥ ÎßàÏª§ Ï†úÍ±∞ ÌõÑ Ïª§Ïä§ÌÖÄ ÎßàÏª§Î°ú Ïû¨ÏÉùÏÑ±
          markers.forEach((m) => m.setMap(null));
          markers = [];

          if (routePolyline) {
            routePolyline.setMap(null);
          }

          try {
            let totalDistance = 0;
            let totalDuration = 0;
            const pathCoords = [];

            for (let i = 0; i < myCourse.length - 1; i++) {
              const start = myCourse[i];
              const end = myCourse[i + 1];

              const res = await fetch(
                `/api/route?startLng=${start.lng}&startLat=${start.lat}&endLng=${end.lng}&endLat=${end.lat}`
              );
              const data = await res.json();

              console.log("Í≤ΩÎ°ú API ÏùëÎãµ:", data);

              if (data.routes && data.routes.length > 0) {
                const route = data.routes[0];

                // ÏùëÎãµ Íµ¨Ï°∞ ÌôïÏù∏
                if (route.summary) {
                  totalDistance += route.summary.distance || 0;
                  totalDuration += route.summary.duration || 0;
                }

                // Í≤ΩÎ°ú Ï¢åÌëú Ï∂îÏ∂ú
                if (route.sections) {
                  route.sections.forEach((section) => {
                    if (section.roads) {
                      section.roads.forEach((road) => {
                        if (road.vertexes) {
                          road.vertexes.forEach((vertex, idx) => {
                            if (idx % 2 === 0) {
                              pathCoords.push(
                                new kakao.maps.LatLng(
                                  road.vertexes[idx + 1],
                                  road.vertexes[idx]
                                )
                              );
                            }
                          });
                        }
                      });
                    }
                  });
                }
              }
            }

            // Ïª§Ïä§ÌÖÄ ÎßàÏª§ ÏÉùÏÑ± (Í≤ΩÎ°ú ÌëúÏãú ÌõÑ)
            myCourse.forEach((place, index) => {
              const isStart = index === 0;
              const isEnd = index === myCourse.length - 1;
              const position = new kakao.maps.LatLng(place.lat, place.lng);

              const customMarker = createCustomMarker(
                position,
                index + 1,
                isStart,
                isEnd
              );
              customMarker.setMap(map);
              markers.push(customMarker);
            });

            if (pathCoords.length > 0) {
              routePolyline = new kakao.maps.Polyline({
                path: pathCoords,
                strokeWeight: 5,
                strokeColor: "#FF4D8D",
                strokeOpacity: 0.7,
                strokeStyle: "solid",
              });
              routePolyline.setMap(map);
            }

            document.getElementById("routeInfo").innerHTML = `
              <div class="route-info">
                <strong>üöó Í≤ΩÎ°ú Ï†ïÎ≥¥</strong><br>
                <div style="margin-top: 8px; font-size: 14px;">
                  üìè Ï¥ù Í±∞Î¶¨: <strong>${(totalDistance / 1000).toFixed(
                    1
                  )} km</strong><br>
                  ‚è±Ô∏è ÏòàÏÉÅ ÏãúÍ∞Ñ: <strong>${Math.round(
                    totalDuration / 60
                  )} Î∂Ñ</strong>
                </div>
              </div>
            `;
          } catch (err) {
            console.error("Í≤ΩÎ°ú Í≤ÄÏÉâ ÏóêÎü¨:", err);
            alert(t("alert.routeFailed"));
          }
        };
      });
      }

      // ÌéòÏù¥ÏßÄ Î°úÎìú ÏôÑÎ£å ÌõÑ Kakao Maps Ï¥àÍ∏∞Ìôî
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initKakaoMap);
      } else {
        initKakaoMap();
      }
    </script>

    <script>
  // --- Ïú†Ìã∏: ÏøºÎ¶¨ ÌååÎùºÎØ∏ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
  function getQS(name, dflt = null) {
    const v = new URLSearchParams(location.search).get(name);
    return v == null ? dflt : v;
  }

  const toNum = v => (v == null ? NaN : Number(v));

  function performTextSearch(keyword) {
    const input =
      document.querySelector('#searchInput') ||             
      document.querySelector('input[placeholder*="Í≤ÄÏÉâ"]');   
    const btn =
      document.querySelector('#searchBtn') ||              
      Array.from(document.querySelectorAll('button'))
        .find(b => /Í≤ÄÏÉâ/.test(b.textContent));

    if (input) input.value = keyword || '';
    if (btn) btn.click();
  }

  function addDirectMarker(lat, lng, title) {
    if (isNaN(lat) || isNaN(lng) || !window.kakao || !window.map) return;
    const pos = new kakao.maps.LatLng(lat, lng);
    map.setCenter(pos);
    const marker = new kakao.maps.Marker({ position: pos, title: title || '' });
    marker.setMap(map);
  }

  function initFromQuery() {
    const name = getQS('name', '').trim();
    const lat = toNum(getQS('lat'));
    const lng = toNum(getQS('lng'));

    if (!name && isNaN(lat) && isNaN(lng)) return;

    if (name) performTextSearch(name);

    if (!isNaN(lat) && !isNaN(lng)) addDirectMarker(lat, lng, name);
  }

  document.addEventListener('DOMContentLoaded', initFromQuery);
</script>



  </body>
</html>
