<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>K-ì½˜í…ì¸  ì§€ë„</title>
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <meta property="og:image" content="/og-image.jpg">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="K-Spot">
    <script src="/libs/nav-manager.js" type="module"></script>
    <link rel="stylesheet" href="../index/style.css" />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Pretendard", -apple-system, BlinkMacSystemFont, sans-serif;
        background: linear-gradient(135deg, #f5e6d3 0%, #ffffff 100%);
        min-height: 100vh;
      }

      header:not(.header) {
        background: linear-gradient(135deg, #ff4d8d 0%, #3a8dff 100%);
        color: white;
        padding: 20px 30px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      header h1 {
        font-size: 28px;
        font-weight: 700;
        letter-spacing: -0.5px;
      }

      header p {
        font-size: 14px;
        opacity: 0.9;
        margin-top: 5px;
      }

      .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .header-right {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .home-btn {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 2px solid white;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        font-size: 14px;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-block;
      }

      .home-btn:hover {
        background: white;
        color: #ff4d8d;
      }

      header:not(.header) .lang-select {
        background: rgba(255, 255, 255, 0.1);
        color: white;
        border: 2px solid white;
        padding: 10px 10px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        font-size: 14px;
        transition: all 0.3s ease;
      }

      header:not(.header) .lang-select:hover {
        background: rgba(255, 255, 255, 0.1);
      }

      header:not(.header) .lang-select option {
        background: #ff4d8d;
        color: white;
      }

      .header .lang-select {
        background: white !important;
        color: #333 !important;
      }

      .header .lang-select option {
        background: white !important;
        color: #333 !important;
      }

      .container {
        display: flex;
        gap: 20px;
        padding: 20px;
        max-width: 1600px;
        margin: 0 auto;
      }

      .left-panel {
        flex: 1;
        max-width: 420px;
      }

      .map-container {
        flex: 2;
      }

      #map {
        width: 100%;
        height: 700px;
        border-radius: 16px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        overflow: hidden;
      }

      input,
      button,
      select {
        padding: 12px 16px;
        margin: 5px;
        border-radius: 8px;
        border: 2px solid transparent;
        font-size: 14px;
        transition: all 0.3s ease;
      }

      input:focus,
      select:focus {
        outline: none;
        border-color: #3a8dff;
      }

      button {
        cursor: pointer;
        font-weight: 600;
        border: none;
      }

      button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .section {
        background: white;
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 16px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(58, 141, 255, 0.1);
      }

      .section h3 {
        margin-top: 0;
        margin-bottom: 15px;
        color: #1a1a1a;
        font-size: 18px;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .search-section {
        border-top: 3px solid #ff4d8d;
      }

      .course-section {
        border-top: 3px solid #3a8dff;
      }

      .saved-section {
        border-top: 3px solid #f5e6d3;
      }

      .search-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 12px;
      }

      .tab-btn {
        flex: 1;
        padding: 8px 12px;
        background: #f5e6d3;
        color: #1a1a1a;
        border: 2px solid #f5e6d3;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        font-size: 13px;
        transition: all 0.3s ease;
      }

      .tab-btn.active {
        background: #3a8dff;
        color: white;
        border-color: #3a8dff;
      }

      .search-input-group {
        display: flex;
        gap: 5px;
      }

      #searchInput,
      #contentSelect {
        flex: 1;
      }

      #searchBtn {
        background: linear-gradient(135deg, #ff4d8d 0%, #ff6b9d 100%);
        color: white;
        padding: 12px 20px;
      }

      #courseList {
        list-style: none;
        padding: 0;
        min-height: 120px;
        background: #fafafa;
        border: 2px dashed #f5e6d3;
        border-radius: 12px;
        padding: 10px;
      }

      #courseList:empty::before {
        content: "ì¥ì†Œë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš” ğŸ“";
        display: block;
        text-align: center;
        color: #999;
        padding: 40px;
      }

      #courseList li {
        padding: 14px 16px;
        margin: 8px 0;
        background: linear-gradient(135deg, #ffffff 0%, #f5f5f5 100%);
        border-radius: 10px;
        cursor: move;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        border-left: 4px solid #3a8dff;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        transition: all 0.3s ease;
      }

      #courseList li:hover {
        transform: translateX(4px);
        box-shadow: 0 4px 12px rgba(58, 141, 255, 0.2);
      }

      #courseList li.dragging {
        opacity: 0.5;
        transform: scale(0.95);
      }

      .course-item-info {
        flex: 1;
      }

      .course-item-info strong {
        display: block;
        color: #1a1a1a;
        margin-bottom: 4px;
      }

      .course-item-info small {
        color: #999;
        font-size: 12px;
      }

      .remove-btn {
        background: #ff4d8d;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 12px;
        font-weight: 600;
        margin-left: 10px;
      }

      .remove-btn:hover {
        background: #ff3377;
      }

      #saveBtn {
        width: 100%;
        background: linear-gradient(135deg, #3a8dff 0%, #5ba3ff 100%);
        color: white;
        border: none;
        padding: 14px;
        font-size: 15px;
        margin: 10px 5px 5px 5px;
      }

      #showRouteBtn {
        width: 100%;
        background: linear-gradient(135deg, #ff4d8d 0%, #ff6b9d 100%);
        color: white;
        border: none;
        padding: 14px;
        font-size: 15px;
        margin: 5px;
      }

      #savedCourses {
        max-height: 300px;
        overflow-y: auto;
      }

      #savedCourses::-webkit-scrollbar {
        width: 8px;
      }

      #savedCourses::-webkit-scrollbar-thumb {
        background: #3a8dff;
        border-radius: 4px;
      }

      #savedCourses::-webkit-scrollbar-track {
        background: #f5e6d3;
        border-radius: 4px;
      }

      .saved-course {
        background: white;
        padding: 14px;
        margin: 8px 0;
        border-radius: 10px;
        cursor: pointer;
        border: 2px solid #f5e6d3;
        transition: all 0.3s ease;
      }

      .saved-course:hover {
        background: linear-gradient(135deg, #ffffff 0%, #f5e6d3 30%);
        border-color: #3a8dff;
        transform: translateX(4px);
        box-shadow: 0 4px 12px rgba(58, 141, 255, 0.15);
      }

      .saved-course strong {
        color: #1a1a1a;
        font-size: 15px;
        display: block;
      }

      .saved-course small {
        color: #666;
        font-size: 13px;
      }

      .route-info {
        background: linear-gradient(135deg, #f5e6d3 0%, #ffffff 100%);
        padding: 16px;
        margin-top: 10px;
        border-radius: 10px;
        border: 2px solid #3a8dff;
        color: #1a1a1a;
      }

      .route-info strong {
        color: #ff4d8d;
        font-size: 16px;
      }

      select {
        background: white;
        border: 2px solid #f5e6d3;
        color: #1a1a1a;
      }

      #loadCoursesBtn {
        background: #3a8dff;
        color: white;
        padding: 12px 16px;
      }

      #loadCoursesBtn:hover {
        background: #2a7dff;
      }

      .custom-info {
        padding: 12px;
        min-width: 200px;
        background: white;
        border-radius: 8px;
      }

      .info-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 8px;
      }

      .info-title {
        flex: 1;
      }

      .info-title strong {
        display: block;
        color: #1a1a1a;
        font-size: 14px;
        margin-bottom: 4px;
      }

      .info-title small {
        color: #3a8dff;
        font-size: 12px;
        font-weight: 600;
      }

      .info-close {
        background: none;
        border: none;
        font-size: 18px;
        cursor: pointer;
        padding: 0 5px;
        color: #999;
      }

      .info-close:hover {
        color: #ff4d8d;
      }

      .info-add-btn {
        width: 100%;
        padding: 8px;
        background: linear-gradient(135deg, #3a8dff 0%, #5ba3ff 100%);
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        font-size: 13px;
        margin-top: 8px;
      }

      @media (max-width: 1024px) {
        .container {
          flex-direction: column;
        }

        .left-panel {
          max-width: 100%;
        }
      }
      .header {
        background: rgba(255, 255, 255, 0.95) !important;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08) !important;
        position: sticky !important;
        top: 0 !important;
        z-index: 1000 !important;
        padding: 0 !important;
      }

      .header .container {
        max-width: 1280px !important;
        margin: 0 auto !important;
        padding: 0 2rem !important;
        display: block !important;
      }

      .header-top {
        display: flex !important;
        justify-content: space-between !important;
        align-items: center !important;
        padding: 12px 0 !important;
        border-bottom: 1px solid #eee !important;
      }

      .header .nav {
        display: flex !important;
        justify-content: space-evenly !important;
        align-items: center !important;
        padding: 12px 0 !important;
      }

      .header .nav-link {
        text-decoration: none !important;
        color: #2d3748 !important;
        font-weight: 600 !important;
        font-size: 15px !important;
        padding: 8px 0 !important;
        border-bottom: 3px solid transparent !important;
      }

      .header .nav-link.active {
        color: #e91e8c !important;
        border-bottom-color: #e91e8c !important;
      }

      .header .logo svg {
        height: 45px !important;
        width: 180px !important;
      }

      .header #loginBtn {
        background: #e91e8c !important;
        color: white !important;
        padding: 0 16px !important;
        height: 40px !important;
        border: none !important;
        border-radius: 8px !important;
        cursor: pointer !important;
        font-weight: 600 !important;
        font-size: 14px !important;
        transition: all 0.3s ease !important;
      }

      .header #loginBtn:hover {
        background: #d01a7a !important;
        transform: translateY(-1px) !important;
      }

      .header .btn-search {
        background: transparent !important;
        border: 1px solid #e5e7eb !important;
        width: 40px !important;
        height: 40px !important;
        border-radius: 8px !important;
        cursor: pointer !important;
        font-size: 18px !important;
        transition: all 0.3s ease !important;
      }

      .header .btn-search:hover {
        background: #f9fafb !important;
        border-color: #d1d5db !important;
      }

      .header .home-btn {
        display: none !important;
      }
    </style>
  </head>
  <body>
    <div id="headerPlaceholder"></div>
    <div class="container">
      <div class="left-panel">
        <!-- ì¥ì†Œ ê²€ìƒ‰ -->
        <div class="section search-section">
          <h3 data-i18n="section.search">ğŸ” ê²€ìƒ‰</h3>

          <!-- íƒ­ ì„ íƒ -->
          <div class="search-tabs">
            <button
              class="tab-btn active"
              onclick="switchSearchMode('place')"
              data-i18n="tab.place"
            >
              ì¥ì†Œ ê²€ìƒ‰
            </button>
            <button
              class="tab-btn"
              onclick="switchSearchMode('content')"
              data-i18n="tab.content"
            >
              ì½˜í…ì¸  ê²€ìƒ‰
            </button>
          </div>

          <!-- ì¥ì†Œ ê²€ìƒ‰ ëª¨ë“œ -->
          <div id="placeSearchMode">
            <div class="search-input-group">
              <input
                type="text"
                id="searchInput"
                data-i18n-placeholder="placeholder.placeSearch"
                placeholder="ì¥ì†Œëª…, ì£¼ì†Œ ê²€ìƒ‰..."
              />
              <button id="searchBtn" data-i18n="btn.search">ê²€ìƒ‰</button>
            </div>
          </div>

          <!-- ì½˜í…ì¸  ê²€ìƒ‰ ëª¨ë“œ -->
          <div id="contentSearchMode" style="display: none">
            <select id="contentSelect">
              <option value="" data-i18n="option.selectContent">
                ì½˜í…ì¸  ì„ íƒ...
              </option>
            </select>
            <button
              id="searchContentBtn"
              data-i18n="btn.search"
              style="
                width: 100%;
                background: #3a8dff;
                color: white;
                padding: 10px;
                margin-top: 8px;
              "
            >
              ê²€ìƒ‰
            </button>
          </div>
        </div>

        <!-- í˜„ì¬ ì½”ìŠ¤ -->
        <div class="section course-section">
          <h3 data-i18n="section.myCourse">ğŸ“ ë‚˜ë§Œì˜ ì—¬í–‰ ì½”ìŠ¤</h3>
          <p
            style="font-size: 13px; color: #666; margin-bottom: 10px"
            data-i18n="hint.dragOrder"
          >
            ë“œë˜ê·¸ë¡œ ìˆœì„œë¥¼ ë³€ê²½í•  ìˆ˜ ìˆì–´ìš”
          </p>
          <ul id="courseList"></ul>
          <button id="saveBtn" data-i18n="btn.saveCourse">
            ğŸ’¾ ì½”ìŠ¤ ì €ì¥í•˜ê¸°
          </button>
          <button id="showRouteBtn" data-i18n="btn.showRoute">
            ğŸš— ê²½ë¡œ í™•ì¸í•˜ê¸°
          </button>
          <button
            id="aiRecommendBtn"
            data-i18n="btn.aiRecommend"
            style="
              width: 100%;
              background: linear-gradient(135deg, #ff6b9d 0%, #ffa07a 100%);
              color: white;
              border: none;
              padding: 14px;
              font-size: 15px;
              margin: 5px;
            "
          >
            ğŸ¤– AI ì¶”ì²œë°›ê¸°
          </button>
          <div id="routeInfo"></div>
        </div>

        <!-- ì €ì¥ëœ ì½”ìŠ¤ -->
        <div class="section saved-section">
          <h3 data-i18n="section.savedCourses">ğŸ’ ì €ì¥ëœ ì½”ìŠ¤</h3>
          <button id="loadCoursesBtn" data-i18n="btn.load">
            ë‚´ ì½”ìŠ¤ ë¶ˆëŸ¬ì˜¤ê¸°
          </button>
          <div id="savedCourses"></div>
        </div>
      </div>

      <div class="map-container">
        <div id="map"></div>
      </div>
    </div>

    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=8d27848d8e0061837441313b57eba277&libraries=services&autoload=false"></script>
    <script type="module">
      // Supabase Auth ì—°ë™
      import {
        initAuthListener,
        getIsLoggedIn,
        getUserNickname,
        getUserId,
      } from "/libs/user-manager.js";

      window.currentUser = null;

      // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
      async function checkAuth() {
        initAuthListener();
        const isLoggedIn = getIsLoggedIn();
        const userId = getUserId();

        const loginBtn = document.getElementById("loginBtn");
        const langSelect = document.querySelector(".lang-select");
        const searchBtn = document.querySelector(".btn-search");

        if (isLoggedIn && userId) {
          // ë¡œê·¸ì¸ëœ ìƒíƒœ
          const nickname = getUserNickname();
          window.currentUser = { id: userId, nickname };

          // ë¡œê·¸ì¸ ë²„íŠ¼ì„ ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ìœ¼ë¡œ ë³€ê²½
          if (loginBtn) {
            loginBtn.textContent = "ë¡œê·¸ì•„ì›ƒ";
            loginBtn.onclick = async () => {
              const { createClient } = await import(
                "https://esm.sh/@supabase/supabase-js@2"
              );
              const supabase = createClient(
                "https://fmcxkqfccuevcaqkzsex.supabase.co",
                "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZtY3hrcWZjY3VldmNhcWt6c2V4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNzk3MzcsImV4cCI6MjA3NDk1NTczN30.IZ47Juv0ypiX4sWTb1vo54hcMI0yBQol1VhUm37vs7M"
              );
              await supabase.auth.signOut();
              window.location.reload();
            };
          }
        } else {
          // ë¡œê·¸ì¸ ì•ˆ ëœ ìƒíƒœ
          if (loginBtn) {
            loginBtn.onclick = () => {
              window.location.href = "/auth";
            };
          }
        }

        // ì–¸ì–´ ì„ íƒ ê¸°ëŠ¥
        if (langSelect) {
          const savedLang = localStorage.getItem("language") || "ko";
          langSelect.value = savedLang;

          langSelect.addEventListener("change", (e) => {
            localStorage.setItem("language", e.target.value);
            // ì–¸ì–´ ë³€ê²½ í•¨ìˆ˜ê°€ ìˆë‹¤ë©´ í˜¸ì¶œ
            if (typeof changeLanguage === "function") {
              changeLanguage(e.target.value);
            }
          });
        }

        // ê²€ìƒ‰ ë²„íŠ¼ ê¸°ëŠ¥ (í•„ìš”ì‹œ êµ¬í˜„)
        if (searchBtn) {
          searchBtn.addEventListener("click", () => {
            // ê²€ìƒ‰ ê¸°ëŠ¥ êµ¬í˜„
            console.log("ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­");
          });
        }
      }

      checkAuth();
    </script>

    <script>
      // ë‹¤êµ­ì–´ ë²ˆì—­ ë°ì´í„°
      const translations = {
        ko: {
          "header.title": "ğŸ‡°ğŸ‡· K-ì½˜í…ì¸  ì—¬í–‰ ì§€ë„",
          "header.subtitle":
            "í•œë¥˜ ì½˜í…ì¸ ì™€ í•¨ê»˜í•˜ëŠ” íŠ¹ë³„í•œ ì—¬í–‰ ì½”ìŠ¤ë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš”",
          "btn.home": "í™ˆìœ¼ë¡œ",
          "section.search": "ğŸ” ê²€ìƒ‰",
          "tab.place": "ì¥ì†Œ ê²€ìƒ‰",
          "tab.content": "ì½˜í…ì¸  ê²€ìƒ‰",
          "placeholder.placeSearch": "ì¥ì†Œëª…, ì£¼ì†Œ ê²€ìƒ‰...",
          "btn.search": "ê²€ìƒ‰",
          "option.selectContent": "ì½˜í…ì¸  ì„ íƒ...",
          "option.selectUser": "ì‚¬ìš©ì ì„ íƒ...",
          "section.myCourse": "ğŸ“ ë‚˜ë§Œì˜ ì—¬í–‰ ì½”ìŠ¤",
          "hint.dragOrder": "ë“œë˜ê·¸ë¡œ ìˆœì„œë¥¼ ë³€ê²½í•  ìˆ˜ ìˆì–´ìš”",
          "btn.saveCourse": "ğŸ’¾ ì½”ìŠ¤ ì €ì¥í•˜ê¸°",
          "btn.showRoute": "ğŸš— ê²½ë¡œ í™•ì¸í•˜ê¸°",
          "btn.aiRecommend": "ğŸ¤– AI ì¶”ì²œë°›ê¸°",
          "section.savedCourses": "ğŸ’ ì €ì¥ëœ ì½”ìŠ¤",
          "user.user1": "ì‚¬ìš©ì 1",
          "user.user2": "ì‚¬ìš©ì 2",
          "user.user3": "ì‚¬ìš©ì 3",
          "btn.load": "ë¶ˆëŸ¬ì˜¤ê¸°",
          "btn.delete": "ì‚­ì œ",
          "btn.addToCourse": "+ ì½”ìŠ¤ ì¶”ê°€",
          "alert.enterSearch": "ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš” ğŸ˜Š",
          "alert.noResults": "ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤ ğŸ˜¢",
          "alert.selectContent": "ì½˜í…ì¸ ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš” ğŸ˜Š",
          "alert.selectUser": "ì‚¬ìš©ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš” ğŸ˜Š",
          "alert.noLocations": "í•´ë‹¹ ì½˜í…ì¸ ì˜ ì´¬ì˜ì§€ê°€ ì—†ìŠµë‹ˆë‹¤ ğŸ˜¢",
          "alert.deleteCourse": "ì´ ì½”ìŠ¤ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ğŸ—‘ï¸",
          "alert.courseDeleted": "âœ… ì½”ìŠ¤ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!",
          "alert.addPlaces": "ì½”ìŠ¤ì— ì¥ì†Œë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš” ğŸ“",
          "alert.courseNamePrompt": "ì½”ìŠ¤ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš” âœ¨",
          "alert.courseNameDefault": "ë‚˜ì˜ K-ì—¬í–‰ ì½”ìŠ¤",
          "alert.courseSaved": "ğŸ‰ ì €ì¥ ì™„ë£Œ!\nì½”ìŠ¤ ID: ",
          "alert.saveFailed": "ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤ ğŸ˜¢",
          "alert.noSavedCourses": "ì €ì¥ëœ ì½”ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤ ğŸ“­",
          "alert.courseLoaded": 'âœ¨ "{name}" ì½”ìŠ¤ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!',
          "alert.minTwoPlaces":
            "ê²½ë¡œë¥¼ ë³´ë ¤ë©´ ìµœì†Œ 2ê°œ ì´ìƒì˜ ì¥ì†Œê°€ í•„ìš”í•©ë‹ˆë‹¤ ğŸ—ºï¸",
          "alert.routeFailed": "ê²½ë¡œ ê²€ìƒ‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤ ğŸ˜¢",
          "alert.added": "âœ¨ {name}ì´(ê°€) ì½”ìŠ¤ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!",
          "route.totalDistance": "ğŸ“ ì´ ê±°ë¦¬: ",
          "route.estimatedTime": "â±ï¸ ì˜ˆìƒ ì‹œê°„: ",
          "route.info": "ğŸš— ê²½ë¡œ ì •ë³´",
          "text.places": "ê°œ ì¥ì†Œ",
          "text.km": " km",
          "text.min": " ë¶„",
        },
        en: {
          "header.title": "ğŸ‡°ğŸ‡· K-Content Travel Map",
          "header.subtitle":
            "Create your special travel course with Korean Wave content",
          "btn.home": "Home",
          "section.search": "ğŸ” Search",
          "tab.place": "Search Place",
          "tab.content": "Search Content",
          "placeholder.placeSearch": "Search place name, address...",
          "btn.search": "Search",
          "option.selectContent": "Select content...",
          "option.selectUser": "Select user...",
          "section.myCourse": "ğŸ“ My Travel Course",
          "hint.dragOrder": "You can change the order by dragging",
          "btn.saveCourse": "ğŸ’¾ Save Course",
          "btn.showRoute": "ğŸš— Show Route",
          "btn.aiRecommend": "ğŸ¤– AI Recommend",
          "section.savedCourses": "ğŸ’ Saved Courses",
          "user.user1": "User 1",
          "user.user2": "User 2",
          "user.user3": "User 3",
          "btn.load": "Load",
          "btn.delete": "Delete",
          "btn.addToCourse": "+ Add to Course",
          "alert.enterSearch": "Please enter a search term ğŸ˜Š",
          "alert.noResults": "No results found ğŸ˜¢",
          "alert.selectContent": "Please select content ğŸ˜Š",
          "alert.selectUser": "Please select a user ğŸ˜Š",
          "alert.noLocations": "No filming locations for this content ğŸ˜¢",
          "alert.deleteCourse": "Do you want to delete this course? ğŸ—‘ï¸",
          "alert.courseDeleted": "âœ… Course deleted!",
          "alert.addPlaces": "Please add places to the course ğŸ“",
          "alert.courseNamePrompt": "Enter course name âœ¨",
          "alert.courseNameDefault": "My K-Travel Course",
          "alert.courseSaved": "ğŸ‰ Saved!\nCourse ID: ",
          "alert.saveFailed": "Failed to save ğŸ˜¢",
          "alert.noSavedCourses": "No saved courses ğŸ“­",
          "alert.courseLoaded": 'âœ¨ Loaded "{name}" course!',
          "alert.minTwoPlaces": "At least 2 places needed to show route ğŸ—ºï¸",
          "alert.routeFailed": "Failed to search route ğŸ˜¢",
          "alert.added": "âœ¨ {name} has been added to the course!",
          "route.totalDistance": "ğŸ“ Total Distance: ",
          "route.estimatedTime": "â±ï¸ Estimated Time: ",
          "route.info": "ğŸš— Route Info",
          "text.places": " places",
          "text.km": " km",
          "text.min": " min",
        },
        ja: {
          "header.title": "ğŸ‡°ğŸ‡· Kã‚³ãƒ³ãƒ†ãƒ³ãƒ„æ—…è¡Œãƒãƒƒãƒ—",
          "header.subtitle":
            "éŸ“æµã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¨ä¸€ç·’ã«ç‰¹åˆ¥ãªæ—…è¡Œã‚³ãƒ¼ã‚¹ã‚’ä½œã£ã¦ã¿ã¾ã—ã‚‡ã†",
          "btn.home": "ãƒ›ãƒ¼ãƒ ",
          "section.search": "ğŸ” æ¤œç´¢",
          "tab.place": "å ´æ‰€æ¤œç´¢",
          "tab.content": "ã‚³ãƒ³ãƒ†ãƒ³ãƒ„æ¤œç´¢",
          "placeholder.placeSearch": "å ´æ‰€åã€ä½æ‰€ã‚’æ¤œç´¢...",
          "btn.search": "æ¤œç´¢",
          "option.selectContent": "ã‚³ãƒ³ãƒ†ãƒ³ãƒ„é¸æŠ...",
          "option.selectUser": "ãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠ...",
          "section.myCourse": "ğŸ“ ãƒã‚¤æ—…è¡Œã‚³ãƒ¼ã‚¹",
          "hint.dragOrder": "ãƒ‰ãƒ©ãƒƒã‚°ã§é †åºã‚’å¤‰æ›´ã§ãã¾ã™",
          "btn.saveCourse": "ğŸ’¾ ã‚³ãƒ¼ã‚¹ä¿å­˜",
          "btn.showRoute": "ğŸš— ãƒ«ãƒ¼ãƒˆç¢ºèª",
          "btn.aiRecommend": "ğŸ¤– AIãŠã™ã™ã‚",
          "section.savedCourses": "ğŸ’ ä¿å­˜ã•ã‚ŒãŸã‚³ãƒ¼ã‚¹",
          "user.user1": "ãƒ¦ãƒ¼ã‚¶ãƒ¼1",
          "user.user2": "ãƒ¦ãƒ¼ã‚¶ãƒ¼2",
          "user.user3": "ãƒ¦ãƒ¼ã‚¶ãƒ¼3",
          "btn.load": "èª­ã¿è¾¼ã‚€",
          "btn.delete": "å‰Šé™¤",
          "btn.addToCourse": "+ ã‚³ãƒ¼ã‚¹è¿½åŠ ",
          "alert.enterSearch": "æ¤œç´¢èªã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ ğŸ˜Š",
          "alert.noResults": "æ¤œç´¢çµæœãŒã‚ã‚Šã¾ã›ã‚“ ğŸ˜¢",
          "alert.selectContent": "ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’é¸æŠã—ã¦ãã ã•ã„ ğŸ˜Š",
          "alert.selectUser": "ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„ ğŸ˜Š",
          "alert.noLocations": "ã“ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®æ’®å½±åœ°ãŒã‚ã‚Šã¾ã›ã‚“ ğŸ˜¢",
          "alert.deleteCourse": "ã“ã®ã‚³ãƒ¼ã‚¹ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ ğŸ—‘ï¸",
          "alert.courseDeleted": "âœ… ã‚³ãƒ¼ã‚¹ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸï¼",
          "alert.addPlaces": "ã‚³ãƒ¼ã‚¹ã«å ´æ‰€ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ ğŸ“",
          "alert.courseNamePrompt": "ã‚³ãƒ¼ã‚¹åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ âœ¨",
          "alert.courseNameDefault": "ãƒã‚¤K-æ—…è¡Œã‚³ãƒ¼ã‚¹",
          "alert.courseSaved": "ğŸ‰ ä¿å­˜å®Œäº†ï¼\nã‚³ãƒ¼ã‚¹ID: ",
          "alert.saveFailed": "ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ ğŸ˜¢",
          "alert.noSavedCourses": "ä¿å­˜ã•ã‚ŒãŸã‚³ãƒ¼ã‚¹ãŒã‚ã‚Šã¾ã›ã‚“ ğŸ“­",
          "alert.courseLoaded": 'âœ¨ "{name}" ã‚³ãƒ¼ã‚¹ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼',
          "alert.minTwoPlaces":
            "ãƒ«ãƒ¼ãƒˆã‚’è¡¨ç¤ºã™ã‚‹ã«ã¯æœ€ä½2ã¤ã®å ´æ‰€ãŒå¿…è¦ã§ã™ ğŸ—ºï¸",
          "alert.routeFailed": "ãƒ«ãƒ¼ãƒˆæ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸ ğŸ˜¢",
          "alert.added": "âœ¨ {name}ãŒã‚³ãƒ¼ã‚¹ã«è¿½åŠ ã•ã‚Œã¾ã—ãŸï¼",
          "route.totalDistance": "ğŸ“ ç·è·é›¢: ",
          "route.estimatedTime": "â±ï¸ äºˆæƒ³æ™‚é–“: ",
          "route.info": "ğŸš— ãƒ«ãƒ¼ãƒˆæƒ…å ±",
          "text.places": " ç®‡æ‰€",
          "text.km": " km",
          "text.min": " åˆ†",
        },
      };

      // í˜„ì¬ ì–¸ì–´ (ê¸°ë³¸ê°’: í•œêµ­ì–´)
      let currentLang = localStorage.getItem("language") || "ko";

      // ì–¸ì–´ ë³€ê²½ í•¨ìˆ˜
      function changeLanguage(lang) {
        currentLang = lang;
        localStorage.setItem("language", lang);

        // ëª¨ë“  data-i18n ì†ì„±ì„ ê°€ì§„ ìš”ì†Œ ë²ˆì—­
        document.querySelectorAll("[data-i18n]").forEach((element) => {
          const key = element.getAttribute("data-i18n");
          if (translations[lang] && translations[lang][key]) {
            element.textContent = translations[lang][key];
          }
        });

        // placeholder ë²ˆì—­
        document
          .querySelectorAll("[data-i18n-placeholder]")
          .forEach((element) => {
            const key = element.getAttribute("data-i18n-placeholder");
            if (translations[lang] && translations[lang][key]) {
              element.placeholder = translations[lang][key];
            }
          });
      }

      // ë²ˆì—­ í•¨ìˆ˜ (alert ë“±ì—ì„œ ì‚¬ìš©)
      function t(key, params = {}) {
        let text = translations[currentLang][key] || key;
        Object.keys(params).forEach((param) => {
          text = text.replace(`{${param}}`, params[param]);
        });
        return text;
      }

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ì €ì¥ëœ ì–¸ì–´ë¡œ ì„¤ì •
      document.addEventListener("DOMContentLoaded", () => {
        const langSelector = document.getElementById("languageSelector");
        langSelector.value = currentLang;
        changeLanguage(currentLang);

        langSelector.addEventListener("change", (e) => {
          changeLanguage(e.target.value);
        });
      });

      let currentSearchMode = "place";
      let contentsData = [];

      // ê²€ìƒ‰ ëª¨ë“œ ì „í™˜
      window.switchSearchMode = function (mode) {
        currentSearchMode = mode;
        document.getElementById("placeSearchMode").style.display =
          mode === "place" ? "block" : "none";
        document.getElementById("contentSearchMode").style.display =
          mode === "content" ? "block" : "none";

        // íƒ­ ë²„íŠ¼ í™œì„±í™” í‘œì‹œ
        document.querySelectorAll(".tab-btn").forEach((btn, idx) => {
          btn.classList.remove("active");
          if (
            (idx === 0 && mode === "place") ||
            (idx === 1 && mode === "content")
          ) {
            btn.classList.add("active");
          }
        });

        // ì½˜í…ì¸  ëª¨ë“œì¼ ë•Œ ì½˜í…ì¸  ëª©ë¡ ë¡œë“œ
        if (mode === "content" && contentsData.length === 0) {
          loadContentsList();
        }
      };

      // ì½˜í…ì¸  ëª©ë¡ ë¡œë“œ
      async function loadContentsList() {
        try {
          const res = await fetch("/api/contents");
          contentsData = await res.json();

          const select = document.getElementById("contentSelect");
          select.innerHTML = '<option value="">ì½˜í…ì¸  ì„ íƒ...</option>';

          // ì¤‘ë³µ ì œê±° (contents ê¸°ì¤€)
          const uniqueContents = [
            ...new Map(
              contentsData.map((item) => [item.contents, item])
            ).values(),
          ];

          uniqueContents.forEach((content) => {
            const option = document.createElement("option");
            option.value = content.contents; // contents ì‚¬ìš©
            option.textContent = `${content.contents}`;
            select.appendChild(option);
          });
        } catch (err) {
          console.error(err);
        }
      }

      // Kakao Maps SDK ë¡œë“œ ëŒ€ê¸° ë° ì´ˆê¸°í™”
      function initKakaoMap() {
        if (typeof kakao === 'undefined' || !kakao.maps) {
          console.log('Kakao Maps SDK ë¡œë“œ ëŒ€ê¸° ì¤‘...');
          setTimeout(initKakaoMap, 100);
          return;
        }

        kakao.maps.load(function () {
        var map = new kakao.maps.Map(document.getElementById("map"), {
          center: new kakao.maps.LatLng(37.5665, 126.978),
          level: 5,
        });
        

        let markers = [];
        let myCourse = [];
        let routePolyline = null;
        let currentInfoWindow = null;

        // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ê¸°ëŠ¥
        const courseList = document.getElementById("courseList");
        let draggedElement = null;

        courseList.addEventListener("dragstart", (e) => {
          draggedElement = e.target.closest("li");
          draggedElement?.classList.add("dragging");
        });

        courseList.addEventListener("dragend", (e) => {
          e.target.closest("li")?.classList.remove("dragging");
        });

        courseList.addEventListener("dragover", (e) => {
          e.preventDefault();
          const afterElement = getDragAfterElement(courseList, e.clientY);
          const dragging = document.querySelector(".dragging");
          if (afterElement == null) {
            courseList.appendChild(dragging);
          } else {
            courseList.insertBefore(dragging, afterElement);
          }
        });

        courseList.addEventListener("drop", (e) => {
          e.preventDefault();
          updateCourseOrder();
        });

        function getDragAfterElement(container, y) {
          const draggableElements = [
            ...container.querySelectorAll("li:not(.dragging)"),
          ];
          return draggableElements.reduce(
            (closest, child) => {
              const box = child.getBoundingClientRect();
              const offset = y - box.top - box.height / 2;
              if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
              } else {
                return closest;
              }
            },
            { offset: Number.NEGATIVE_INFINITY }
          ).element;
        }

        function updateCourseOrder() {
          const listItems = courseList.querySelectorAll("li");
          const newOrder = [];
          listItems.forEach((item) => {
            const courseIndex = parseInt(item.dataset.index);
            newOrder.push(myCourse[courseIndex]);
          });
          myCourse = newOrder;
          renderCourseList();
        }

        function renderCourseList() {
          courseList.innerHTML = "";
          myCourse.forEach((place, index) => {
            const li = document.createElement("li");
            li.draggable = true;
            li.dataset.index = index;
            li.innerHTML = `
              <div class="course-item-info">
                <strong>${index + 1}. ${place.name}</strong>
                <small>${
                  place.mediaTitle ? `ğŸ“º ${place.mediaTitle}` : ""
                }</small>
              </div>
              <button class="remove-btn" data-i18n="btn.delete" onclick="removeCourse(${index})">ì‚­ì œ</button>
            `;
            courseList.appendChild(li);
          });
        }

        window.removeCourse = function (index) {
          myCourse.splice(index, 1);
          renderCourseList();
        };

        window.addToCourse = function (name, lat, lng, mediaTitle, placeId) {
          myCourse.push({ name, lat, lng, mediaTitle, placeId });
          renderCourseList();

          if (currentInfoWindow) {
            currentInfoWindow.close();
            currentInfoWindow = null;
          }

          alert(t("alert.added", { name }));
        };

        window.closeInfoWindow = function () {
          if (currentInfoWindow) {
            currentInfoWindow.close();
            currentInfoWindow = null;
          }
        };

        window.deleteCourse = async function (courseId) {
          if (!confirm(t("alert.deleteCourse"))) return;

          try {
            const res = await fetch(`/api/course/${courseId}`, {
              method: "DELETE",
            });
            const data = await res.json();

            if (data.success) {
              alert(t("alert.courseDeleted"));
              // ì½”ìŠ¤ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
              document.getElementById("loadCoursesBtn").click();
            } else {
              alert("Delete failed: " + data.error);
            }
          } catch (err) {
            console.error(err);
            alert(t("alert.saveFailed"));
          }
        };

        // ì¥ì†Œ ê²€ìƒ‰ ê¸°ëŠ¥
        document.getElementById("searchBtn").onclick = async function () {
          const query = document.getElementById("searchInput").value;
          if (!query) return alert(t("alert.enterSearch"));

          try {
            const res = await fetch(
              `/api/search?q=${encodeURIComponent(query)}`
            );
            const data = await res.json();

            markers.forEach((m) => m.setMap(null));
            markers = [];

            if (data.documents.length === 0) {
              alert(t("alert.noResults"));
              return;
            }

            data.documents.forEach((place) => {
              const marker = new kakao.maps.Marker({
                map,
                position: new kakao.maps.LatLng(place.y, place.x),
              });

              const info = new kakao.maps.InfoWindow({
                content: `<div class="custom-info">
                          <div class="info-header">
                            <div class="info-title">
                              <strong>${place.place_name}</strong>
                              <small>${
                                place.media_title ? place.media_title : ""
                              }</small>
                            </div>
                            <button onclick="closeInfoWindow()" class="info-close">âœ•</button>
                          </div>
                          <button onclick='addToCourse("${place.place_name}", ${
                  place.y
                }, ${place.x}, "${place.media_title || ""}", ${
                  place.place_id || "null"
                })' class="info-add-btn" data-i18n="btn.addToCourse">+ ì½”ìŠ¤ ì¶”ê°€</button>
                        </div>`,
              });

              kakao.maps.event.addListener(marker, "click", () => {
                if (currentInfoWindow) {
                  currentInfoWindow.close();
                }

                if (currentInfoWindow === info) {
                  currentInfoWindow = null;
                } else {
                  info.open(map, marker);
                  currentInfoWindow = info;
                }
              });

              markers.push(marker);
            });

            map.setCenter(
              new kakao.maps.LatLng(data.documents[0].y, data.documents[0].x)
            );
          } catch (err) {
            console.error(err);
            alert(t("alert.routeFailed"));
          }
        };

        // ì½˜í…ì¸  ê²€ìƒ‰ ê¸°ëŠ¥
        document.getElementById("searchContentBtn").onclick =
          async function () {
            const contentName = document.getElementById("contentSelect").value;
            if (!contentName) return alert(t("alert.selectContent"));

            try {
              const res = await fetch(
                `/api/search-by-content?name=${encodeURIComponent(contentName)}`
              );
              const data = await res.json();

              markers.forEach((m) => m.setMap(null));
              markers = [];

              if (data.documents.length === 0) {
                alert(t("alert.noLocations"));
                return;
              }

              data.documents.forEach((place) => {
                const marker = new kakao.maps.Marker({
                  map,
                  position: new kakao.maps.LatLng(place.y, place.x),
                });

                const info = new kakao.maps.InfoWindow({
                  content: `<div class="custom-info">
                          <div class="info-header">
                            <div class="info-title">
                              <strong>${place.place_name}</strong>
                              <small>${place.media_title}</small>
                            </div>
                            <button onclick="closeInfoWindow()" class="info-close">âœ•</button>
                          </div>
                          <button onclick='addToCourse("${place.place_name}", ${place.y}, ${place.x}, "${place.media_title}", ${place.place_id})' class="info-add-btn">+ ì½”ìŠ¤ ì¶”ê°€</button>
                        </div>`,
                });

                kakao.maps.event.addListener(marker, "click", () => {
                  if (currentInfoWindow) {
                    currentInfoWindow.close();
                  }

                  if (currentInfoWindow === info) {
                    currentInfoWindow = null;
                  } else {
                    info.open(map, marker);
                    currentInfoWindow = info;
                  }
                });

                markers.push(marker);
              });

              if (data.documents.length > 0) {
                map.setCenter(
                  new kakao.maps.LatLng(
                    data.documents[0].y,
                    data.documents[0].x
                  )
                );
              }
            } catch (err) {
              console.error(err);
              alert(t("alert.routeFailed"));
            }
          };

        // ì—”í„°í‚¤ë¡œ ê²€ìƒ‰
        document
          .getElementById("searchInput")
          .addEventListener("keypress", (e) => {
            if (e.key === "Enter") {
              document.getElementById("searchBtn").click();
            }
          });

        // ì½”ìŠ¤ ì €ì¥
        document.getElementById("saveBtn").onclick = async function () {
          // ë¡œê·¸ì¸ ì²´í¬
          if (!window.currentUser) {
            if (
              confirm("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")
            ) {
              window.location.href = "/auth";
            }
            return;
          }

          if (myCourse.length === 0) return alert(t("alert.addPlaces"));

          const userId = window.currentUser.id; // ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ID ì‚¬ìš©
          const name = prompt(
            t("alert.courseNamePrompt"),
            t("alert.courseNameDefault")
          );
          if (!name) return;

          try {
            const res = await fetch("/api/course", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ userId, name, places: myCourse }),
            });
            const data = await res.json();
            if (data.success) {
              alert(t("alert.courseSaved") + data.courseId);
              myCourse = [];
              renderCourseList();
            } else {
              alert(t("alert.saveFailed"));
            }
          } catch (err) {
            console.error(err);
            alert(t("alert.saveFailed"));
          }
        };

        // ì €ì¥ëœ ì½”ìŠ¤ ë¶ˆëŸ¬ì˜¤ê¸°
        document.getElementById("loadCoursesBtn").onclick = async function () {
          // ë¡œê·¸ì¸ ì²´í¬
          if (!window.currentUser) {
            if (
              confirm("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")
            ) {
              window.location.href = "/auth";
            }
            return;
          }

          const userId = window.currentUser.id; // ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ID ì‚¬ìš©

          try {
            const res = await fetch(`/api/course/${userId}`);
            const courses = await res.json();

            const container = document.getElementById("savedCourses");
            container.innerHTML = "";

            if (courses.length === 0) {
              container.innerHTML = `<p style='text-align:center; color:#999; padding:20px;'>${t(
                "alert.noSavedCourses"
              )}</p>`;
              return;
            }

            courses.forEach((course) => {
              const div = document.createElement("div");
              div.className = "saved-course";
              div.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: start;">
                  <div style="flex: 1;">
                    <strong>ğŸ¯ ${course.name}</strong><br>
                    <small>ğŸ“ ${course.course_places.length}ê°œ ì¥ì†Œ</small>
                  </div>
                  <button onclick="deleteCourse(${course.id})" data-i18n="btn.delete" style="background: #FF4D8D; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; margin-left: 8px;">ì‚­ì œ</button>
                </div>
              `;
              div.onclick = (e) => {
                if (e.target.closest("button")) return; // ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì‹œ ì œì™¸
                loadCourse(course);
              };
              container.appendChild(div);
            });
          } catch (err) {
            console.error(err);
            alert(t("alert.saveFailed"));
          }
        };

        // ì»¤ìŠ¤í…€ ë§ˆì»¤ ìƒì„± í•¨ìˆ˜
        function createCustomMarker(position, label, isStart, isEnd) {
          let bgColor = "#3A8DFF"; // ê¸°ë³¸ íŒŒë€ìƒ‰
          if (isStart) bgColor = "#4CAF50"; // ì¶œë°œ: ì´ˆë¡ìƒ‰
          if (isEnd) bgColor = "#FF4D8D"; // ë„ì°©: ë¶„í™ìƒ‰

          const content = document.createElement("div");
          content.style.cssText = `
            position: relative;
            width: 36px;
            height: 36px;
            background: ${bgColor};
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 3px 8px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 14px;
            cursor: pointer;
            transition: transform 0.2s ease;
          `;

          content.innerHTML = label;
          content.onmouseover = () => (content.style.transform = "scale(1.2)");
          content.onmouseout = () => (content.style.transform = "scale(1)");

          const customOverlay = new kakao.maps.CustomOverlay({
            position: position,
            content: content,
            yAnchor: 0.5,
          });

          return customOverlay;
        }

        function loadCourse(course) {
          markers.forEach((m) => m.setMap(null));
          markers = [];

          if (routePolyline) {
            routePolyline.setMap(null);
            routePolyline = null;
          }

          myCourse = course.course_places
            .sort((a, b) => a.order_index - b.order_index)
            .map((p) => ({
              name: p.place_name,
              lat: p.lat,
              lng: p.lng,
              mediaTitle: p.media_title,
              placeId: p.place_id,
            }));

          renderCourseList();

          myCourse.forEach((place, index) => {
            const isStart = index === 0;
            const isEnd = index === myCourse.length - 1;
            const position = new kakao.maps.LatLng(place.lat, place.lng);

            const customMarker = createCustomMarker(
              position,
              index + 1,
              isStart,
              isEnd
            );
            customMarker.setMap(map);
            markers.push(customMarker);
          });

          if (myCourse.length > 0) {
            map.setCenter(
              new kakao.maps.LatLng(myCourse[0].lat, myCourse[0].lng)
            );
          }

          alert(t("alert.courseLoaded", { name: course.name }));
        }

        // AI ì¶”ì²œë°›ê¸°
        document.getElementById("aiRecommendBtn").onclick = function () {
          window.location.href = "/aiCourse";
        };

        // ê²½ë¡œ ë³´ê¸°
        document.getElementById("showRouteBtn").onclick = async function () {
          if (myCourse.length < 2) {
            return alert(t("alert.minTwoPlaces"));
          }

          // ê¸°ì¡´ ë§ˆì»¤ ì œê±° í›„ ì»¤ìŠ¤í…€ ë§ˆì»¤ë¡œ ì¬ìƒì„±
          markers.forEach((m) => m.setMap(null));
          markers = [];

          if (routePolyline) {
            routePolyline.setMap(null);
          }

          try {
            let totalDistance = 0;
            let totalDuration = 0;
            const pathCoords = [];

            for (let i = 0; i < myCourse.length - 1; i++) {
              const start = myCourse[i];
              const end = myCourse[i + 1];

              const res = await fetch(
                `/api/route?startLng=${start.lng}&startLat=${start.lat}&endLng=${end.lng}&endLat=${end.lat}`
              );
              const data = await res.json();

              console.log("ê²½ë¡œ API ì‘ë‹µ:", data);

              if (data.routes && data.routes.length > 0) {
                const route = data.routes[0];

                // ì‘ë‹µ êµ¬ì¡° í™•ì¸
                if (route.summary) {
                  totalDistance += route.summary.distance || 0;
                  totalDuration += route.summary.duration || 0;
                }

                // ê²½ë¡œ ì¢Œí‘œ ì¶”ì¶œ
                if (route.sections) {
                  route.sections.forEach((section) => {
                    if (section.roads) {
                      section.roads.forEach((road) => {
                        if (road.vertexes) {
                          road.vertexes.forEach((vertex, idx) => {
                            if (idx % 2 === 0) {
                              pathCoords.push(
                                new kakao.maps.LatLng(
                                  road.vertexes[idx + 1],
                                  road.vertexes[idx]
                                )
                              );
                            }
                          });
                        }
                      });
                    }
                  });
                }
              }
            }

            // ì»¤ìŠ¤í…€ ë§ˆì»¤ ìƒì„± (ê²½ë¡œ í‘œì‹œ í›„)
            myCourse.forEach((place, index) => {
              const isStart = index === 0;
              const isEnd = index === myCourse.length - 1;
              const position = new kakao.maps.LatLng(place.lat, place.lng);

              const customMarker = createCustomMarker(
                position,
                index + 1,
                isStart,
                isEnd
              );
              customMarker.setMap(map);
              markers.push(customMarker);
            });

            if (pathCoords.length > 0) {
              routePolyline = new kakao.maps.Polyline({
                path: pathCoords,
                strokeWeight: 5,
                strokeColor: "#FF4D8D",
                strokeOpacity: 0.7,
                strokeStyle: "solid",
              });
              routePolyline.setMap(map);
            }

            document.getElementById("routeInfo").innerHTML = `
              <div class="route-info">
                <strong>ğŸš— ê²½ë¡œ ì •ë³´</strong><br>
                <div style="margin-top: 8px; font-size: 14px;">
                  ğŸ“ ì´ ê±°ë¦¬: <strong>${(totalDistance / 1000).toFixed(
                    1
                  )} km</strong><br>
                  â±ï¸ ì˜ˆìƒ ì‹œê°„: <strong>${Math.round(
                    totalDuration / 60
                  )} ë¶„</strong>
                </div>
              </div>
            `;
          } catch (err) {
            console.error("ê²½ë¡œ ê²€ìƒ‰ ì—ëŸ¬:", err);
            alert(t("alert.routeFailed"));
          }
        };
      });
      }

      // í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ í›„ Kakao Maps ì´ˆê¸°í™”
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initKakaoMap);
      } else {
        initKakaoMap();
      }
    </script>

    <script>
  // --- ìœ í‹¸: ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ê°€ì ¸ì˜¤ê¸°
  function getQS(name, dflt = null) {
    const v = new URLSearchParams(location.search).get(name);
    return v == null ? dflt : v;
  }

  const toNum = v => (v == null ? NaN : Number(v));

  function performTextSearch(keyword) {
    const input =
      document.querySelector('#searchInput') ||             
      document.querySelector('input[placeholder*="ê²€ìƒ‰"]');   
    const btn =
      document.querySelector('#searchBtn') ||              
      Array.from(document.querySelectorAll('button'))
        .find(b => /ê²€ìƒ‰/.test(b.textContent));

    if (input) input.value = keyword || '';
    if (btn) btn.click();
  }

  function addDirectMarker(lat, lng, title) {
    if (isNaN(lat) || isNaN(lng) || !window.kakao || !window.map) return;
    const pos = new kakao.maps.LatLng(lat, lng);
    map.setCenter(pos);
    const marker = new kakao.maps.Marker({ position: pos, title: title || '' });
    marker.setMap(map);
  }

  function initFromQuery() {
    const name = getQS('name', '').trim();
    const lat = toNum(getQS('lat'));
    const lng = toNum(getQS('lng'));

    if (!name && isNaN(lat) && isNaN(lng)) return;

    if (name) performTextSearch(name);

    if (!isNaN(lat) && !isNaN(lng)) addDirectMarker(lat, lng, name);
  }

  document.addEventListener('DOMContentLoaded', initFromQuery);
</script>



  </body>
</html>
