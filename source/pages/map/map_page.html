<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>K-ÏΩòÌÖêÏ∏† ÏßÄÎèÑ</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Pretendard", -apple-system, BlinkMacSystemFont, sans-serif;
        background: linear-gradient(135deg, #f5e6d3 0%, #ffffff 100%);
        min-height: 100vh;
      }

      header {
        background: linear-gradient(135deg, #ff4d8d 0%, #3a8dff 100%);
        color: white;
        padding: 20px 30px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      header h1 {
        font-size: 28px;
        font-weight: 700;
        letter-spacing: -0.5px;
      }

      header p {
        font-size: 14px;
        opacity: 0.9;
        margin-top: 5px;
      }

      .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .home-btn {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 2px solid white;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        font-size: 14px;
        transition: all 0.3s ease;
      }

      .home-btn:hover {
        background: white;
        color: #ff4d8d;
      }

      .container {
        display: flex;
        gap: 20px;
        padding: 20px;
        max-width: 1600px;
        margin: 0 auto;
      }

      .left-panel {
        flex: 1;
        max-width: 420px;
      }

      .map-container {
        flex: 2;
      }

      #map {
        width: 100%;
        height: 700px;
        border-radius: 16px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        overflow: hidden;
      }

      input,
      button,
      select {
        padding: 12px 16px;
        margin: 5px;
        border-radius: 8px;
        border: 2px solid transparent;
        font-size: 14px;
        transition: all 0.3s ease;
      }

      input:focus,
      select:focus {
        outline: none;
        border-color: #3a8dff;
      }

      button {
        cursor: pointer;
        font-weight: 600;
        border: none;
      }

      button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .section {
        background: white;
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 16px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(58, 141, 255, 0.1);
      }

      .section h3 {
        margin-top: 0;
        margin-bottom: 15px;
        color: #1a1a1a;
        font-size: 18px;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .search-section {
        border-top: 3px solid #ff4d8d;
      }

      .course-section {
        border-top: 3px solid #3a8dff;
      }

      .saved-section {
        border-top: 3px solid #f5e6d3;
      }

      .search-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 12px;
      }

      .tab-btn {
        flex: 1;
        padding: 8px 12px;
        background: #f5e6d3;
        color: #1a1a1a;
        border: 2px solid #f5e6d3;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        font-size: 13px;
        transition: all 0.3s ease;
      }

      .tab-btn.active {
        background: #3a8dff;
        color: white;
        border-color: #3a8dff;
      }

      .search-input-group {
        display: flex;
        gap: 5px;
      }

      #searchInput,
      #contentSelect {
        flex: 1;
      }

      #searchBtn {
        background: linear-gradient(135deg, #ff4d8d 0%, #ff6b9d 100%);
        color: white;
        padding: 12px 20px;
      }

      #courseList {
        list-style: none;
        padding: 0;
        min-height: 120px;
        background: #fafafa;
        border: 2px dashed #f5e6d3;
        border-radius: 12px;
        padding: 10px;
      }

      #courseList:empty::before {
        content: "Ïû•ÏÜåÎ•º Ï∂îÍ∞ÄÌï¥Î≥¥ÏÑ∏Ïöî üìç";
        display: block;
        text-align: center;
        color: #999;
        padding: 40px;
      }

      #courseList li {
        padding: 14px 16px;
        margin: 8px 0;
        background: linear-gradient(135deg, #ffffff 0%, #f5f5f5 100%);
        border-radius: 10px;
        cursor: move;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        border-left: 4px solid #3a8dff;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        transition: all 0.3s ease;
      }

      #courseList li:hover {
        transform: translateX(4px);
        box-shadow: 0 4px 12px rgba(58, 141, 255, 0.2);
      }

      #courseList li.dragging {
        opacity: 0.5;
        transform: scale(0.95);
      }

      .course-item-info {
        flex: 1;
      }

      .course-item-info strong {
        display: block;
        color: #1a1a1a;
        margin-bottom: 4px;
      }

      .course-item-info small {
        color: #999;
        font-size: 12px;
      }

      .remove-btn {
        background: #ff4d8d;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 12px;
        font-weight: 600;
        margin-left: 10px;
      }

      .remove-btn:hover {
        background: #ff3377;
      }

      #saveBtn {
        width: 100%;
        background: linear-gradient(135deg, #3a8dff 0%, #5ba3ff 100%);
        color: white;
        border: none;
        padding: 14px;
        font-size: 15px;
        margin: 10px 5px 5px 5px;
      }

      #showRouteBtn {
        width: 100%;
        background: linear-gradient(135deg, #ff4d8d 0%, #ff6b9d 100%);
        color: white;
        border: none;
        padding: 14px;
        font-size: 15px;
        margin: 5px;
      }

      #savedCourses {
        max-height: 300px;
        overflow-y: auto;
      }

      #savedCourses::-webkit-scrollbar {
        width: 8px;
      }

      #savedCourses::-webkit-scrollbar-thumb {
        background: #3a8dff;
        border-radius: 4px;
      }

      #savedCourses::-webkit-scrollbar-track {
        background: #f5e6d3;
        border-radius: 4px;
      }

      .saved-course {
        background: white;
        padding: 14px;
        margin: 8px 0;
        border-radius: 10px;
        cursor: pointer;
        border: 2px solid #f5e6d3;
        transition: all 0.3s ease;
      }

      .saved-course:hover {
        background: linear-gradient(135deg, #ffffff 0%, #f5e6d3 30%);
        border-color: #3a8dff;
        transform: translateX(4px);
        box-shadow: 0 4px 12px rgba(58, 141, 255, 0.15);
      }

      .saved-course strong {
        color: #1a1a1a;
        font-size: 15px;
        display: block;
      }

      .saved-course small {
        color: #666;
        font-size: 13px;
      }

      .route-info {
        background: linear-gradient(135deg, #f5e6d3 0%, #ffffff 100%);
        padding: 16px;
        margin-top: 10px;
        border-radius: 10px;
        border: 2px solid #3a8dff;
        color: #1a1a1a;
      }

      .route-info strong {
        color: #ff4d8d;
        font-size: 16px;
      }

      select {
        background: white;
        border: 2px solid #f5e6d3;
        color: #1a1a1a;
      }

      #loadCoursesBtn {
        background: #3a8dff;
        color: white;
        padding: 12px 16px;
      }

      #loadCoursesBtn:hover {
        background: #2a7dff;
      }

      .custom-info {
        padding: 12px;
        min-width: 200px;
        background: white;
        border-radius: 8px;
      }

      .info-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 8px;
      }

      .info-title {
        flex: 1;
      }

      .info-title strong {
        display: block;
        color: #1a1a1a;
        font-size: 14px;
        margin-bottom: 4px;
      }

      .info-title small {
        color: #3a8dff;
        font-size: 12px;
        font-weight: 600;
      }

      .info-close {
        background: none;
        border: none;
        font-size: 18px;
        cursor: pointer;
        padding: 0 5px;
        color: #999;
      }

      .info-close:hover {
        color: #ff4d8d;
      }

      .info-add-btn {
        width: 100%;
        padding: 8px;
        background: linear-gradient(135deg, #3a8dff 0%, #5ba3ff 100%);
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        font-size: 13px;
        margin-top: 8px;
      }

      @media (max-width: 1024px) {
        .container {
          flex-direction: column;
        }

        .left-panel {
          max-width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <h1>üá∞üá∑ K-ÏΩòÌÖêÏ∏† Ïó¨Ìñâ ÏßÄÎèÑ</h1>
      <p>ÌïúÎ•ò ÏΩòÌÖêÏ∏†ÏôÄ Ìï®ÍªòÌïòÎäî ÌäπÎ≥ÑÌïú Ïó¨Ìñâ ÏΩîÏä§Î•º ÎßåÎì§Ïñ¥Î≥¥ÏÑ∏Ïöî</p>
    </header>

    <div class="container">
      <div class="left-panel">
        <!-- Ïû•ÏÜå Í≤ÄÏÉâ -->
        <div class="section search-section">
          <h3>üîç Í≤ÄÏÉâ</h3>

          <!-- ÌÉ≠ ÏÑ†ÌÉù -->
          <div class="search-tabs">
            <button class="tab-btn active" onclick="switchSearchMode('place')">
              Ïû•ÏÜå Í≤ÄÏÉâ
            </button>
            <button class="tab-btn" onclick="switchSearchMode('content')">
              ÏΩòÌÖêÏ∏† Í≤ÄÏÉâ
            </button>
          </div>

          <!-- Ïû•ÏÜå Í≤ÄÏÉâ Î™®Îìú -->
          <div id="placeSearchMode">
            <div class="search-input-group">
              <input
                type="text"
                id="searchInput"
                placeholder="Ïû•ÏÜåÎ™Ö, Ï£ºÏÜå Í≤ÄÏÉâ..."
              />
              <button id="searchBtn">Í≤ÄÏÉâ</button>
            </div>
          </div>

          <!-- ÏΩòÌÖêÏ∏† Í≤ÄÏÉâ Î™®Îìú -->
          <div id="contentSearchMode" style="display: none">
            <select id="contentSelect">
              <option value="">ÏΩòÌÖêÏ∏† ÏÑ†ÌÉù...</option>
            </select>
            <button
              id="searchContentBtn"
              style="
                width: 100%;
                background: #3a8dff;
                color: white;
                padding: 10px;
                margin-top: 8px;
              "
            >
              Í≤ÄÏÉâ
            </button>
          </div>
        </div>

        <!-- ÌòÑÏû¨ ÏΩîÏä§ -->
        <div class="section course-section">
          <h3>üìç ÎÇòÎßåÏùò Ïó¨Ìñâ ÏΩîÏä§</h3>
          <p style="font-size: 13px; color: #666; margin-bottom: 10px">
            ÎìúÎûòÍ∑∏Î°ú ÏàúÏÑúÎ•º Î≥ÄÍ≤ΩÌï† Ïàò ÏûàÏñ¥Ïöî
          </p>
          <ul id="courseList"></ul>
          <button id="saveBtn">üíæ ÏΩîÏä§ Ï†ÄÏû•ÌïòÍ∏∞</button>
          <button id="showRouteBtn">üöó Í≤ΩÎ°ú ÌôïÏù∏ÌïòÍ∏∞</button>
          <div id="routeInfo"></div>
        </div>

        <!-- Ï†ÄÏû•Îêú ÏΩîÏä§ -->
        <div class="section saved-section">
          <h3>üíé Ï†ÄÏû•Îêú ÏΩîÏä§</h3>
          <select id="userSelect">
            <option value="1">ÏÇ¨Ïö©Ïûê 1</option>
            <option value="2">ÏÇ¨Ïö©Ïûê 2</option>
            <option value="3">ÏÇ¨Ïö©Ïûê 3</option>
          </select>
          <button id="loadCoursesBtn">Î∂àÎü¨Ïò§Í∏∞</button>
          <div id="savedCourses"></div>
        </div>
      </div>

      <div class="map-container">
        <div id="map"></div>
      </div>
    </div>

    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=8d27848d8e0061837441313b57eba277&libraries=services&autoload=false"></script>

    <script>
      let currentSearchMode = "place";
      let contentsData = [];

      // Í≤ÄÏÉâ Î™®Îìú Ï†ÑÌôò
      window.switchSearchMode = function (mode) {
        currentSearchMode = mode;
        document.getElementById("placeSearchMode").style.display =
          mode === "place" ? "block" : "none";
        document.getElementById("contentSearchMode").style.display =
          mode === "content" ? "block" : "none";

        // ÌÉ≠ Î≤ÑÌäº ÌôúÏÑ±Ìôî ÌëúÏãú
        document.querySelectorAll(".tab-btn").forEach((btn, idx) => {
          btn.classList.remove("active");
          if (
            (idx === 0 && mode === "place") ||
            (idx === 1 && mode === "content")
          ) {
            btn.classList.add("active");
          }
        });

        // ÏΩòÌÖêÏ∏† Î™®ÎìúÏùº Îïå ÏΩòÌÖêÏ∏† Î™©Î°ù Î°úÎìú
        if (mode === "content" && contentsData.length === 0) {
          loadContentsList();
        }
      };

      // ÏΩòÌÖêÏ∏† Î™©Î°ù Î°úÎìú
      async function loadContentsList() {
        try {
          const res = await fetch("/api/contents");
          contentsData = await res.json();

          const select = document.getElementById("contentSelect");
          select.innerHTML = '<option value="">ÏΩòÌÖêÏ∏† ÏÑ†ÌÉù...</option>';

          // Ï§ëÎ≥µ Ï†úÍ±∞ (contents Í∏∞Ï§Ä)
          const uniqueContents = [
            ...new Map(
              contentsData.map((item) => [item.contents, item])
            ).values(),
          ];

          uniqueContents.forEach((content) => {
            const option = document.createElement("option");
            option.value = content.contents; // contents ÏÇ¨Ïö©
            option.textContent = `${content.contents}`;
            select.appendChild(option);
          });
        } catch (err) {
          console.error(err);
        }
      }

      kakao.maps.load(function () {
        var map = new kakao.maps.Map(document.getElementById("map"), {
          center: new kakao.maps.LatLng(37.5665, 126.978),
          level: 5,
        });

        let markers = [];
        let myCourse = [];
        let routePolyline = null;
        let currentInfoWindow = null;

        // ÎìúÎûòÍ∑∏ Ïï§ ÎìúÎ°≠ Í∏∞Îä•
        const courseList = document.getElementById("courseList");
        let draggedElement = null;

        courseList.addEventListener("dragstart", (e) => {
          draggedElement = e.target.closest("li");
          draggedElement?.classList.add("dragging");
        });

        courseList.addEventListener("dragend", (e) => {
          e.target.closest("li")?.classList.remove("dragging");
        });

        courseList.addEventListener("dragover", (e) => {
          e.preventDefault();
          const afterElement = getDragAfterElement(courseList, e.clientY);
          const dragging = document.querySelector(".dragging");
          if (afterElement == null) {
            courseList.appendChild(dragging);
          } else {
            courseList.insertBefore(dragging, afterElement);
          }
        });

        courseList.addEventListener("drop", (e) => {
          e.preventDefault();
          updateCourseOrder();
        });

        function getDragAfterElement(container, y) {
          const draggableElements = [
            ...container.querySelectorAll("li:not(.dragging)"),
          ];
          return draggableElements.reduce(
            (closest, child) => {
              const box = child.getBoundingClientRect();
              const offset = y - box.top - box.height / 2;
              if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
              } else {
                return closest;
              }
            },
            { offset: Number.NEGATIVE_INFINITY }
          ).element;
        }

        function updateCourseOrder() {
          const listItems = courseList.querySelectorAll("li");
          const newOrder = [];
          listItems.forEach((item) => {
            const courseIndex = parseInt(item.dataset.index);
            newOrder.push(myCourse[courseIndex]);
          });
          myCourse = newOrder;
          renderCourseList();
        }

        function renderCourseList() {
          courseList.innerHTML = "";
          myCourse.forEach((place, index) => {
            const li = document.createElement("li");
            li.draggable = true;
            li.dataset.index = index;
            li.innerHTML = `
              <div class="course-item-info">
                <strong>${index + 1}. ${place.name}</strong>
                <small>${
                  place.mediaTitle ? `üì∫ ${place.mediaTitle}` : ""
                }</small>
              </div>
              <button class="remove-btn" onclick="removeCourse(${index})">ÏÇ≠Ï†ú</button>
            `;
            courseList.appendChild(li);
          });
        }

        window.removeCourse = function (index) {
          myCourse.splice(index, 1);
          renderCourseList();
        };

        window.addToCourse = function (name, lat, lng, mediaTitle, placeId) {
          myCourse.push({ name, lat, lng, mediaTitle, placeId });
          renderCourseList();

          if (currentInfoWindow) {
            currentInfoWindow.close();
            currentInfoWindow = null;
          }

          alert(`‚ú® ${name}Ïù¥(Í∞Ä) ÏΩîÏä§Ïóê Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§!`);
        };

        window.closeInfoWindow = function () {
          if (currentInfoWindow) {
            currentInfoWindow.close();
            currentInfoWindow = null;
          }
        };

        window.deleteCourse = async function (courseId) {
          if (!confirm("Ïù¥ ÏΩîÏä§Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå? üóëÔ∏è")) return;

          try {
            const res = await fetch(`/api/course/${courseId}`, {
              method: "DELETE",
            });
            const data = await res.json();

            if (data.success) {
              alert("‚úÖ ÏΩîÏä§Í∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§!");
              // ÏΩîÏä§ Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
              document.getElementById("loadCoursesBtn").click();
            } else {
              alert("ÏÇ≠Ï†ú Ïã§Ìå®: " + data.error);
            }
          } catch (err) {
            console.error(err);
            alert("ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§ üò¢");
          }
        };

        // Ïû•ÏÜå Í≤ÄÏÉâ Í∏∞Îä•
        document.getElementById("searchBtn").onclick = async function () {
          const query = document.getElementById("searchInput").value;
          if (!query) return alert("Í≤ÄÏÉâÏñ¥Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî üòä");

          try {
            const res = await fetch(
              `/api/search?q=${encodeURIComponent(query)}`
            );
            const data = await res.json();

            markers.forEach((m) => m.setMap(null));
            markers = [];

            if (data.documents.length === 0) {
              alert("Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§ üò¢");
              return;
            }

            data.documents.forEach((place) => {
              const marker = new kakao.maps.Marker({
                map,
                position: new kakao.maps.LatLng(place.y, place.x),
              });

              const info = new kakao.maps.InfoWindow({
                content: `<div class="custom-info">
                          <div class="info-header">
                            <div class="info-title">
                              <strong>${place.place_name}</strong>
                              <small>${
                                place.media_title ? place.media_title : ""
                              }</small>
                            </div>
                            <button onclick="closeInfoWindow()" class="info-close">‚úï</button>
                          </div>
                          <button onclick='addToCourse("${place.place_name}", ${
                  place.y
                }, ${place.x}, "${place.media_title || ""}", ${
                  place.place_id || "null"
                })' class="info-add-btn">+ ÏΩîÏä§ Ï∂îÍ∞Ä</button>
                        </div>`,
              });

              kakao.maps.event.addListener(marker, "click", () => {
                if (currentInfoWindow) {
                  currentInfoWindow.close();
                }

                if (currentInfoWindow === info) {
                  currentInfoWindow = null;
                } else {
                  info.open(map, marker);
                  currentInfoWindow = info;
                }
              });

              markers.push(marker);
            });

            map.setCenter(
              new kakao.maps.LatLng(data.documents[0].y, data.documents[0].x)
            );
          } catch (err) {
            console.error(err);
            alert("Í≤ÄÏÉâÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§ üò¢");
          }
        };

        // ÏΩòÌÖêÏ∏† Í≤ÄÏÉâ Í∏∞Îä•
        document.getElementById("searchContentBtn").onclick =
          async function () {
            const contentName = document.getElementById("contentSelect").value;
            if (!contentName) return alert("ÏΩòÌÖêÏ∏†Î•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî üòä");

            try {
              const res = await fetch(
                `/api/search-by-content?name=${encodeURIComponent(contentName)}`
              );
              const data = await res.json();

              markers.forEach((m) => m.setMap(null));
              markers = [];

              if (data.documents.length === 0) {
                alert("Ìï¥Îãπ ÏΩòÌÖêÏ∏†Ïùò Ï¥¨ÏòÅÏßÄÍ∞Ä ÏóÜÏäµÎãàÎã§ üò¢");
                return;
              }

              data.documents.forEach((place) => {
                const marker = new kakao.maps.Marker({
                  map,
                  position: new kakao.maps.LatLng(place.y, place.x),
                });

                const info = new kakao.maps.InfoWindow({
                  content: `<div class="custom-info">
                          <div class="info-header">
                            <div class="info-title">
                              <strong>${place.place_name}</strong>
                              <small>${place.media_title}</small>
                            </div>
                            <button onclick="closeInfoWindow()" class="info-close">‚úï</button>
                          </div>
                          <button onclick='addToCourse("${place.place_name}", ${place.y}, ${place.x}, "${place.media_title}", ${place.place_id})' class="info-add-btn">+ ÏΩîÏä§ Ï∂îÍ∞Ä</button>
                        </div>`,
                });

                kakao.maps.event.addListener(marker, "click", () => {
                  if (currentInfoWindow) {
                    currentInfoWindow.close();
                  }

                  if (currentInfoWindow === info) {
                    currentInfoWindow = null;
                  } else {
                    info.open(map, marker);
                    currentInfoWindow = info;
                  }
                });

                markers.push(marker);
              });

              if (data.documents.length > 0) {
                map.setCenter(
                  new kakao.maps.LatLng(
                    data.documents[0].y,
                    data.documents[0].x
                  )
                );
              }
            } catch (err) {
              console.error(err);
              alert("Í≤ÄÏÉâÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§ üò¢");
            }
          };

        // ÏóîÌÑ∞ÌÇ§Î°ú Í≤ÄÏÉâ
        document
          .getElementById("searchInput")
          .addEventListener("keypress", (e) => {
            if (e.key === "Enter") {
              document.getElementById("searchBtn").click();
            }
          });

        // ÏΩîÏä§ Ï†ÄÏû•
        document.getElementById("saveBtn").onclick = async function () {
          if (myCourse.length === 0)
            return alert("ÏΩîÏä§Ïóê Ïû•ÏÜåÎ•º Ï∂îÍ∞ÄÌï¥Ï£ºÏÑ∏Ïöî üìç");
          const userId = document.getElementById("userSelect").value;
          const name = prompt("ÏΩîÏä§ Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî ‚ú®", "ÎÇòÏùò K-Ïó¨Ìñâ ÏΩîÏä§");
          if (!name) return;

          try {
            const res = await fetch("/api/course", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ userId, name, places: myCourse }),
            });
            const data = await res.json();
            if (data.success) {
              alert(`üéâ Ï†ÄÏû• ÏôÑÎ£å!\nÏΩîÏä§ ID: ${data.courseId}`);
              myCourse = [];
              renderCourseList();
            } else {
              alert("Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§ üò¢");
            }
          } catch (err) {
            console.error(err);
            alert("Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§ üò¢");
          }
        };

        // Ï†ÄÏû•Îêú ÏΩîÏä§ Î∂àÎü¨Ïò§Í∏∞
        document.getElementById("loadCoursesBtn").onclick = async function () {
          const userId = document.getElementById("userSelect").value;
          try {
            const res = await fetch(`/api/course/${userId}`);
            const courses = await res.json();

            const container = document.getElementById("savedCourses");
            container.innerHTML = "";

            if (courses.length === 0) {
              container.innerHTML =
                '<p style="text-align:center; color:#999; padding:20px;">Ï†ÄÏû•Îêú ÏΩîÏä§Í∞Ä ÏóÜÏäµÎãàÎã§ üì≠</p>';
              return;
            }

            courses.forEach((course) => {
              const div = document.createElement("div");
              div.className = "saved-course";
              div.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: start;">
                  <div style="flex: 1;">
                    <strong>üéØ ${course.name}</strong><br>
                    <small>üìç ${course.course_places.length}Í∞ú Ïû•ÏÜå</small>
                  </div>
                  <button onclick="deleteCourse(${course.id})" style="background: #FF4D8D; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; margin-left: 8px;">ÏÇ≠Ï†ú</button>
                </div>
              `;
              div.onclick = (e) => {
                if (e.target.closest("button")) return; // ÏÇ≠Ï†ú Î≤ÑÌäº ÌÅ¥Î¶≠ Ïãú Ï†úÏô∏
                loadCourse(course);
              };
              container.appendChild(div);
            });
          } catch (err) {
            console.error(err);
            alert("ÏΩîÏä§ Î∂àÎü¨Ïò§Í∏∞Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§ üò¢");
          }
        };

        function loadCourse(course) {
          markers.forEach((m) => m.setMap(null));
          markers = [];

          if (routePolyline) {
            routePolyline.setMap(null);
            routePolyline = null;
          }

          myCourse = course.course_places
            .sort((a, b) => a.order_index - b.order_index)
            .map((p) => ({
              name: p.place_name,
              lat: p.lat,
              lng: p.lng,
              mediaTitle: p.media_title,
              placeId: p.place_id,
            }));

          renderCourseList();

          myCourse.forEach((place, index) => {
            const marker = new kakao.maps.Marker({
              map,
              position: new kakao.maps.LatLng(place.lat, place.lng),
              title: `${index + 1}. ${place.name}`,
            });
            markers.push(marker);
          });

          if (myCourse.length > 0) {
            map.setCenter(
              new kakao.maps.LatLng(myCourse[0].lat, myCourse[0].lng)
            );
          }

          alert(`‚ú® "${course.name}" ÏΩîÏä§Î•º Î∂àÎü¨ÏôîÏäµÎãàÎã§!`);
        }

        // Í≤ΩÎ°ú Î≥¥Í∏∞
        document.getElementById("showRouteBtn").onclick = async function () {
          if (myCourse.length < 2) {
            return alert("Í≤ΩÎ°úÎ•º Î≥¥Î†§Î©¥ ÏµúÏÜå 2Í∞ú Ïù¥ÏÉÅÏùò Ïû•ÏÜåÍ∞Ä ÌïÑÏöîÌï©ÎãàÎã§ üó∫Ô∏è");
          }

          if (routePolyline) {
            routePolyline.setMap(null);
          }

          try {
            let totalDistance = 0;
            let totalDuration = 0;
            const pathCoords = [];

            for (let i = 0; i < myCourse.length - 1; i++) {
              const start = myCourse[i];
              const end = myCourse[i + 1];

              const res = await fetch(
                `/api/route?startLng=${start.lng}&startLat=${start.lat}&endLng=${end.lng}&endLat=${end.lat}`
              );
              const data = await res.json();

              console.log("Í≤ΩÎ°ú API ÏùëÎãµ:", data);

              if (data.routes && data.routes.length > 0) {
                const route = data.routes[0];

                // ÏùëÎãµ Íµ¨Ï°∞ ÌôïÏù∏
                if (route.summary) {
                  totalDistance += route.summary.distance || 0;
                  totalDuration += route.summary.duration || 0;
                }

                // Í≤ΩÎ°ú Ï¢åÌëú Ï∂îÏ∂ú
                if (route.sections) {
                  route.sections.forEach((section) => {
                    if (section.roads) {
                      section.roads.forEach((road) => {
                        if (road.vertexes) {
                          road.vertexes.forEach((vertex, idx) => {
                            if (idx % 2 === 0) {
                              pathCoords.push(
                                new kakao.maps.LatLng(
                                  road.vertexes[idx + 1],
                                  road.vertexes[idx]
                                )
                              );
                            }
                          });
                        }
                      });
                    }
                  });
                }
              }
            }

            if (pathCoords.length > 0) {
              routePolyline = new kakao.maps.Polyline({
                path: pathCoords,
                strokeWeight: 6,
                strokeColor: "#FF4D8D",
                strokeOpacity: 0.8,
                strokeStyle: "solid",
              });
              routePolyline.setMap(map);
            }

            document.getElementById("routeInfo").innerHTML = `
              <div class="route-info">
                <strong>üöó Í≤ΩÎ°ú Ï†ïÎ≥¥</strong><br>
                <div style="margin-top: 8px; font-size: 14px;">
                  üìè Ï¥ù Í±∞Î¶¨: <strong>${(totalDistance / 1000).toFixed(
                    1
                  )} km</strong><br>
                  ‚è±Ô∏è ÏòàÏÉÅ ÏãúÍ∞Ñ: <strong>${Math.round(
                    totalDuration / 60
                  )} Î∂Ñ</strong>
                </div>
              </div>
            `;
          } catch (err) {
            console.error("Í≤ΩÎ°ú Í≤ÄÏÉâ ÏóêÎü¨:", err);
            alert("Í≤ΩÎ°ú Í≤ÄÏÉâÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§ üò¢");
          }
        };
      });
    </script>
  </body>
</html>
