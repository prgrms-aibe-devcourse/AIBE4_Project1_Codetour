<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>KSpot-ë¦¬ë·° ê´€ë¦¬</title>
    <link rel="stylesheet" href="my-page.css" />
    <link rel="stylesheet" href="/source/pages/index/style.css" />
    <script src="/libs/config.js"></script>
    <script src="/libs/nav-manager.js" type="module"></script>
    <style>
      .image-upload-container {
        position: relative;
        width: 150px;
        height: 150px;
        cursor: pointer;
      }
      .image-preview {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 8px;
        border: 1px solid #ddd;
      }
      .add-image-btn {
        width: 100%;
        height: 100%;
        border: 2px dashed #ddd;
        border-radius: 8px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 40px;
        color: #aaa;
        background-color: #f9f9f9;
      }
      .add-image-btn:hover {
        background-color: #f0f0f0;
        border-color: #ccc;
      }
      .fixed-text {
        padding: 8px 0;
        color: #555;
      }
    </style>
  </head>
  <body>
    <div id="headerPlaceholder"></div>

    <main>
      <div class="page-header">
        <button class="back-btn" onclick="history.back()">â† ë’¤ë¡œê°€ê¸°</button>
        <h1>ë¦¬ë·° ê´€ë¦¬</h1>
        <p class="subtitle">
          ë‚´ê°€ ì‘ì„±í•œ ì—¬í–‰ì§€ ë¦¬ë·°ë¥¼ í™•ì¸í•˜ê³  ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
        </p>
      </div>

      <div class="review-stats">
        <div class="stat-card">
          <div class="stat-number">0</div>
          <div class="stat-label">ì´ ë¦¬ë·°</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">0.0</div>
          <div class="stat-label">í‰ê·  í‰ì </div>
        </div>
      </div>

      <div class="filter-section">
        <div class="filter-group">
          <select class="filter-select">
            <option>ëª¨ë“  ë¦¬ë·°</option>
            <option>ìµœì‹ ìˆœ</option>
            <option>í‰ì  ë†’ì€ìˆœ</option>
            <option>í‰ì  ë‚®ì€ìˆœ</option>
          </select>
        </div>
        <div class="search-box">
          <input type="text" placeholder="ë¦¬ë·° ê²€ìƒ‰..." />
          <span class="search-icon">ğŸ”</span>
        </div>
      </div>

      <div class="review-list">
        <!-- ë™ì ìœ¼ë¡œ ë¦¬ë·° ì¶”ê°€ -->
      </div>
    </main>

    <!-- ë¦¬ë·° ìˆ˜ì • ëª¨ë‹¬ -->
    <div id="edit-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>ë¦¬ë·° ìˆ˜ì •</h2>
          <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <form class="edit-form">
          <div class="form-group">
            <label>ë¦¬ë·° ì‚¬ì§„</label>
            <div id="image-upload-container" class="image-upload-container">
              <!-- ì´ë¯¸ì§€ ë˜ëŠ” + ë²„íŠ¼ ë™ì  ìƒì„± -->
            </div>
            <input
              type="file"
              id="modal-review-image-upload"
              accept="image/*"
              style="display: none"
            />
          </div>

          <div class="form-group">
            <label>ì—¬í–‰ì§€</label>
            <p id="modal-location-name" class="fixed-text"></p>
          </div>

          <div class="form-group">
            <label>í‰ì </label>
            <div class="rating-input" id="modal-rating-input">
              <span class="star" data-rating="1">â­</span>
              <span class="star" data-rating="2">â­</span>
              <span class="star" data-rating="3">â­</span>
              <span class="star" data-rating="4">â­</span>
              <span class="star" data-rating="5">â­</span>
            </div>
          </div>

          <div class="form-group">
            <label>ë¦¬ë·° ë‚´ìš©</label>
            <textarea
              id="modal-review-content"
              rows="6"
              maxlength="300"
              placeholder="ì—¬í–‰ ê²½í—˜ì„ ìì„¸íˆ ì‘ì„±í•´ì£¼ì„¸ìš”..."
            ></textarea>
          </div>

          <div class="form-group">
            <label>íƒœê·¸</label>
            <p id="modal-tags" class="fixed-text"></p>
          </div>

          <div class="modal-actions">
            <button type="button" class="btn-cancel" onclick="closeModal()">
              ì·¨ì†Œ
            </button>
            <button type="submit" class="btn-save">ì €ì¥í•˜ê¸°</button>
          </div>
        </form>
      </div>
    </div>

    <script type="module">
      //const apiURL = "http://localhost:3000";
      import {
        initAuthListener,
        getIsLoggedIn,
        getUserId,
      } from "/libs/user-manager.js";

      let userReviews = []; // í˜ì´ì§€ì˜ ëª¨ë“  ë¦¬ë·°ë¥¼ ì €ì¥í•˜ëŠ” ë³€ìˆ˜

      document.addEventListener("DOMContentLoaded", () => {
        initAuthListener();
        const userId = getUserId();

        if (!userId) {
          alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
          window.location.href = "/auth";
          return;
        }
        fetchReviews();

        const searchInput = document.querySelector(".search-box input");
        const sortSelect = document.querySelector(".filter-select");

        searchInput.addEventListener("input", () => applyFiltersAndSort());
        sortSelect.addEventListener("change", () => applyFiltersAndSort());
      });

      function renderReviews(reviews) {
        const reviewList = document.querySelector(".review-list");
        reviewList.innerHTML = "";

        if (!reviews || reviews.length === 0) {
          reviewList.innerHTML =
            '<p style="text-align: center; padding: 40px;">í•´ë‹¹í•˜ëŠ” ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
          return;
        }

        reviews.forEach((review) => {
          const reviewCard = createReviewCard(review);
          reviewList.appendChild(reviewCard);
        });
      }

      function applyFiltersAndSort() {
        const searchTerm =
          document.querySelector(".search-box input").value.toLowerCase() || "";
        const sortBy = document.querySelector(".filter-select").value;

        // 1. Filter by search term
        let processedReviews = userReviews.filter((review) => {
          const placeName =
            (review.location && review.location.placeName) || "";
          return placeName.toLowerCase().includes(searchTerm);
        });

        // 2. Sort the filtered reviews
        switch (sortBy) {
          case "ìµœì‹ ìˆœ":
            // Per user feedback, this is now oldest-first
            processedReviews.sort(
              (a, b) => new Date(a.created_at) - new Date(b.created_at)
            );
            break;
          case "í‰ì  ë†’ì€ìˆœ":
            processedReviews.sort((a, b) => b.rating - a.rating);
            break;
          case "í‰ì  ë‚®ì€ìˆœ":
            processedReviews.sort((a, b) => a.rating - b.rating);
            break;
          case "ëª¨ë“  ë¦¬ë·°":
          default:
            // The default server order is newest-first.
            processedReviews.sort(
              (a, b) => new Date(b.created_at) - new Date(a.created_at)
            );
            break;
        }

        renderReviews(processedReviews);
      }

      async function fetchReviews() {
        const userId = getUserId();

        try {
          const response = await fetch(`${API_BASE_URL}/api/reviews/${userId}`);
          if (!response.ok) {
            throw new Error("Failed to fetch reviews");
          }
          userReviews = await response.json(); // ë¦¬ë·° ë°ì´í„°ë¥¼ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥

          const totalReviews = userReviews.length;
          const averageRating =
            totalReviews > 0
              ? userReviews.reduce((acc, r) => acc + r.rating, 0) / totalReviews
              : 0;
          updateStats(totalReviews, averageRating);

          // Initial render
          applyFiltersAndSort();
        } catch (error) {
          console.error("Error fetching reviews:", error);
          const reviewList = document.querySelector(".review-list");
          reviewList.innerHTML =
            '<p style="text-align: center; padding: 40px;">ë¦¬ë·°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
        }
      }

      function updateStats(total, avg) {
        const totalEl = document.querySelector(
          ".review-stats .stat-card:nth-child(1) .stat-number"
        );
        const avgEl = document.querySelector(
          ".review-stats .stat-card:nth-child(2) .stat-number"
        );
        if (totalEl) totalEl.textContent = total;
        if (avgEl) avgEl.textContent = avg.toFixed(1);
      }

      function createReviewCard(review) {
        const div = document.createElement("div");
        div.className = "review-card";

        const locationName = review.location
          ? review.location.placeName
          : "ì•Œ ìˆ˜ ì—†ëŠ” ì¥ì†Œ";
        const locationAddress = review.location
          ? review.location.address
          : "ì£¼ì†Œ ì •ë³´ ì—†ìŒ";

        const createStars = (rating) => {
          let stars = "";
          const fullStars = Math.floor(rating);
          for (let i = 0; i < 5; i++) {
            stars += i < fullStars ? "â­" : "â˜†";
          }
          return stars;
        };

        div.innerHTML = `
          <div class="review-image">
            <img src="${
              review.review_image ||
              "https://via.placeholder.com/400x300.png?text=No+Image"
            }" alt="${locationName}" />
          </div>
          <div class="review-content">
            <div class="review-header">
              <div class="review-title-section">
                <h3>${locationName}</h3>
                <span class="review-location">ğŸ“ ${locationAddress}</span>
              </div>
              <div class="review-rating">
                <span class="stars">${createStars(review.rating)}</span>
                <span class="rating-number">${review.rating.toFixed(1)}</span>
              </div>
            </div>
            <p class="review-text">${review.comment || ""}</p>
            <div class="review-actions">
              <button class="btn-edit" onclick="editReview('${
                review.id
              }')">ìˆ˜ì •</button>
              <button class="btn-delete" onclick="deleteReview('${
                review.id
              }')">ì‚­ì œ</button>
            </div>
          </div>
        `;
        return div;
      }

      function editReview(reviewId) {
        const review = userReviews.find((r) => r.id === reviewId);
        if (!review) {
          alert("ë¦¬ë·°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        document.querySelector(".edit-form").dataset.reviewId = reviewId;

        const imageContainer = document.getElementById(
          "image-upload-container"
        );
        const fileInput = document.getElementById("modal-review-image-upload");

        const renderImage = (src) => {
          if (src) {
            imageContainer.innerHTML = `<img src="${src}" alt="ë¦¬ë·° ì‚¬ì§„" class="image-preview" />`;
          } else {
            imageContainer.innerHTML = '<div class="add-image-btn">+</div>';
          }
        };

        renderImage(review.review_image);

        imageContainer.onclick = () => fileInput.click();

        fileInput.onchange = (event) => {
          const file = event.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = (e) => renderImage(e.target.result);
            reader.readAsDataURL(file);
          }
        };

        document.getElementById("modal-location-name").textContent =
          review.location ? review.location.placeName : "ì•Œ ìˆ˜ ì—†ëŠ” ì¥ì†Œ";
        document.getElementById("modal-review-content").value =
          review.comment || "";
        document.getElementById("modal-tags").textContent = review.location
          ? review.location.keyword
          : "";

        const ratingInput = document.getElementById("modal-rating-input");
        const stars = ratingInput.querySelectorAll(".star");
        stars.forEach((star) => {
          const starRating = parseInt(star.getAttribute("data-rating"));
          star.classList.toggle("active", starRating <= review.rating);
        });

        document.getElementById("edit-modal").style.display = "flex";
      }

      function closeModal() {
        document.getElementById("edit-modal").style.display = "none";
      }

      async function deleteReview(id) {
        if (confirm("ì •ë§ë¡œ ì´ ë¦¬ë·°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
          try {
            const response = await fetch(`${API_BASE_URL}/api/reviews/${id}`, {
              method: "DELETE",
            });

            if (!response.ok) {
              const errorData = await response.json();
              throw new Error(errorData.error || "Unknown server error");
            }

            alert("ë¦¬ë·°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
            fetchReviews(); // Refresh reviews
          } catch (error) {
            console.error("Error deleting review:", error);
            alert(`ë¦¬ë·° ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}`);
          }
        }
      }

      document.querySelectorAll(".star").forEach((star) => {
        star.addEventListener("click", function () {
          const rating = this.getAttribute("data-rating");
          const parent = this.parentElement;
          parent.querySelectorAll(".star").forEach((s) => {
            s.classList.remove("active");
          });
          for (let i = 1; i <= rating; i++) {
            parent
              .querySelector(`.star[data-rating="${i}"]`)
              .classList.add("active");
          }
        });
      });

      window.onclick = function (event) {
        const modal = document.getElementById("edit-modal");
        if (event.target === modal) {
          closeModal();
        }
      };

      document
        .querySelector(".edit-form")
        .addEventListener("submit", async function (e) {
          e.preventDefault();
          const form = e.target;
          const reviewId = form.dataset.reviewId;

          if (!reviewId) {
            alert("ë¦¬ë·° IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
          }

          const rating = form.querySelectorAll(
            "#modal-rating-input .star.active"
          ).length;
          const comment = document.getElementById("modal-review-content").value;
          const imagePreview = document.querySelector(
            "#image-upload-container .image-preview"
          );
          const review_image = imagePreview ? imagePreview.src : null;

          const updatedReview = {
            rating,
            comment,
            review_image,
          };

          try {
            const response = await fetch(
              `${API_BASE_URL}/api/reviews/${reviewId}`,
              {
                method: "PUT",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify(updatedReview),
              }
            );

            if (!response.ok) {
              const errorData = await response.json();
              throw new Error(errorData.error || "Unknown server error");
            }

            alert("ë¦¬ë·°ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!");
            closeModal();
            fetchReviews(); // Refresh reviews
          } catch (error) {
            console.error("Error updating review:", error);
            alert(`ë¦¬ë·° ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}`);
          }
        });
    </script>
  </body>
</html>
