<button id="aiBtn">AI일정 추천받기</button>
<div id="tabs" class="tabs"></div>
<div id="panes"></div>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
  const sb = createClient(
    "https://fmcxkqfccuevcaqkzsex.supabase.co",
    "eyJhbGciOi..."
  ); // anon

  const { data, error } = await sb.functions.invoke("ai-itinerary", {
    body: { city: "서울", days: 3, limitPerDay: 6 },
  });
  console.log(data ?? error);

  async function fetchPlan({ city, days, budgetKRW }) {
    const url =
      "https://fmcxkqfccuevcaqkzsex.functions.supabase.co/ai-itinerary";
    const res = await fetch(url, {
      method: "POST",
      headers: {
        Authorization: "Bearer YOUR_SUPABASE_ANON_KEY", // 401 방지
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        city,
        days,
        budgetKRW,
        limitPerDay: 6,
        dailyHours: 8,
        transport: ["지하철", "버스"],
      }),
    });
    if (!res.ok) throw new Error(await res.text());
    return await res.json();
  }

  function render(plan) {
    const tabs = document.getElementById("tabs");
    const panes = document.getElementById("panes");
    tabs.innerHTML = "";
    panes.innerHTML = "";

    plan.days.forEach((d, i) => {
      const t = document.createElement("button");
      t.className = "tab" + (i ? "" : " active");
      t.dataset.day = d.day;
      t.textContent = `Day ${d.day}`;
      tabs.appendChild(t);

      const s = document.createElement("section");
      s.className = "pane" + (i ? "" : " active");
      s.dataset.day = d.day;

      d.items.forEach((it, idx) => {
        s.innerHTML += `
          <div class="item">
            <div class="num">${idx + 1}</div>
            <div class="thumb">${(it.category || "?")[0]}</div>
            <div class="content">
              <div class="title">${it.name}</div>
              <div class="meta">${it.category || "명소"} · <span class="addr">${
          it.address || ""
        }</span></div>
              <div class="rec">${it.description || ""}</div>
              <div class="meta">⏱ ${it.startTime ?? ""}~${
          it.endTime ?? ""
        } (${Math.round(it.durationMin)}분) · ₩${(
          it.estCostKRW || 0
        ).toLocaleString()}</div>
            </div>
          </div>`;
      });

      panes.appendChild(s);
    });

    // 탭 전환
    document.querySelectorAll(".tab").forEach((t) => {
      t.addEventListener("click", () => {
        document
          .querySelectorAll(".tab")
          .forEach((b) => b.classList.remove("active"));
        document
          .querySelectorAll(".pane")
          .forEach((p) => p.classList.remove("active"));
        t.classList.add("active");
        document
          .querySelector(`.pane[data-day="${t.dataset.day}"]`)
          .classList.add("active");
      });
    });
  }

  document.getElementById("aiBtn").addEventListener("click", async () => {
    try {
      const plan = await fetchPlan({
        city: "서울",
        days: 5,
        budgetKRW: 300000,
      });
      render(plan);
    } catch (e) {
      alert("일정 생성 실패: " + e.message);
    }
  });
</script>
